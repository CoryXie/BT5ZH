# 蓝牙5规范第1卷A部分第2章核心系统架构

标签（空格分隔）： Bluetooth

---

# 2 核心系统架构

蓝牙核心系统由主机，主控制器和零个或多个辅助控制器组成。 蓝牙BR / EDR核心系统的最小实现涵盖由蓝牙规范定义的四个最低层和相关协议以及一个公共服务层协议（common service layer protocol）; 服务发现协议（Service Discovery Protocol，SDP）和总体配置文件要求（overall profile requirements）在通用访问配置文件（Generic Access Profile，GAP）中指定。 BR / EDR核心系统包括支持备用MAC / PHY（AMP），包括支持外部参考MAC / PHY的AMP管理器协议（AMP Manager Protocol）和协议适配层（Protocol Adaptation Layers，PAL）。 蓝牙LE唯一核心系统的最小实现涵盖由蓝牙规范定义的四个最低层和相关协议以及两个常用服务层协议; 安全管理器（Security Manager，SM）和属性协议（Attribute Protocol，ATT）以及总体配置文件要求在通用属性配置文件（Generic Attribute Profile，GATT）和通用访问配置文件（Generic Access Profile，GAP）中指定。 结合蓝牙BR / EDR和LE的实现包括上述最小实现。

完整的蓝牙应用需要在蓝牙规范中定义的许多附加服务和更高层协议，但这里不再赘述。 核心系统架构如图2.1所示。

![图2.1：蓝牙核心系统架构](http://upload-images.jianshu.io/upload_images/3764796-7de484c83b1373d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

图2.1 显示了核心块，每个都具有相关的通信协议。 链路管理器，链路控制器和BR / EDR无线电块包括BR / EDR控制器。 AMP PAL，AMP MAC和AMP PHY包括AMP控制器。 链路管理器，链路控制器和LE无线电块包括LE控制器。 L2CAP，SDP和GAP块包括BR / EDR主机。 L2CAP，SMP，属性协议，GAP和通用属性配置文件（GATT）块包括LE主机。 BR / EDR / LE主机组合来自每个主机的一组块。这是涉及标准的常见实现控制器和主机之间的物理通信接口。 虽然这个接口是可选的，但架构是为了保证其存在和特性而设计的。 蓝牙规范通过定义在等效层之间交换的协议消息以及独立蓝牙子系统之间的互操作性，通过定义蓝牙控制器和蓝牙主机之间的通用接口，实现独立蓝牙系统之间的互操作性。

显示了一些功能块和它们之间的服务和数据路径。 图中所示的功能块信息丰富; 通常，蓝牙规范没有定义实现的细节，除非这是互操作性所需的。 因此，显示了图2.1中的功能块，以帮助描述系统行为。 实现可能与图2.1所示的系统不同。

标准交互是针对所有设备间操作进行定义的，蓝牙设备根据蓝牙规范交换协议信令。 蓝牙核心系统协议是无线电（PHY）协议，链路控制（LC）和链路管理器（LM）协议或链路层（LL）协议，AMP PAL，逻辑链路控制和适配协议（L2CAP）以及AMP管理器协议所有这些都在蓝牙规范的后续部分中完全定义。 此外，服务发现协议（SDP）和属性协议（ATT）是某些蓝牙应用可能需要的服务层协议。

蓝牙核心系统通过许多服务接入点提供服务，如图中所示的服务接入点为椭圆。 这些服务由控制蓝牙核心系统的基本原语组成。 这些服务可以分为三种类型。 有设备控制服务修改蓝牙设备的行为和模式，创建，修改和发布流量承载（渠道和链路）的传输控制服务，以及用于提交数据以在流量承载上传输的数据服务。 通常将前两个视为属于C平面，最后属于U平面。

定义蓝牙控制器子系统的服务接口，使得主控制器可以被认为是标准部件。 在这种配置中，蓝牙控制器操作最低的四层。 蓝牙主机操作L2CAP层和其他较高层。 标准接口称为主机控制器接口（HCI），其服务接入点由图2.1中蓝牙控制器子系统上边缘的椭圆表示。 此标准服务接口的实现是可选的。

由于蓝牙架构被定义为具有通过一个或多个HCI传输进行通信的单独的主机和控制器的可能性，所以进行了许多一般的假设。 与主机相比，蓝牙控制器被认为具有有限的数据缓冲功能。

因此，当将L2CAP PDU提交给控制器以传输到对等设备时，期望L2CAP层执行一些简单的资源管理。 这包括将L2CAP SDU分段为更易于管理的PDU，然后将PDU分段成适合于Controller缓冲区的大小的启动和继续分组，以及管理使用Controller缓冲区以确保具有服务质量（QoS）承诺。

BR / EDR基带，LE链路层和AMP MAC层在蓝牙中提供基本的确认/重复请求（ARQ）协议。 L2CAP层可以可选地向L2CAP PDU提供进一步的错误检测和重传。 对于具有用户数据中未检测到错误概率较低的要求的应用，建议使用此功能。 L2CAP的另一个可选特征是基于窗口的流控制，可用于管理接收设备中的缓冲区分配。 这两个可选功能在某些情况下增加了QoS性能。 使用LE系统时，并非所有的L2CAP功能都可用。

虽然这些假设并不总是需要组合单个系统中所有层的嵌入式蓝牙实现，但是通常的架构和QoS模型是根据这些假设定义的，实际上是最低的公分母。

需要对蓝牙核心系统的实现进行自动一致性测试。 这是通过允许测试人员通过PHY接口控制实现，以及测试接口，如直接测试模式（DTM），通用测试方法（GTM），测试控制接口（TCI）以及通过HCI测试命令和事件来实现的仅用于一致性测试。

测试者通过​​PHY接口与被测实施（IUT）进行交互，以确保对来自远程设备的请求的正确响应。 测试员通过HCI，DTM，GTM或TCI来控制IUT，以使IUT通过PHY接口发起交换机，这样也可以被验证为符合要求。

TCI使用不同的命令集（服务接口）来测试每个架构层和协议。 HCI命令集的子集用作BR / EDR控制器子系统中每个层和协议的TCI服务接口。 单独的服务接口用于测试L2CAP层和协议。 由于在蓝牙核心规范中未定义L2CAP服务接口，所以在测试控制接口规范中单独定义。 L2CAP服务接口的实现只适用于一致性测试。

## 2.1 核心建筑块

本节介绍图2.1所示的各个功能块的功能和责任。 尽管每个实现都应符合蓝牙规范的后续部分中描述的协议规范，但实现不需要遵循上述架构，并且将实现下面概述的系统的行为方面，并在蓝牙规范的后续部分中规定。

### 2.1.1 主机结构块

#### 2.1.1.1 频道经理

频道管理员负责创建，管理和关闭L2CAP频道，用于传输服务协议和应用数据流。 信道管理器使用L2CAP协议与远程（对等）设备上的信道管理器进行交互，以创建这些L2CAP信道并将其端点连接到适当的实体。 频道管理器与其本地链路管理器或AMP PAL进行交互，以创建新的逻辑链路（如果需要），并配置这些链路以为正在传输的数据类型提供所需的服务质量。

#### 2.1.1.2 L2CAP资源管理器

L2CAP资源管理器模块负责管理到基带的PDU片段提交的顺序以及信道之间的一些相对调度，以确保具有QoS承诺的L2CAP信道由于控制器资源耗尽而不被拒绝访问物理信道。 这是必需的，因为架构模型不假定控制器具有无限缓冲，或者HCI是无限带宽的管道。

L2CAP资源管理器还可以执行流量一致性监管，以确保应用程序在其协商的QoS设置的范围内提交L2CAP SDU。 一般的蓝牙数据传输模型假定运行良好的应用程序，并没有定义实现如何处理这个问题。

#### 2.1.1.3 安全管理器协议

安全管理协议（SMP）是用于生成加密密钥和身份密钥的对等协议。 该协议通过专用的固定L2CAP通道进行操作。 SMP块还管理加密密钥和身份密钥的存储，并负责生成随机地址并将随机地址解析为已知设备标识。 SMP块直接与控制器接口，以在加密或配对过程中提供用于加密和认证的存储密钥。

该块仅用于LE系统。 BR / EDR系统中的类似功能包含在Controller中的Link Manager块中。 SMP功能在LE系统中的主机中，以降低仅LE控制器的实施成本。

#### 2.1.1.4 属性协议

属性协议（ATT）块实现属性服务器和属性客户端之间的对等协议。 ATT客户端通过专用固定L2CAP通道与远程设备上的ATT服务器进行通信。 ATT客户端向ATT服务器发送命令，请求和确认。 ATT服务器向客户端发送响应，通知和指示。 这些ATT客户机命令和请求提供了使用ATT服务器在对等设备上读取和写入属性值的方法。

#### 2.1.1.5 AMP管理器协议

AMP管理器是使用L2CAP与远程设备上的对等AMP管理器通信的层。 它还直接与AMP PAL接口进行AMP控制。 AMP经理负责发现远程AMP并确定其可用性。 它还收集有关远程AMP的信息。 此信息用于设置和管理AMP物理链路。 AMP管理器使用专用的L2CAP信令通道与远程AMP管理器进行通信。

#### 2.1.1.6 通用属性配置文件

通用属性配置文件（GATT）块表示属性服务器和可选的属性客户端的功能。 该配置文件描述了属性服务器中使用的服务，特性和属性的层次结构。 该块提供用于发现，读取，写入和指示服务特征和属性的接口。 GATT用于LE配置文件服务发现的LE设备。

#### 2.1.1.7 通用访问配置文件

通用访问配置文件（GAP）块表示所有蓝牙设备通用的基本功能，例如传输，协议和应用程序配置文件使用的模式和访问过程。 GAP服务包括设备发现，连接模式，安全性，认证，关联模型和服务发现。

### 2.1.2 BR / EDR / LE控制器结构块

在组合BR / EDR和LE系统的实现中，架构块可以在系统之间共享，或者每个系统可以具有它们自己的块的实例化。

#### 2.1.2.1 装置经理

设备管理器是基带中的功能块，用于控制蓝牙设备的一般行为。 它负责与数据传输不直接相关的蓝牙系统的所有操作，例如询问是否存在附近的蓝牙设备，连接到蓝牙设备，或使本地蓝牙设备可被其他设备可发现或连接。

设备管理器请求从基带资源控制器访问传输介质以执行其功能。

设备管理器还控制许多HCI命令所暗示的本地设备行为，例如管理设备本地名称，任何存储的链接密钥以及其他功能。

#### 2.1.2.2 链接管理器

链路管理器负责逻辑链路的创建，修改和发布（如果需要，它们的相关联的逻辑传输）以及与设备之间的物理链路相关的参数的更新。 链路管理器通过使用BR / EDR中的链路管理器协议（LMP）和LE中的链路层协议（LL）与远程蓝牙设备中的链路管理器进行通信来实现此目的。

LM或LL协议允许在需要时在设备之间创建新的逻辑链路和逻辑传输，以及链路和传输属性的一般控制，例如在逻辑传输上启用加密，在BR /物理链路上的EDR或用于逻辑链路的BR / EDR中的QoS设置的调整。

#### 2.1.2.3 基带资源管理器

基带资源管理器负责对无线电介质的所有访问。 它有两个主要功能。 它的核心是一个调度程序，为所有已经协商访问合同的实体提供物理信道的时间。 另一个主要功能是与这些实体协商访问合同。 访问合同实际上是承诺提供一定的QoS，以便向用户应用程序提供预期的性能。

访问合同和调度功能必须考虑到需要使用主控制器的任何行为。 这包括（例如）通过逻辑链路连接的设备之间的数据的正常交换以及逻辑传输，以及使用无线电介质进行查询，连接，被发现或可连接，或者从未使用的数据中读取数据载波在使用自适应跳频模式时。

在某些情况下，在BR / EDR系统中，逻辑链路的调度导致将逻辑链路更改为与先前使用的逻辑链路不同的物理信道。 这可能是（例如）由于参与分布式互联网，定期查询功能或页面扫描。 当物理信道不是时隙对齐时，资源管理器还考虑了原始物理信道上的时隙与新物理信道上的时隙之间的重新调整时间。 在某些情况下，由于将相同的器件时钟用作两个物理通道的参考，时隙将自然对准。

#### 2.1.2.4 链路控制器

链路控制器负责从数据有效载荷和与物理信道，逻辑传输和逻辑链路相关的参数对蓝牙分组进行编码和解码。

链路控制器执行BR / EDR中的链路控制协议信令和LE中的链路层协议（与资源管理器的调度功能紧密结合），用于通信流量控制和确认和重传请求信号。 这些信号的解释是与基带分组相关联的逻辑传输的特征。 链路控制信令的解释和控制通常与资源管理器的调度器相关联。

#### 2.1.2.5 PHY

PHY块负责在物理信道上发送和接收信息包。 基带和PHY块之间的控制路径允许基带块控制PHY块的定时和频率载波。 PHY块将物理信道和基带的数据流转换为所需格式。

### 2.1.3 AMP控制器结构块

#### 2.1.3.1 AMP HCI

AMP HCI是AMP控制器和主机（L2CAP和AMP管理器）之间的逻辑接口。 当主机和AMP控制器物理分离时，HCI是可选的层。 对AMP的支持需要额外的HCI命令和事件。 这些新的命令和事件与AMP物理和逻辑链路管理，QoS以及流量控制有关。

每个AMP控制器有一个HCI的逻辑实例，另一个用于BR / EDR控制器的逻辑实例。 在单个物理单元中存在多个控制器的情况下，物理HCI传输层通过相同的物理传输总线管理多个控制器的复用。

#### 2.1.3.2 AMP PAL

AMP PAL是将AMP MAC与主机（L2CAP和AMP管理器）连接的AMP层。 它将命令从主机转换为特定的MAC服务原语和原语为命令，并将原语从AMP MAC转换为主机的可理解事件。 AMP PAL支持AMP通道管理，根据指定流量规格的数据流量和功率效率。

AMP PAL不需要独家访问AMP本身。 实施者可以选择允许其他协议是AMP的并发客户端。 允许其他协议共享对AMP的访问的具体机制不属于本规范的范围。

通用PAL架构如图2.2所示。

![图2.2：通用PAL架构](http://upload-images.jianshu.io/upload_images/3764796-56490b1c7ce1ea6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

通过AMP管理器协议通过AMP_Info和AMP_Assoc结构交换PAL和底层MAC / PHY的能力。 AMP_Info包含PAL的通用功能，例如带宽可用性，最大PDU大小，PAL功能，AMP_Assoc和flush超时信息的长度。 AMP_Assoc的内容取决于PAL，并且与底层MAC / PHY有关。

#### 2.1.3.3 AMP MAC

AMP MAC是IEEE 802参考层模型中定义的MAC层。 它提供诸如寻址和机制等服务来控制和访问频道。 AMP MAC位于AMP PHY和AMP PAL层之间。

#### 2.1.3.4 AMP PHY

AMP PHY是AMP物理层。




