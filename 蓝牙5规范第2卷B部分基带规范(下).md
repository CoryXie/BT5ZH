

＃7位流处理

蓝牙设备应使用以下部分中定义的比特流处理方案。

在有效载荷通过空中接口发送之前，在发射机中执行几个比特的操作，以提高可靠性和安全性。在分组报头中加入HEC，用白化字加密报头比特，应用FEC编码。在接收机中，进行反向处理。图7.1显示了在发送端和接收端对分组报头进行的处理。所有标头位处理都是必须的，除了不对同步列表数据包执行白化和去白化。在图7.1中，不对所有数据包类型执行的进程由虚拟块指示。

图7.1：标题位处理

图7.2显示了可以在有效载荷上执行的过程。除了为分组报头定义的进程之外，可以对有效载荷应用加密。如第7.2节所述，美白和去白化对于除了同步列车有效载荷之外的每个有效载荷都是强制性的，在那里它们被禁止。所有其他进程都是可选的，并且取决于数据包类型（请参见第6.6节）以及是否启用加密。在图7.2中，可选的进程用虚线框表示。当使用E0加密时，整个有效载荷将被加密。当使用AES-CCM加密时，只有有效载荷体和MIC被加密;有效载荷头和CRC不得加密。

图7.2：有效载荷位处理

## 7.1错误检查

可以使用信道接入码，报头中的HEC和有效负载中的CRC来检查分组的错误或错误的传送。在分组接收时，首先检查接入码。由于通道访问码中的64位同步字是从24位主LAP导出的，所以检查LAP是否正确，并且防止接收者接受另一个微微网的数据包（提供了主机的BD_ADDR的LAP字段是不同的）。

HEC和CRC计算初始化如下：

- 在询问响应子状态中，DCI值应用于FHS和扩展查询响应数据包。
- 在主页响应子状态中，从站的UAP应用于FHS数据包。
- 在连接状态下，使用主机的UAP。即使两个微微网的访问代码可能相同，不同的UAP值通常会导致HEC和CRC失败。
- 在从TDD切换开始的角色切换期间，新从站的UAP应用于FHS分组。

HEC和CRC的生成和检查总结在图7.5和图7.8中。在计算HEC或CRC之前，HEC / CRC发生器中的移位寄存器应使用8位UAP（或DCI）值进行初始化。
那么报头和有效载荷信息将分别移入HEC和CRC生成器（以LSB为先）。

如果访问代码对于微微网是正确的并且HEC具有正确的值，则分组具有有效的头部，而与其他头部字段的值无关。

### 7.1.1 HEC生成

生成LFSR的HEC如图7.3所示。生成多项式为：

最初，该电路应预先加载8位UAP，使得UAP（表示为UAP0）的LSB到达最左边的移位寄存器元件，并且UAP7转到最右边的元件。HEC LFSR的初始状态如图7.4所示。然后将数据置于置于位置1的开关S上。当最后一个数据位被计时到LFSR时，开关S应置于位置2，HEC可从寄存器中读出。从右到左读取LFSR位（即，位置7中的位是第一个被发送，后面是位置6的位等）。


图7.3：生成HEC的LFSR电路

图7.4：HEC发生电路的初始状态

图7.5：HEC生成和检查

### 7.1.2 CRC生成

用于CRC的16位LFSR的构造类似于HEC，使用CRC-

CCITT生成多项式g（D）= D16 + D12 + D5 + 1

（即210041以八进制表示）（见图7.6）。对于这种情况，最左边8位的最初位将最初加载8位UAP（左侧为UAP0，右侧为UAP7），而最右侧8位将被复位为零。16位LFSR的初始状态如图7.7所示。当数据移入时，开关S应置于位置1。最后一位进入LFSR后，开关应置于位置2，寄存器的内容从右到左传输（即从位置15开始，位置14等）。

图7.6：产生CRC的LFSR电路

图7.7：CRC生成电路的初始状态

图7.8：CRC生成和检查

7.2数据白名

同步列车数据包不得用数据白化字加扰。在传输所有其他分组之前，头部和有效载荷都必须用数据白化字进行加扰，以使数据从高冗​​余模式中随机化，并最小化数据包中的直流偏差。扰码应在FEC编码之前进行。

在接收机处，加扰数据包的接收数据应使用接收者中生成的相同的白化字进行解扰。FEC解码后进行解扰。

用多项式g（D）= D7 + D4 + 1生成白化字

（即，以八进制形式表示的221），然后随后与标题和有效载荷进行异或。白化字是用图7.9所示的线性反馈移位寄存器产生的。在每个传输之前，移位寄存器应用主蓝牙时钟CLK6-1的一部分进行初始化，CLK6-1以值为1的MSB进行扩展。该初始化应用写入0位的CLK1，写入位置1的CLK2进行初始化。例外是在查询响应或页面响应期间发送的FHS数据包，以及查询响应期间发送的扩展查询响应数据包，其中初始化白化登记册的执行方式不同。代替主时钟，应使用在查询或页面响应中使用的X输入（取决于当前状态）例程，请参见表2.2。5位值应扩展为两个值为1的MSB。在寄存器初始化期间，X（即X0）的LSB应写入位置0，X1写入位置1等。


图7.9：数据增白LFSR

初始化后，数据包头和有效载荷（包括CRC）变白。有机白化将继续从美白LFSR在HEC结束时的状态。数据包头和有效载荷之间的移位寄存器不得重新初始化。“数据输入”序列的第一位应为数据包报头的LSB。

对于增强数据速率数据包，增白数据不应用于增强数据速率数据包的保护，同步和尾部。
在不应用美白的期间，LFSR应暂停。

## 7.3错误修正

为蓝牙定义了三种纠错方案：

- 1/3速率FEC
- 2/3速率FEC
- 数据的ARQ方案

FEC方案对数据有效载荷的目的是减少重发次数。然而，在合理的无差错环境中，FEC会产生不必要的开销，从而降低吞吐量。因此，第6节中给出的数据包定义在有效载荷中保持灵活使用FEC，导致ACL逻辑传输的DM和DH数据包，SCO逻辑传输的HV数据包和eSCO逻辑的EV数据包运输。分组报头总是受1/3速率FEC保护，因为它包含有价值的链路信息，并被设计为承受更多的位错误。

本部分不包括用于屏蔽语音解码器错误的纠正措施。这个问题在9.3节中讨论。

## 7.4 FEC CODE：RATE 1/3

头部使用简单的3次重复FEC码。重复代码通过重复每个位三次来实现，参见图7.10中的图示。3次重复码用于整个报头，以及HV1报文中的同步数据字段。

图7.10：位重复编码方案

## 7.5 FEC CODE：RATE 2/3

另一种FEC方案是（15,10）缩短的汉明码。发电机
多项式为g（D）。这相当于以八进制符号表示的65。

生成此代码的LFSR如图7.11所示。最初所有寄存器元素都设置为零。将10个信息位顺序地馈送到LFSR中，其中开关S1和S2设置在位置1。然后，在最终输入位之后，将开关S1和S2设置在位置2，并且将五个奇偶校验位移出。奇偶校验位附加到信息位。随后，将10个信息比特的每个块编码为15比特码字。该代码可以纠正所有单个错误并检测每个代码字中的所有双重错误。这种2/3速率FEC用于DM分组，DV分组的数据字段，FHS分组，HV2分组和EV4分组中。由于编码器以长度为10的信息段进行操作，所以在CRC位之后应附加值为零的尾部位，使总位数等于10的倍数。要附加的尾比特数将是实现这一点的最小可能（即，在0 ... 9的间隔）。这些尾位不包括在ACL数据包的有效载荷长度指示符或eSCO设置LMP命令的有效载荷长度字段中。

图7.11：LFSR生成（15,10）缩短汉明码

## 7.6 ARQ方案

通过自动重传请求方案，发送直接到目的地返回成功接收到的确认（超过超时）之前，DM包，DH包，DV包的数据字段和EV包。确认信息应包含在返回数据包的头中。ARQ方案仅用于分组中的有效载荷，仅在具有CRC的数据包上使用。 HV和DV数据包的报文头和同步数据有效载荷不受ARQ方案的保护。

### 7.6.1未编号的ARQ

蓝牙使用快速，无编号的确认方案。响应于接收到先前接收的分组而返回ACK（ARQN = 1）或NAK（ARQN = 0）。从站应在从站到主站之间直接按照主站到从站槽位进行响应，除非从站在该时隙中具有分布式网络承诺;主机应在下一个寻址同一个从机的事件（主机可能已经从所考虑的从机的最后接收到的分组和对该分组的主响应之间寻址其他从机）进行响应。为了使分组接收成功，至少HEC必须通过。此外，MIC和CRC必须在存在时通过。

在新连接开始时的第一个POLL数据包中（由于页面，页面扫描或角色切换的结果），主器件应将ARQN位初始化为NAK。由从机发送的响应数据包也应将ARQN位设置为NAK。随后的数据包应使用以下规则。主站eSCO ARQN在链路建立时的初始值为NAK。

ARQN位只能受包含CRC和空槽的数据包的影响。如图7.12所示，在成功接收到CRC数据包后，ARQN位应设置为ACK。如果在从站的任何接收时隙中，或者在发送数据包之后的主站的接收槽中，这些事件之一适用：

1.没有检测到访问代码
HEC失败
CRC失败
MIC失败。

那么ARQN位应设置为NAK。在eSCO中，即使EV包上的CRC失败，也可将ARQN位设置为ACK，从而能够传递错误的数据包。

具有正确HEC但寻址到其他从站或除DH，DM，DV或EV数据包之外的数据包的数据包不会影响ARQN位，第7.6.2.2节除外。在这些情况下，ARQN位应该在接收到数据包之前留下。对于ACL分组，如果具有正确报头的CRC分组具有与先前接收到的CRC分组相同的SEQN，则ARQN比特应被设置为ACK，并且在不检查CRC的情况下忽略有效载荷。对于eSCO数据包，确定ARQN时不得使用SEQN。如果在eSCO窗口内成功接收到eSCO报文，eSCO窗口中的后续接收将被忽略。在eSCO窗口末尾，在下一个eSCO窗口中，主节点的ARQN将被保留用于第一个主从传输。

FHS数据包中的ARQN位无效。不要检查FHS包中的ARQN位的内容。

扩展查询响应数据包中的ARQN位保留供将来使用。

应使用CRC对广播数据包进行错误检查，但不应使用ARQ方案。广播数据包不能被承认。

注意：在图7.12中，TX指的是设备进行的下一个传输，并不意味着它必须在下一个时隙中发送。NO TX表示设备不能在下一个插槽中传输。

注意：在图7.14中，“分组确定”表示分组具有允许的连接TYPE，CRC有效。

图7.12：用于确定ARQN位的接收协议的第1阶段

图7.13：用于确定ARQN位的接收协议的第2阶段（ACL）

图7.14：用于确定ARQN位的接收协议的第2阶段（eSCO）

### 7.6.2重新发送过滤

发送数据有效载荷直到接收到肯定确认或超过超时。应该由于分组传输本身失败或由于返回分组中发送的确认失败（请注意，后者具有较低的故障概率，因为报头被更多地编码），所以重新执行。在后一种情况下，目的地一次又一次地接收相同的有效载荷。为了过滤出目的地中的重传，SEQN位存在于报头中。通常，对于每个新的CRC数据有效载荷传输，该位是交替的。在重传的情况下，该位不应该改变，所以目的地可以将SEQN位与先前的SEQN值进行比较。如果不同，新的数据有效载荷已经到达;否则它是相同的数据有效负载并且可以被忽略。只有新的数据有效载荷才能传送到基带资源管理器。请注意，CRC数据有效载荷只能由DM，DH，DV或EV数据包进行传输。

#### 7.6.2.1在新连接开始时初始化SEQN

主站和从站侧的连接开始时（作为页面，页面扫描或角色切换的结果）的第一个CRC数据包的SEQN位应设置为1。随后的数据包将使用以下各节中的规则。

#### 7.6.2.2 ACL和SCO重新发送过滤

SEQN位只能受到CRC数据包的影响，如图所示
### 7.15。每次发送一个新的CRC数据包时都将被反转。CRC数据包应以相同的SEQN号重新发送，直到收到ACK或数据包被清除为止。当接收到ACK时，可以发送新的有效载荷，并且在该传输上，SEQN位将被反转。如果一个设备决定刷新（见第7.6.3节），并且没有收到当前数据包的确认，它将用与当前数据包和长度相同的序列号的ACL-U连续数据包替换当前数据包零。如果以这种方式替换当前数据包，则它将不会继续传送下一个数据包，直到接收到ACK为止。

如果从机接收到在相同LT_ADDR上成功接收到的最后报头中的SEQN位与之相反的DH，DM，DV或EV之外的数据包，则应将ARQN位设置为NAK，直到DH，DM，DV或EV数据包成功接收。

图7.15：带有CRC的数据包的发送过滤

#### 7.6.2.3 eSCO重发过滤

在eSCO中，每个eSCO窗口都将切换SEQN位。在eSCO窗口的持续时间内，该值不变。SEQN的初始值为零。

对于给定的eSCO窗口，SEQN值应为常数。

#### 7.6.2.4 FHS重新发送过滤

FHS数据包中的SEQN位无效。该位可能设置为任何值。FHS数据包中SEQN位的内容不被检查。

#### 7.6.2.5扩展查询响应重传过滤

扩展查询响应数据包中的SEQN位保留供将来使用。

#### 7.6.2.6没有CRC重发过滤的数据包

在没有CRC的数据包传输期间，SEQN位将保持与之前的数据包相同。

7.6＃刷新有效载荷

在ACL逻辑传输中，ARQ方案可能导致业务流中的可变延迟，因为插入重传是为了确保无差错的数据传输。对于某些通信链路，仅允许有限量的延迟：允许重新发送到当前有效载荷将被忽略的某个限制。该数据传输被指示为同步业务。这意味着重传过程必须被推翻，以便继续下一个数据有效载荷。中止重传方案是通过刷新旧数据并强制链路控制器取代下一个数据来实现的。

冲洗导致L2CAP消息的剩余部分丢失。因此，刷新后的数据包在下一个L2CAP消息的有效负载报头中应具有LLID = 10的起始数据包指示。这通知目的地冲洗（见第6.6节）。冲洗不一定会导致SEQN位值的更改，请参见上一节。

“刷新超时”定义了最大时间间隔，之后从控制器缓冲区刷新Packet_Boundary_Flag值为10的ACL-U数据包的所有段。当ACL-U数据包的第一个段存储在Controller缓冲区中时，Flush Timeout将开始。如果ACL-U数据包的第一个数据包的Packet_Boundary_Flag值为00，则它是不可自动刷新的，不会导致刷新超时启动。在冲洗超时结束后，链路控制器可以根据7.6.2.2节中描述的过程继续传输，但是基带资源管理器不得继续向链路控制器传输ACL-U数据包。如果基带资源管理器具有进一步的分组排队以便传输到链路控制器，则它将从队列中删除ACL-U分组的剩余段。如果完整的ACL-U数据包尚未存储在控制器缓冲区中，则将刷新为ACL逻辑传输接收的任何延续段，直到接收到第一个段。当完整的ACL-U数据包被刷新时，链路管理器将继续传输下一个ACL-U数据包进行ACL逻辑传输。默认的Flush Timeout应该是无限的，即进行重新传输，直到发生物理链路丢失。这也被称为“可靠的渠道”。'所有设备都应支持默认的刷新超时。通过将可靠数据包标记为不可自动刷新的方式，通过有限冲突超时的通道发送可靠的数据。

在eSCO逻辑传输中，eSCO窗口末端应自动刷新报文。

无连接从播广播数据包在每个预定的无连接从播广播时刻传输。如果没有新的数据可用，无连接从广播发射机应发送一个包含有效载荷中最后可用数据的数据包。

### 7.6.4多从属注意事项

在具有多个逻辑传输的微微网中，主机应在每个逻辑传输上独立执行ARQ协议。

### 7.6.5活动从播广播数据包

ASB广播分组是由主机同时发送到所有从机的分组（参见第8.6.4节）如果正在使用多跳序列，则每个传输只能由某些从机接收。在这种情况下，主机将在每一跳序列上重复传输。ASB广播分组应由全零LT_ADDR指示（注意：FHS分组和扩展查询响应分组是唯一可能具有全零LT_ADDR但不是广播分组的分组）。广播数据包不被确认（至少不在LC级别）。

由于广播消息未被确认，所以每个广播包至少传送固定次数。ASB广播包应在下一个广播包之前传送NBC次
发送广播消息，见图7.16。可选地，ASB
广播数据包可以传送NBC + 1次。注意：NBC = 1表示每个广播数据包只应发送一次，但可选择发送两次。然而，时间关键的广播信息可能会中止正在进行的
广播火车此外，在ASB-C逻辑链路上发送的LMP包始终是用于这些目的的完整消息，并且始终发送一次; LMP规范可以提供是否以及何时发送具有相同或相关内容的另一消息的要求。

如果正在使用多跳序列，那么主机可以以任何顺序在不同的跳序列上进行发送，只要新的广播分组的传输不应该被启动，直到所有的传播分组的所有传输在所有跳序列上已经完成。单个广播分组的传输可以在跳序列之间进行交织，以最小化广播分组的总时间。主机可以选择在所有跳频序列共通的通道上只发送NBC次。
具有CRC的ASB广播分组应具有自己的序列号。具有CRC的第一广播分组的SEQN应由主机设置为SEQN = 1，并且此后对于每个新的广播分组将被反转。没有CRC的ASB广播包对序列号没有影响。从站应接受连接中接收的第一个广播数据包的SEQN，并检查后续广播数据包的SEQN中的变化。由于没有广播消息的确认，并且没有结束分组指示，所以重要的是正确接收到开始分组。为了保证这一点，L2CAP启动报文和LMP报文的广播报文重复不会被过滤掉。这些数据包应在有效载荷报头中由LLID = 1X表示，如表6.6所述。只有重复L2CAP连续包才能被过滤掉。

图7.16：广播重复方案

## 7.7错误的同步数据报告

同步链路可能会启用错误的数据报告。启用时，同步数据应如下处理：

- 如果在（e）SCO间隔期间，接收到具有有效HEC的eSCO分组，则接收到有效HEC的连接允许的TYPE，有效的CRC或SCO分组，则接收到的有效载荷数据将被发送到控制器的上边缘具有“良好的数据”指示。
- 如果在eSCO间隔期间接收到具有有效HEC的eSCO分组，但没有接收到具有连接的允许TYPE和有效的CRC，则可用的最佳已知数据（例如，从接收到的数据或实际有效载荷导出的数据使用CRC错误接收的数据）应发送到控制器的上边缘，并带有“可能出现错误的数据”指示。
- 如果在（e）SCO间隔期间没有接收到具有有效HEC的SCO或eSCO分组，则应将“丢失数据”指示发送到控制器的上边缘。

## 7.8消息完整性检查

当使用AES-CCM进行加密时，消息完整性检查（MIC）将被添加到CRC之前的有效载荷，用于定义为包括MIC的数据包。首先发送MIC最高有效字节（MSO）。

＃8 LINK CONTROLLER OPERATION


本节介绍如何建立微微网，以及如何将微波网络中的设备添加和释放。定义了设备的几种操作状态来支持这些功能。此外，讨论了具有一个或多个公共成员的几个微微网的运行，即分散网络。

## 8.1状态概述

图8.1显示了说明在Link Controller中使用的不同状态的状态图。有两个主要的状态：STANDBY和CONNECTION;此外，还有九个子状态，页面，页面扫描，查询，查询扫描，同步列表，同步扫描，主响应，从站响应和查询响应。请注意，下面的简化图中未显示主响应，从站响应和查询响应子状态。子状态是用于建立连接并启用设备发现的临时状态。要从一个状态或子状态移动到另一个状态，使用来自链路管理器的命令，或者使用链路控制器中的内部信号（例如来自相关器的触发信号和超时信号）。

图8.1：Link Controller的状态图

## 8.2 STANDBY STATE

STANDBY状态是设备中的默认状态。在这种状态下，器件可能处于低功耗模式。只有本机时钟运行的最差情况精度为+/- 250 ppm。

控制器可以保持STANDBY状态扫描页面或查询消息，或者进行页面或查询。

## 8.3连接建立物质

为了建立新的连接，使用寻呼过程或同步扫描过程。仅使用蓝牙设备地址才能使用寻呼过程建立连接。从查询程序（见第8.4节）获得的知识以及与本设备之前的连接以及其他设备的页面扫描模式都将加快分页过程。使用页面过程建立连接的设备将自动成为连接的主控。使用同步扫描过程建立连接的设备分两步进行。首先，从同步扫描子状态中，BR / EDR控制器遵循同步扫描过程从主机收集时钟，分组定时和AFH信道映射信息，然后转换到STANDBY状态。第二，按照主机的指示，BR / EDR控制器从STANDBY状态转换到CONNECTION状态的无连接从属广播模式。

截断页面过程是分页过程的修改，用于在从设备上故意生成页面响应超时。

### 8.3.1页面​​扫描子

在页面扫描子状态中，可以将设备配置为使用标准或通用隔行扫描过程。在一个标准
扫描时，设备将侦听扫描窗口的持续时间Tw_page_scan（11.25ms默认值，参见HCI [Vol 2] E部分，第7.3.20节），而广义隔行扫描是以Tw_page_scan的两个背靠背扫描方式执行的。如果扫描间隔不是扫描窗口的两倍，则不应使用通用隔行扫描。在每个扫描窗口期间，设备将以单跳频率进行监听，其相关器与其设备访问码（DAC）相匹配。扫描窗口应足够长以完全扫描16页频率。

当设备进入页面扫描子状态时，应根据设备的蓝牙设备地址确定的跳帧顺序选择扫描频率，请参见第2.6.4.1节。序列中的相位由设备本机时钟的CLKN16-12决定;就是每一个
## 1.28选择不同的频率。

在标准扫描的情况下，如果在扫描期间相关器超过触发阈值，器件将进入第8.3.3.1节中描述的从应答子状态。扫描装置也可以使用广义的隔行扫描。在这种情况下，如果相关器在第一次扫描期间没有超过触发阈值，则应使用由[CLKN16-12 + interlace_offset] mod 32确定的序列中的相位扫描第二次。如果在第二次扫描时，相关器超过触发阈值，器件将在Xprs（79）的计算中使用[CLKN16-12 + interlace_offset] mod 32作为冻结CLKN *进入从响应子状态（详见第2.6.4.3节） ）。如果相关器在正常模式下的扫描期间或在隔行扫描模式下的第二次扫描期间不超过触发阈值，则应返回到STANDBY或CONNECTION状态。

interlace_offset的取值范围为0〜31。应使用值16，除非不能用于扫描的槽的图案意味着使用不同的值。

可以从STANDBY状态或CONNECTION状态输入页面扫描子状态。在STANDBY状态下，没有建立连接，设备可以使用所有的容量进行页面扫描。在从CONNECTION状态进入页面扫描子状态之前，设备应该尽可能多地保留扫描的容量。如果需要，设备可以将ACL连接置于保持状态（见第8.8节）或嗅探（见第8.7节）。同步连接不应该被页面扫描中断，尽管在扫描期间应该暂停eSCO重传。页面扫描可能被保留的同步时隙中断，这些同步时隙应该具有比页面扫描更高的优先级。应使用SCO数据包，要求最小容量（HV3数据包）。应增加扫描窗口以最小化设置延迟。如果使用HV3数据包和TSCO = 6时隙或一个eSCO逻辑传输存在一个SCO逻辑传输
目前使用EV3数据包和TeSCO = 6插槽，总扫描窗口
建议至少36个插槽（22.5ms）的Tw_page_scan;如果使用HV3分组存在两个SCO链路，并且使用EV3分组和Te​​SCO = 6时隙存在TSCO = 6时隙或两个eSCO链路，则建议至少54个时隙（33.75ms）的总扫描窗口。

扫描间隔Tpage_scan被定义为两次连续页面扫描的开始间隔。在这种情况下有区别
扫描间隔等于扫描窗口Tw_page_scan（连续扫描），扫描间隔最大为1.28s，扫描间隔最大为2.56s。这三种情况应确定寻呼装置的行为;也就是说，寻呼设备是否使用R0，R1或R2，另见第8.3.2节。表8.1说明了Tpage_scan与模式R0，R1和R2之间的关系。虽然在R0模式下的扫描是连续的，扫描可能是
例如通过保留的同步时隙中断。扫描间隔信息包含在FHS包中的SR字段中。

表8.1：扫描间隔和分页模式R0，R1和R2之间的关系

### 8.3.2页子

主页（源）使用页面子表来激活并连接到页面扫描子表中的从站（目标）。主机通过在不同的跳频通道中重复地发送由从设备设备访问码（DAC）组成的寻呼消息来尝试与从站的扫描活动相符。由于主器件和从器件的蓝牙时钟不同步，因此主器件不知道从器件从何时唤醒以及哪个跳频。因此，它以不同的跳频发送一列相同的页扫描消息，并在发送间隔之间进行侦听，直到接收到来自从机的响应。

主程序中的页面过程由多个步骤组成。首先，主机将从站的BD_ADDR传送给控制器。该BD_ADDR应由主机使用以确定页跳频序列;见第2.6.4.2节。对于序列中的相位，主器件应使用从机时钟的估计。例如，这个估计可以从上次与特定设备（当时可以作为主人）或在查询过程中交换的定时信息中得出。通过这个估计CLKE的从站的蓝牙时钟，主站可以预测从站启动页面扫描的跳信道。

从机中蓝牙时钟的估计可能是完全错误的。虽然主器件和从器件使用相同的跳频序列，但它们在序列中使用不同的相位，并且可能永远不会选择相同的频率。为了补偿时钟漂移，主机将在短时间间隔内在多个唤醒频率上发送其寻呼消息。它也将在当前预测跳频之前和之后的跳频上传输。在每个TX时隙期间，主机将在两个不同的跳频上顺序发送。在接下来的RX时隙中，接收机将依次听到两个对应的RX跳数，用于一个ID分组。应根据页面响应跳频顺序选择RX跳数。页面响应跳变序列与页面跳频序列严格相关：对于每个页面跳都有一个相应的页面响应跳。页面子状态中的RX / TX定时在2.2.5节中介绍，另见图2.7。在下一个TX时隙中，主机应在与前者不同的两跳频率上进行发送。注意：跳转速率提高到3200跳/秒。

利用如上所述的增加的跳频速率，发射机可以在16个时隙或10ms内覆盖16个不同的跳频。页跳频序列分为两个16个频率的寻呼串A和B。列车A包括围绕当前预测跳频f（k）的16跳频率，其中k由时钟估计CLKE16-12确定。第一列火车组成
的啤酒花

f（k-8），f（k-7），...，f（k），...，f（k +

当主机和从机的蓝牙时钟之间的差异在-8x1.28 s和+ 7x1.28 s之间时，主机使用的频率之一将是从机听到的跳频。由于主机不知道从机将何时进入页面扫描子状态，所以主机必须
重复此列车A Npage次或直到获得响应，以较短者为准。如果从属扫描间隔对应于R1，则重复次数至少为128;如果从属扫描间隔对应于R2，或者主机先前尚未读取从机的SR模式，则重复次数至少为256。如果主机以前没有读取从站的SR模式，则应使用Npage> = 256。请注意，CLKE16-12每1.28秒更改一次;因此，每1.28秒，火车将包括不同频率的页面跳变组。

当主机和从机的蓝牙时钟之间的差值小于-8×1.28s或大于+ 7x1.28s时，其余的16跳将用于形成新的10毫秒列车B.第二列车由酒花

f（k-16），f（k-15），...，f（k-9），f（k + 8）...，f（k +

列车B应重复N页次。如果没有获得响应，则在接收时隙周期性不可用的情况下可以更新knudge，并且训练A将再次尝试Npage次。列车A和列车B的替代使用以及滚动更新应继续进行，直到收到响应或超时页面TOTO。当extended_pa​​geTO是
大于零，超时可能会扩展到（pageTO + extended_pa​​geTO）。如果从站返回响应，则主设备进入主应答子状态。

可以从STANDBY状态或CONNECTION状态输入页面子状态。在STANDBY状态下，没有建立连接，设备可以使用所有的容量来执行页面。在从CONNECTION状态进入页面子状态之前，设备应尽可能释放分页容量。为了确保这一点，建议将ACL连接置于保持状态。但是，同步连接不得受到页面的干扰。这意味着页面将被保留的优先级高于页面的SCO和eSCO插槽中断。为了获得尽可能多的寻呼容量，建议使用最小容量（HV3数据包）的SCO数据包。如果存在SCO或eSCO链路，则单列车的重复次数Npage应增加，见表8.2。这里假设HV3分组以间隔TSCO = 6时隙使用，或者EV3分组以TeSCO = 6时隙的间隔使用，这将对应于64kb / s的同步链路。

表8.2：当同步链路存在时，列车重复和寻呼模式R0，R1和R2之间的关系

网页列车的建设应与独立存在的同步链路无关;也就是说，同步分组在保留时隙上发送，但不影响未保留时隙中使用的跳频，见图8.2。

图8.2：当存在两个同步链路（c）时，一个同步链路存在（b）页面的常规页面（a），页面

### 8.3.3页面响应子状态

当从站成功接收到页面消息时，主站和从站之间存在粗略的FH同步。主机和从机都输入响应子状态以交换重要信息以继续连接设置。对于微网连接来说，两个设备将使用相同的信道接入码，使用相同的信道跳频序列，并且它们的时钟同步是重要的。这些参数应来自主设备。初始化连接（开始寻呼）的设备被定义为主设备（因此仅在微微网存在时才有效）。信道接入码和信道跳频序列应从主设备的蓝牙设备地址（BD_ADDR）导出。时序由主时钟决定。一个偏移量将被添加到从站的本机时钟，以将从时钟临时同步到主时钟。在启动时，主站参数从主站传送到从站。本节中指定了启动时主站和从站之间的消息传递。

主站和从站之间的初始消息传递如表8.3和图8.3和图8.4所示。在这两个图中，频率f（k），f（k + 1）等是由从机的BD_ADDR确定的页面跳频序列的频率。频率f'（k），f'（k + 1）等是相应的页响应频率（从主到主）。频率g（m）属于基本信道跳频序列。


表8.3：启动期间的初始消息

在步骤1（见表8.3）中，主设备处于页面状态，页面中的从设备扫描子状态。假设在此步骤中主机发送的页面消息到达从站。在接收到页面消息时，从站在步骤2中进入从站响应。主机等待来自从站的回复，当在步骤2中到达时，应在步骤3中输入主应答。请注意，在初始消息交换期间，所有参数都是从从设备地址导出的，只有页面跳频和页面响应跳变序列被使用（也从从设备地址获得）。请注意，当主从进入响应状态时，按照第2.6.4.3节所述，对页面和页面响应跳选择的时钟输入进行冻结。

图8.3：从机响应第一页消息时初始连接时的消息传递

图8.4：当从站响应第二页消息时初始连接时的消息传递

在截断页面过程的情况下，消息在步骤2之后按照表8.3所示的顺序停止。该过程如图8.5和图8.6所示。

图8.5：前半部分截断的页面

图8.6：下半部分截断的页面

#### 8.3.3.1从属响应子

在步骤1中接收到页面消息之后，从设备将在步骤2中发送从站页面响应消息（从站设备访问代码）。该响应消息应为从设备的访问代码。奴隶应传送这个回应625？在接收到的页面消息的开始之后并且以与接收到页面消息的跳频相对应的响应跳频为止。因此从机传输与主传输时间对齐。在初始消息传递期间，从站仍然使用页面响应跳转序列将信息返回给主设备。时钟输入CLKN16-12应冻结在接收到页面消息时的值。

发送响应消息后，从机的接收器将被激活
## 312.5？在响应消息开始之后，等待FHS分组的到达。请注意，FHS包可以到达312.5？s页面消息到达后如图8.4所示，而不是625之后？通常在微微网物理通道RX / TX定时的情况下。有关时间的更多细节，请参见第2.4.4节。

如果在达到CONNECTION状态之前设置失败，则应执行以下步骤。只要没有收到FHS数据包，直到超出pagerespTO，从机才会侦听。然而，每1.25毫秒，它将根据页跳序列选择下一个从主到从跳频率。如果pagerespTO之后没有收到任何内容，则从站将返回到扫描子页面一个扫描周期。扫描周期的长度取决于存在的同步保留时隙。如果在此附加扫描周期内没有接收到页面消息，则从站将以其定期扫描间隔恢复扫描，并返回到第一页扫描状态之前的状态。

如果来自从应答子状态的从机接收到FHS分组，则从机将在步骤4中返回从页面响应消息，以确认FHS分组的接收。该响应应使用页面响应跳变序列。从页面响应包的传输是基于FHS包的接收。然后，从机将从FHS分组转换为主机的通道访问代码和时钟。

只有主时钟的26个MSB被传送：定时应该使得当主站在偶数时隙中接收到FHS数据包时，CLK1和CLK0均为0。主时钟之间的偏移
从机时钟应从FHS的主时钟确定
分组并向从属的基带资源管理器报告。

最后，从站在步骤5中进入CONNECTION状态。从那时起，从机将使用主时钟和主机的BD_ADDR来确定基本的信道跳频序列和信道接入码。从站应使用FHS有效负载中的LT_ADDR作为连接状态下的主要LT_ADDR。连接模式应以主机发送的POLL包开始。从机可以用任何类型的数据包进行响应。如果从站不接收到POLL分组，或者主机没有接收到响应分组，则在FHS分组确认后的新连接数量的时隙内，主机和从机应分别返回页面和页面扫描子状态。见第8.5节

#### 8.3.3.2主响应子状态

当主机在步骤2中接收到一个从属页面响应消息，并且主机没有执行截断页面过程时，它将进入主应答程序。冻结当前时钟输入到页跳选择方案。然后，主器件将在步骤3中传输一个包含主器件实时蓝牙时钟，主器件BD_ADDR，BCH奇偶校验位和器件类的FHS数据包。FHS分组包含构成通道访问代码的所有信息，而不需要从主设备的蓝牙设备地址进行数学推导。主响应子状态中FHS数据包的报头中的LT_ADDR字段应设置为全零。FHS数据包应在从站响应的时隙之后的主从从站的开头发送。FHS数据包应携带全零LT_ADDR。 FHS的TX定时不是基于来自从机的响应分组的接收。因此，FHS分组可以被发送312.5？s接收到响应包后如图8.4所示，而不是625？在接收到的分组之后，通常在微微网物理信道RX / TX定时中，参见第2.4.4节。

在主机发送了FHS分组之后，它将在步骤4中等待第二个从属页响应消息，确认接收到FHS分组。该响应应为从设备的访问代码。如果没有收到响应，主机将使用更新的时钟重发FHS数据包，并仍然使用从站的参数。它将重新发送每次更新的时钟的FHS包，直到接收到第二个从属页面响应消息，或者超出了pagerespTO的超时。在后一种情况下，主机应返回页面子状态，并向基带资源管理器发送错误消息。在重传FHS数据包期间，主机应使用跳频序列。

如果接收到从机的响应，则主机应改变为使用主参数，因此应使用通道访问代码和主时钟。在FHS分组传输开始时，较低时钟位CLK0和CLK1将被复位为零，并且不包括在FHS分组中。最后，主机在步骤5中进入CONNECTION状态。主BD_ADDR应用于改变新的跳频序列，即基本的信道跳频序列。基本的信道跳频序列以伪随机方式使用所有79跳信道，另见第2.6.4.7节。主人现在将以新（主）参数确定的跳数发送其第一个流量包。该第一个数据包应为POLL数据包。见第8.5节。在接收到FHS分组确认之后，该分组将在新连接数目的时隙内发送。从机可以用任何类型的数据包进行响应。如果POLL分组未被从机接收，或者POLL分组响应在新连接T0时隙内不被主机接收，则主机和从机应分别返回页面和页面扫描子状态。

## 8.4设备发现物质

为了发现其他设备，设备应进入查询子状态。在这个子状态中，它将以不同的跳频重复发送查询消息（ID分组，见第6.5.1.1节）。查询跳序列来自GIAC的LAP。因此，即使使用DIAC，从GIAC LAP生成所应用的跳频序列。允许自己发现的设备应定期进入查询扫描子状态以响应查询消息。以下部分将介绍查询响应期间的消息交换和争用解决。查询响应是可选的：设备不被强制响应查询消息。

在查询子状态期间，发现设备收集所有响应查询消息的设备的蓝牙设备地址和时钟。此外，发现设备还从响应于扩展查询响应分组的设备收集扩展信息（例如本地名称和支持的服务）。然后，如果需要，可以借助于先前描述的页面过程来连接到发现的任何一个设备。

由源广播的查询消息不包含有关源的任何信息。但是，它可能指示哪一类设备应该响应。有一个通用查询访问代码（GIAC）来查询任何设备，以及一些仅查询特定类型的设备的专用查询访问代码（DIAC）。查询访问代码来自保留的蓝牙设备地址，并在6.3.1节进一步描述。

### 8.4.1查询扫描子

查询扫描子状态与页面扫描子状态非常相似。然而，接收机不需要扫描设备的设备访问代码，而是扫描查询访问代码足够长的时间来完全扫描16个查询频率。定义了两种类型的扫描：标准和广义交错。在标准扫描的情况下，该扫描周期的长度为
表示Tw_inquiry_scan（11.25ms默认值，见HCI [Vol 2] E部分，第7.3.22节）。标准扫描以Xir4-0定义的单跳频率执行（见第2.6.4.6节）。执行广义隔行扫描
作为Tw_inquiry_scan的两个背靠背扫描，其中第一扫描在正常跳频上，并且第二扫描由[Xir4-0 + interlace_offset] mod 32定义。如果扫描间隔不是扫描的两倍
窗口然后将不使用通用隔行扫描。查询过程根据查询跳频序列使用32个专用查询跳频。这些频率由通用查询地址确定。该相位由执行查询扫描的设备的本机时钟确定;相位变化每1.28s。

interlace_offset的取值范围为0〜31。应使用值16，除非不能用于扫描的槽的图案意味着使用不同的值。

替代或者除了一般查询访问代码之外，设备可以扫描一个或多个专用查询访问代码。然而，扫描应遵循由通用查询地址确定的查询扫描跳频序列。如果在查询唤醒期间收到查询消息，则设备应进入询问响应子状态。

查询扫描子状态可以从STANDBY状态或CONNECTION状态进入。在待机状态下，没有建立连接，设备可以使用所有的容量进行查询扫描。在从CONNECTION状态进入查询扫描子状态之前，设备应尽可能保留扫描的容量。如果需要，设备可以将ACL逻辑传输置于Sniff或Hold中。尽管在扫描期间应该暂停eSCO重传，但同步逻辑传输最好不被查询扫描中断。在这种情况下，查询扫描可能被保留的同步时隙中断。应使用SCO数据包，要求最小容量（HV3数据包）。扫描窗口Tw查询扫描将被增加以增加响应查询消息的概率。如果使用HV3分组和TSCO = 6时隙存在一个SCO逻辑传输，或者使用EV3分组和Te​​SCO = 6时隙存在一个eSCO逻辑传输，则建议至少36个时隙（22.5ms）的总扫描窗口;如果使用HV3分组存在两个SCO链路，并且使用EV3分组和Te​​SCO = 6时隙存在TSCO = 6时隙或两个eSCO链路，则建议至少54个时隙（33.75ms）的总扫描窗口。

扫描间隔Tinqu​​iry扫描定义为两次连续查询扫描之间的间隔。查询扫描间隔应小于或等于2.56秒。

### 8.4.2查询子

查询子状态用于发现新设备。这个子状态与页面子状态非常相似; TX / RX定时与寻呼中的相同，请参见第2.4.4节和图2.7。TX和RX频率应遵循查询跳频序列和查询响应跳频序列，并由发现设备的一般查询访问代码和本机时钟确定。在查询传输之间，接收机应扫描查询响应消息。当收到响应时，应读取整个数据包（FHS数据包）。如果FHS数据包中的EIR位设置为1，则设备应尝试接收扩展查询响应数据包1250？在FHS包开始之后。此后，设备将继续查询传输。查询子状态中的设备不得确认查询响应消息。如果主机使能（见HCI [第2卷）E部分，第7.3.50节），则应测量查询响应消息的RSSI值。它将不断地探测不同的跳信道，并在侦听响应报文之间。如在页面子状态中，定义了两个10毫秒的A和B列，将查询跳频序列的32个频率分成两个16跳部分。在使用新列车之前，必须重复一班至少Ninquiry = 256次。为了在无错误的环境中收集所有响应，至少必须有三列火车开关。因此，查询子状态可能需要持续10.24秒，除非查询者收集足够的响应并较早中止查询子状态。如果需要，查询者还可以延长查询子状态以增加在容易出错的环境中接收所有响应的可能性。当某些接收时隙周期性不可用时，根据可用接收时隙的模式，可能需要最多31台火车交换机才能在无差错的环境中收集所有响应。在每次切换到A之前，可以更新knudge。因此，查询子状态可能需要持续40.96秒。如果定期自动启动查询过程（每分钟10秒钟），则两个查询实例之间的间隔应随机确定。这样做是为了避免两个设备同步其查询过程。

查询子状态持续到基带资源管理器（当它确定它有足够的响应时间），当达到超时（Inquiry_Length）时，或者通过主机取消查询过程的命令停止。如果Extended_Inquiry_Length与零不同，则超时可能会扩展为（Inquiry_Length + Extended_Inquiry_Length）。

查询子状态可以从STANDBY状态或CONNECTION状态进入。在待机状态下，没有建立连接，设备可以使用所有的容量进行查询。在从CONNECTION状态进入查询子状态之前，设备应尽可能多地查询容量。为了确保这一点，建议将ACL逻辑传输放置在Sniff或Hold中。

但是，同步逻辑传输的保留时隙不应受到查询的干扰。这意味着查询将被保留的优先级高于查询的SCO和eSCO插槽中断。为了获得尽可能多的查询能力，建议使用最小容量（HV3数据包）的SCO数据包。如果存在SCO或eSCO链接，则重复号码Ninquiry将为
增加，见表8.4。

这里假设HV3分组以间隔TSCO = 6时隙使用，或者EV3分组以TeSCO = 6时隙的间隔使用，这将对应于64kb / s的同步链路。

表8.4：当同步链路存在时，增加列车重复

如果因优先级较高的业务而无法接收到扩展的查询响应报文，则由于HEC或CRC故障，接收失败，或者由于设备不支持报文类型，所以查询响应应报告给较高层作为扩展查询响应与全零数据。

### 8.4.3查询回应子

用于查询的从站响应子状态与应用于页面的从属响应子状态完全不同。当在查询扫描子状态中接收到查询消息时，收件人应返回包含收件人设备地址（BD_ADDR）的其他参数的查询响应（FHS）包。如果收件人有非零扩展查询响应数据发送，则应在FHS数据包之后返回扩展查询响应数据包。

应使用从站查询响应中的以下协议。在查询扫描子站接收到的第一个查询消息中，从站应进入查询响应子状态。如果从站有非零扩展查询响应数据发送，则它将返回FIR数据包，EIR位设置为1到主站625？收到查询讯息后。那么它应该返回一个扩展的询问响应包1250？在FHS包开始之后。如果从站的扩展查询响应数据全为零，则从站只能返回一个EIR位设置为零的FHS数据包。当多个设备紧邻查询设备并且都同时响应查询消息时，可能出现争用问题。然而，因为每个设备都有一个自由运行的时钟，所以它们都不太可能使用与查询跳频序列相同的阶段。为了避免在相同的查询跳信道中同时唤醒的设备之间的重复冲突，设备将在随机时间段内进行退避。因此，如果设备接收到查询消息并返回FHS分组，则它将生成0和MAX_RAND之间的随机数RAND。扫描间隔？1.28s MAX_RAND应为1023，但对于<1.28s的扫描间隔，MAX_RAND可能小至127。使用特殊DIAC的配置文件可以选择使用比1023更小的MAX_RAND，即使扫描间隔为1.28秒。至少RAND时隙的持续时间，从机应返回CONNECT或STANDBY状态。在返回到CONNECTION和STANDBY状态之前，设备可以通过页面扫描子状态。在至少RAND时隙之后，设备将向查询跳序列中的阶段添加一个偏移量1（相位为1.28 s分辨率），并再次返回查询扫描子状态。如果从机被再次触发，则应使用新的RAND重复该过程。每次返回FHS数据包时，时钟的偏移量都会累积。在探测窗口期间，从站可以响应多次，但在不同的频率和不同的时间。
保留的同步时隙应优先于响应包;也就是说，如果响应分组与保留的同步时隙重叠，则不会发送，而是等待下一个查询消息。如果设备已经扩展了要发送的查询响应数据，但是扩展查询响应分组与保留的同步时隙重叠，则可以将EIR位设置为零来发送FHS分组。

查询例程中的消息传递总结在表8.5中。在步骤1中，主设备使用查询访问码及其自己的时钟发送查询消息。从站用包含从站的蓝牙设备地址，本地时钟和其他从站信息的FHS数据包进行响应。这种FHS包在往往是随机的时候返回。FHS分组在查询例程中未被确认，但是只要主机正在查询查询消息，则在其他时间和频率重发FHS分组。如果从站具有非零扩展查询响应数据，则在步骤3中向主设备发送扩展查询响应分组。

扩展查询响应报文是DM1，DM3，DM5，DH1，DH3或DH5类型的ACL报文。为了最小化干扰，建议使用适合数据的最短数据包。FHS数据包启动后1250μs，发送频率与FHS数据包相同。在报头中，LT_ADDR应设置为零。TYPE应为DM1，DM3，DM5，DH1，DH3或DH5之一。FLOW，ARQN和SEQN都应设置为零，并在收到时忽略。HEC LFSR应使用与FHS数据包相同的DCI（默认检查初始化）进行初始化。在有效载荷报头中，LLID应包含值10（L2CAP消息的开始或不分段）。FLOW应设置为零，并在收到时忽略。有效载荷体长度（LENGTH）应小于或等于240字节。CRC LFSR应以与FHS数据包相同的DCI进行初始化。数据白化LFSR应与FHS数据包的初始值相同。

有效载荷数据有两部分，其中很重要的部分是非重要部分。重要部分包含[Vol 3] C部分第8节中定义的数据结构序列。非有效部分包含全零八位字节。

基带不得改变重要部分的任何八位字节。当发送数据时，可以从有效载荷中省略非有效部分八位字节。

设备应存储单个扩展查询响应数据包。该包应与所有IAC一起使用。

表8.5：查询例程中的消息传递

*扩展查询响应数据包以与查询响应（FHS）数据包相同的频率发送。

## 8.5连接状态

在CONNECTION状态下，连接已经建立，数据包可以来回发送，除了无连接从广播模式，在这种情况下，数据包只能从主机发送。在两个设备中，都使用通道（主站）访问码，主站的蓝牙时钟和AFH_channel_map。CONNECTION状态使用基本或适配的信道跳频序列。

有两种方法可以进入CONNECTION状态。设备可以从页面/页面扫描子状态转换到CONNECTION状态，或者直接从STANDBY状态转换到CONNECTION状态的无连接从属广播模式。

如果设备从页面/页面扫描子状态进入，则CONNECTION状态从主机发送的POLL包开始，以验证切换到主机的定时和信道跳频。从机可以用任何类型的数据包进行响应。如果从站没有接收到POLL分组，或者主机没有收到新的连接数量的时隙的响应分组，则两个设备都应返回到页面/页面扫描子状态。

CONNECTION状态中的第一个信息包含有表示链接的控制消息，并提供有关设备的更多详细信息。这些消息在设备的链路管理器之间交换。例如，它们可以定义SCO逻辑传输和嗅探参数。那么用户信息的传输可以通过交替地发送和接收数据包来开始。

CONNECTION状态留在分离或复位命令中。如果链路以正常方式断开连接，则使用detach命令;链路控制器中的所有配置数据将保持有效。复位命令是Link Controller的软复位。软复位的功能描述在[第2卷] E部分，第7.3.2节中。

在CONNECTION状态下，如果设备始终不会在通道中名义上出现，则可以通过使用嗅探模式或保持模式来描述其不可用性（见图8.7）。

如果设备进入CONNECTION状态的无连接从广播模式，则主机通过在CSB逻辑传输上发送数据包开始，从机通过接收在CSB逻辑传输上发送的数据包来启动。

图8.7：连接状态

## 8.6活动模式

在主动模式下，主机和从机都主动参与通道。在微微网中的任何给定时间，最多七个从站可能处于活动模式。主人根据来往不同奴隶的交通需求调度传输。此外，它还支持常规传输，以使从站同步到通道。从站主动模式监听从主站到从站槽位的数据包。这些设备被称为活动从站。如果一个活动的从站没有寻址，它可能会睡到下一个新的主站传输。从机可以从分组报头中的TYPE字段导出主机保留用于传输的时隙数;在此期间，未被寻址的从站不需要在主机到从机时隙上侦听。当设备正在参与多个微微网时，它应该在当前微微网的主从从槽中收听。建议一个设备不要远离每个微微网，在其中参与多个Tpoll插槽。需要定期的主传输来保持从站与通道同步。由于奴隶只需要
通道访问代码进行同步，任何数据包类型都可以用于此目的。

只有由其一个LT_ADDR（主要或次要）寻址的从机可能会在下一个从属主机插槽中返回一个数据包。如果没有接收到有效的报文头，则从站只能在其保留的SCO或eSCO从站到主站槽位中进行响应。在广播消息的情况下，从站不返回数据包。

图8.8：多从机配置中的RX / TX时序

对于ACL逻辑传输，模式选择可以留给实时分组类型选择。然而，第6.5节中的分组类型表（ptt）允许为每个分组类型代码选择基本速率或增强数据速率; DM1数据包在所有数据包类型表中都可用。该给定物理或逻辑链路上的ACL流量应利用表6.2给定列中的数据包类型。

### 8.6.1在主动模式下轮询

主人总是完全控制微微网。由于TDD方案，从站只能与主站而不是其他从站通信。为了避免在ACL逻辑传输上发生冲突，只有从机到主机时隙中的从机才能在前一主机到从机时隙的分组报头中被LT_ADDR寻址时才允许从机发送。如果前一时隙中的LT_ADDR不匹配，或者没有收到有效的报文头，则从站不发送。

主机通常会尝试轮询从站的ACL逻辑传输，而不是频繁地每Tpoll插槽一次。Tpoll由Link Manager设置（参见[Vol 2] C部分，第4.1.8节）。

可以使用除FHS和ID之外的任何数据包类型轮询从站的ACL逻辑传输。例如，SCO期间的轮询可以使用HV分组，因为从机可以对具有DM1分组的HV分组作出响应（参见第8.6.2节）。

### 8.6.2 SCO

SCO逻辑传输应由主机通过LM协议发送SCO建立消息建立。该消息包含定时参数，包括SCO间隔TSCO和偏移DSCO以指定保留
插槽。

为了防止时钟回绕问题，LMP建立消息中的初始化标志表示是否正在使用初始化过程1或2。从机应用初始化标志所指示的初始化方法。当当前主时钟（CLK27）的MSB为0时，主机应使用初始化1;当当前主时钟（CLK27）的MSB为1时，应使用初始化2。主器件和从器件保留的主器件到从器件SCO插槽应在时钟满足适用公式的插槽上初始化：

CLK27-1 mod TSCO =用于初始化的DSCO 1（CLK27，CLK26-1）mod TSCO = DSCO
用于初始化2

从机到主机SCO时隙应直接跟随保留的主从到SCO时隙。初始化后，时钟值CLK（k + 1）为下一个
通过将固定间隔TSCO添加到当前主从从SCO插槽的时钟值，将导出主从从SCO插槽：

CLK27-1（k + 1）= CLK27-1（k）+ TSCO

主机将在保留的主机到从机插槽中以规律的间隔（SCO间隔TSCO计数在时隙中）向从机发送SCO数据包。HV1分组可以以64kb / s的速率传送1.25ms的语音。HV1包应该
因此每两个时隙发送（TSCO = 2）。HV2分组可以以64kb / s的速率传送2.5ms的语音。因此，应该每四个时隙（TSCO = 4）发送一个HV2数据包。一个HV3数据包可以传送3.75毫秒的语音在一个64
kb / s速率。因此，每隔六个时隙（TSCO = 6）将发送一个HV3数据包。
允许从机在为其SCO逻辑传输保留的时隙中发送，除非在前一时隙中接收到具有正确接入码的分组，并且LT_ADDR没有寻址该从机（不管HEC是否正确）。如果在前一个插槽中接收到正确的LT_ADDR，但HEC不正确，则从站不应在保留的SCO插槽中进行传输。

由于在SCO逻辑传输中识别出DM1分组，所以如果在前一时隙中接收到具有主LT_ADDR的有效分组报头，则可以在SCO保留时隙期间发送DM1分组。SCO保留时隙发送的DM1报文只能用于发送ACL-C数据。

从站不得在保留的SCO槽中传输除HV数据包以外的任何其他内容，除非在先前的主从传输时隙中对其自身的从站地址进行解码。

### 8.6.3 eSCO

eSCO逻辑传输由主设备通过LM协议发送eSCO建立消息建立。该消息包含时间参数，包括eSCO间隔TeSCO和偏移DeSCO以指定保留
插槽。

要进入eSCO，主机或从机应通过LM协议发送eSCO设置命令。该消息应包含eSCO间隔TeSCO和偏移DeSCO。为了防止时钟回绕问题，初始化
LMP设置消息中的标志表示初始化过程1或2
应使用。当当前主时钟（CLK27）的MSB为0时，启动设备应使用初始化1;当当前主时钟（CLK27）的MSB为1时，应使用初始化2。响应设备将应用初始化标志所指示的初始化方法。由主器件和从器件保留的主从eSoE插槽应在时钟满足适用等式的插槽上初始化：

CLK27-1 mod TeSCO = DeSCO初始化1（CLK27，CLK26-1）mod TeSCO =用于初始化的DeSCO 2

从主机到主机的eSCO插槽应直接跟随保留的主从到eSoE插槽。初始化后，时钟值CLK（k + 1）为下一个
通过将固定时间间隔TeSCO添加到当前主备对eSoE插槽的时钟值，可以找到主从到eSoE插槽：

CLK27-1（k + 1）= CLK27-1（k）+ TeSCO

当eSCO逻辑传输建立时，主机应为从机分配一个附加的LT_ADDR。这为eSco逻辑传输提供了与ACL逻辑传输分离的ARQ方案。在eSCO LT_ADDR上运行的特定eSCO逻辑传输的所有流量，只有eSCO流量。 eSCO ARQ方案使用报文头中的ARQN位，与ACL链路上的ARQ方案类似。

eSCO有两种不同的投票规则。在eSCO保留时隙中，轮询规则与SCO保留时隙相同。主机可以在主插槽中发送数据包。如果在前一个插槽中的eSCO LT_ADDR上收到一个数据包，或者前一个插槽中没有收到有效的数据包头，从机可以在以下时隙的eSCO LT_ADDR上传输。当主从分组类型为三时隙分组时，从机的发送时隙为eSCO保留时隙的第四个时隙。只有在eSCO LT_ADDR寻址或在前面的eSCO保留时隙内没有发送任何数据包的情况下，主控者才能在eSCO LT_ADDR的eSCO重传窗口中传输。仅当从机在eSCO保留时隙中没有收到不同LT_ADDR的有效分组报头时，从机可能会在eSCO预留时隙的eSCO LT_ADDR上进行传输。

在内部重传窗口中，使用与ACL流量相同的轮询规则：只有在从前主站到从站传输槽中的eSCO通道接收到有效的数据包头并纠正LT_ADDR时，从站才会在eSCO通道上传输。主机可以在eSCO重传窗口内的任何主从传输槽中的任何非eSCO LT_ADDR上进行传输。

如果在重传窗口中有足够的时隙，主机和从机数据包都完成，主机只能在重传窗口的eSCO LT_ADDR上传输。如果主机正在发送一个NULL数据包（ARQN = ACK），则需要一个时隙，否则它需要足够的时隙才能使主机协商的eSCO数据包类型加上：

- 如果主机的报文具有ARQN = NAK，则该从站的协商的eSCO报文类型的时隙足够大;
- 如果主器件的数据包有ARQN = ACK，则一个插槽。

在eSCO重传窗口期间，主机可能不会在任何时隙发送。当没有数据从主机发送到从机时，由于业务是单向的，或由于主从分组已经被ACK，主机应使用POLL分组。当主从分组已经被ACK确认并且从属到主数据包已被正确接收时，主机不得在eSCO LT_ADDR上寻址从机，直到下一个eSCO保留时隙，除了主机可以在eSCO LT_ADDR上传送ARQN = ACK的NULL数据包。当没有数据从从站发送到主站时，由于流量是单向的，或由于从站到主站的数据包已经被ACK，从站将使用NULL数据包。在重传窗口中，eSCO流量应优先于ACL流量。

使用单时隙数据包时，eSOS窗口如图8.9所示。

图8.9：单槽数据包的eSCO窗口详细信息

当在eSCO逻辑传输的任一方向上使用多时隙分组时，第一个传输继续进入以下时隙。在这种情况下，重传窗口在从属主数据包结束之后开始插槽，即eSco即时即时之后的两个，四个或六个时隙被保留，不应用于其他流量。多槽数据包在一个方向使用时，eSCO窗口如图8.10所示，单槽数据包用于另一个方向。

图8.10：不对称流量的eSCO窗口细节

eSCO窗口可能在主机上重叠，但不能在单个从站上重叠。

在保留时隙中，主机和从机只能在每个eSCO窗口的第一个传输时间内在其分配的时隙进行侦听和发送。
由于例如连接建立期间的时间关键信令而导致的间歇性失效是允许的。主机和从机都可以避免发送数据，并可分别使用POLL和NULL数据包。当主设备发送POLL报文而不是eSCO 3时隙报文时，或从站在保留的主从传输时隙中不接收到任何信息时，它将在同一时隙内开始任何传输，就好像主机发送协商包类型。例如，如果主机已经协商了一个EV5数据包，则从站将在以后传输三个时隙。如果主机不响应eSCO分组接收到从机传输，则会导致该分组的隐含NAK。重传窗口中从站的侦听要求与主动ACL逻辑传输相同。

### 8.6.4广播计划

微微网的主机可以向ASB逻辑传输的所有从站广播消息。ASB广播数据包应将LT_ADDR设置为全零。如果新的广播报文携带ASB-U数据，则其分段方式与ACL报文相同。因此，它应从携带L2CAP消息指示（LLID = 10b）开始的分组开始，并且可以跟随携带继续L2CAP消息指示（LLID = 01b）的分组。如果新的广播消息携带ASB-C数据，则不应将其分段，并由携带LMP消息指示（LLID = 11b）的单个报文组成。在任一情况下，主机可以执行这些分组中的每一个的多个重传以增加无差错传送的概率;另见第7.6.5节。

广播包不得在基带层确认。广播LT_ADDR应使用ptt = 0。
### 8.6.5角色切换

当使用角色切换时，有几种情况：

- 为了在加入现有微微网时使寻呼设备成为从设备，角色交换机是必需的，因为通过定义，寻呼设备最初是涉及寻呼机（主设备）和寻呼（从设备）设备的微微网的主设备。
- 角色切换是必要的，以便现有微微网中的从站设置一个新的微微网，其本身为主，并且原始微微网主机为从属。如果原始的微微网具有多个从属设备，则这意味着原始微微网主机的双重角色;它在新的微微网中成为奴隶，同时仍然保持原始的微微网作为主人。

在角色切换之前，如果存在加密，则应在旧的微微网中暂停或禁用。如果物理链路处于Sniff或Hold模式，或者具有任何同步的逻辑传输，角色交换机不得执行。

对于涉及角色切换的主机和从机，交换机会导致其TX和RX定时反转：TDD切换。另外，由于微微网参数是从主设备的蓝牙设备地址和时钟导出的，因此角色交换机固有地涉及微微网的重新定义：微微网交换机。新的微微网参数应从前者的设备地址和时钟中得出。

假设设备A成为主人;设备B是前主人。然后有两种选择：从设备启动角色交换机，或主机启动角色切换。链路管理器协议[第2卷] C部分，第4.4.2节介绍了这些备选方案。无论使用哪种替代方案，基带过程都是相同的。

要开始角色切换，从机A和主机B应使用前一跳频方案（仍然使用设备B的蓝牙设备地址和时钟）执行TDD切换，所以没有微微网切换。从机A发送的时隙偏移信息不得使用;当两个设备都切换到新的微微网并且设备B正在定位其相关窗口时，它被使用。设备A现在成为主设备，设备B为从设备。以前由设备A在其从站角色中使用的LT_ADDR现在应由从站B使用。

在TDD切换的时刻，设备A和B都将启动一个超时时间的定时器。一旦在TDD切换频道上从主机A接收到FHS分组，定时器将在从机B中停止。一旦接收到来自从站B的ID数据包，定时器就停止在主站A.如果新的连接TO过期，则主站和从站站点将返回到旧的微微网定时和AFH状态，占用主站和从站的旧角色。主站A使用“旧”微微网参数发送FHS数据包。FHS包头中的LT_ADDR应为设备A使用的前一个LT_ADDR。在FHS有效载荷中携带的LT_ADDR应为在新的微微网上操作时用于设备B的新LT_ADDR。在作为ID分组的FHS确认（由从机在旧的跳频序列上发送）之后，主机A和从机B将使用FHS所示的新的微微网的新通道参数，序列选择设置为基本频道跳频序列如果新主机具有启用AFH的物理链路，则在微微网切换之后，新主站负责控制其新从站的AFH操作模式。

由于新旧主机的时钟同步，所以发送到FHS有效载荷的时钟信息将在FHS分组传输开始时指示新主机的时钟。此外，在FHS分组中给出的时钟信息的1.25ms分辨率不足以对准两个微微网的时隙边界。先前由设备A发送的LMP消息中的时隙偏移信息将用于提供更准确的定时信息。时隙偏移指示旧的和新的微微网通道的主从插槽的开始之间的延迟。该定时信息的范围为0到1249？s分辨率为1？秒。与FHS包中的时钟信息一起使用，在确认FHS包之后切换到新主机的时间时，精确地定位相关窗口。

在接收到FHS分组确认之后，新的主机A将切换到其自己的定时，其中序列选择被设置为基本信道跳频序列，并且将发送一个POLL分组来验证交换机。主机和从机将在FHS分组确认时启动一个新的定时器，新的时间超出新连接。按照FHS包确认，该定时器的开始将与新微微网的第一主TX时隙边界的开始对齐。奴隶应该停止
定时器接收到POLL包;当POLL包被确认时，主机将停止定时器。从机应用任何类型的分组来确认POLL。一旦POLL数据包被从机接收到，任何挂起的AFH_Instant都将被取消。如果没有收到响应，主机将重新发送POLL数据包，直到达到新的连接。如果该定时器到期，则从机和主机都将使用旧的主机和从机角色返回到旧的微微网时序。定时器的到期还应恢复与AFH相关的状态（包括任何待处理的AFH_Instant），信道质量驱动数据速率（CQDDR，链路管理器协议[Vol 2] C部分，第4.1.7节）和功率控制（Link Manager Protocol [第2卷）C部分，第4.1.3节）。然后角色切换过程可以从TDD交换机重新启动。将定时器与新的微微网的TX边界对齐，确保没有设备在主RX插槽中间返回到旧的微微网定时。

在角色切换之后，ACL逻辑传输被重新初始化，就像它是一个新的连接一样。例如，新的微微网通道上包含CRC的第一数据包的SEQN应根据7.6.2节的规定进行设置。

### 8.6.6 Scatternet

多个微微网可以覆盖相同的区域。由于每个微微网具有不同的主机，所以微微网独立地跳跃，每个微控制器具有由相应的主机确定的它们自己的跳频序列和相位。另外，信道上携带的分组之前还有主设备地址确定的不同的信道接入码。随着更多的微微子被添加，碰撞的概率增加;在跳频扩频系统中常见的性能结果的平稳降级。

如果多个微微网覆盖相同的区域，则设备可以通过应用时间复用来参与两个或更多个重叠微微网。要参与正确的信道，它将使用相关的主设备地址和适当的时钟偏移来获得正确的相位。一个设备可以作为几个微微网中的从站，但只能作为单个微微网中的主站：由于具有相同主站的两个微微网同步并使用相同的跳频序列，它们是同一个微微网。一组在不同微微网之间存在连接的微微网被称为散点网络。

通过由另一个微微网的主机分页，主机或从机可以成为另一个微微网中的从机。另一方面，参与一个微微网的设备可以访问另一个微微网的主机或从机。由于寻呼设备始终作为主机启动，因此如果需要从站角色，则需要主从角色交换机。这在第8.6.5节中有描述。

#### 8.6.6.1 Inter-Piconet Communications

必须使用时间复用来在微微网之间切换。设备可以实现通过使用嗅探模式或通过保留在主动ACL连接中实现分散网所必需的时间复用。对于在连接状态下设备为从设备的微微网中的ACL连接，可以选择不在每个主插槽中侦听。在这种情况下，应该认识到，如果从站不存在足以匹配从站的主轮询，则此链路上的服务质量会突然降级。类似地，在设备为主设备的微微网中，它可以选择不在每个主插槽中传输。

在这种情况下，很重要的是尽可能地尊重Tpoll。嗅探模式下的设备可能有足够的时间访问嗅探插槽之间的另一个微微网。当设备是使用嗅探模式的从站并且没有足够的空闲时隙时，设备可以选择不监听sniff_attempts周期中的所有主传输时隙，或者在随后的sniff_timeout周期期间。在嗅探插槽期间不需要主机传输，因此对于分散网络具有灵活性。如果建立了SCO或eSCO链路，则其它微微网只能在保留时隙之间的非保留时隙中被访问。这只有在使用HV3数据包或eSCO链路的单个SCO逻辑传输时才可能，其中至少四个时隙保留在保留时隙之间。由于多个微微网不同步，所以必须保留时间来解决不对准问题。这意味着只有2个时隙可以有效地用于访问HV3数据包之间的另一个微微网。

由于不同微微网的两个主器件的时钟不同步，所以参与两个微微网的从器件应保持两个偏移量，这些偏移量加到其自己的本机时钟上以创建两个主时钟。由于两个主时钟独立漂移，从机必须定期更新偏移量，以保持与主机同步。

### 8.6.7跳频序列切换

跳频序列适配由主机控制，可以设置为启用或禁用。一旦启用，跳频序列适配将适用于物理链路上的所有逻辑传输。一旦启用，主机可以周期性地更新所使用和未使用的信道的集合，以及禁用物理链路上的跳频序列适配。当主机具有多个物理链路时，每个链路的状态与所有其他物理链路无关。

当启用跳跃序列适配时，将序列选择跳选择内核输入设置为适配的信道跳频序列，并将AFH_channel_map输入设置为适当的已使用和未使用的信道集合。另外，应使用相同的通道机构。当使用所有通道启用跳跃序列适配时，这被称为AHS（79）。

当跳序适应被禁用时，跳选择核心的序列选择输入被设置为基本信道跳频序列（在这种情况下，AFH_channel_map输入未被使用），并且不使用相同的信道机制。

当主机发送LMP_set_AFH PDU并接收到基带确认时，跳转序列适配状态将被改变。当在跳频序列切换瞬间之前接收到基带确认时，AFH_Instant（参见链路管理器协议[第2卷第C部分，第4.1.4节]），跳频序列如图8.11所示进行。

图8.11：成功的跳频序列切换

当在AFH_Instant之前没有接收到基带确认时，主机将使用没有通过确认响应的从机的恢复跳序列（这可能是因为从机没有听到主机传输或主机没有听到听到奴隶的传播）。当启用或禁用跳序列适配时，恢复序列应为LMP_set_AFH PDU中指定的AFH_channel_map。当AFH_channel_map正在更新时，主机将选择一个恢复序列，其中包括标记为旧AFH_channel_map（例如AHS（79））中使用的所有RF通道。一旦接收到基带确认，主器件将使用LMP_set_AFH PDU中的AFH_channel_map，从下次发送到从器件开始。见图8.12。

图8.12：恢复跳序列

当AFH_Instant发生在由主机发送的多时隙分组时，从机将使用与多时隙分组开始时使用的主机相同的跳频序列参数。一个例子如图8.13所示。在该图中，基本信道跳频序列被指定为f。第一适配信道跳频序列用f'指定，第二适配信道跳频序列被指定为f“。

图8.13：主站发送的多时隙数据包中的AFH_Instant发生变化

### 8.6.8频道分类和频道映射选择

RF频道被分类为未知，坏或好。这些分类由主机和从机根据本地信息单独确定（例如主动或被动信道评估方法或通过主机通过HCI）。通过LMP从其他设备接收的信息（例如，来自主设备的AFH_channel_map或来自从站的信道分类报告）不应包含在设备的信道分类中。

三种可能的信道分类应如表8.6所定义。

分类
定义
未知

如果通道评估测量不足以可靠地对通道进行分类，并且通道在最近的HCI Set_AFH_Channel_Classif中不被标记为坏，则通道应分类为未知。

坏

如果与其相关联的ACL或同步吞吐量失败测量超过阈值（由所采用的特定信道评估算法定义），则信道可能被分类为坏。

如果与其相关联的干扰电平测量（确定链路对附近的其他系统造成的干扰等级）已经超过阈值（由所使用的特定信道评估算法定义），则信道也可能被分类为坏。

当最近的HCI Set_AFH_Channel_Classification被标记为坏时，通道应被分类为坏

好

如果通道不是未知或不良，则应将其分类为良好。
表8.6：频道分类说明

具有AFH启用物理链路的主机将基于以下信息的任何组合来确定每个此类链路的AFH_channel_map（两个或更多链接可能使用相同的映射）：

- 来自本地测量的信道分类（如控制器中的主动或被动信道评估），如果支持并启用。主机可以使用HCI Write_AFH_Channel_Assessment_Mode命令启用或禁用本地测量，HCI功能规范[Vol 2] E部分7.3.54节中定义了HCI。
- 主机使用HCI Set_AFH_channel_classification命令的信道分类信息，如HCI存在，在HCI功能规范[第2卷] E部分7.3.46节中定义。在AFH_Host_Channel_Classification中最近分类为不良的通道应在AFH_channel_map中标记为未使用。
- 从LMP_channel_classification PDU中的从站接收的信道分类报告，在LMP规范[Vol 2] C部分4.1.5中定义。

主机组合这些信息源并生成AFH_channel_map的算法在规范中没有定义，并且将具体实现。在2.3.1节中定义的通道数量不得小于Nmin。

如果主机确定应使用所有通道，则可以使用79个已使用通道（即AHS（79））的AFH_channel_map来启用AFH操作。

对于支持同步列车子系统的所有设备（见第8.11.2节），用于同步列车的RF信道索引（见第2.6.4.8节）在所有逻辑链路的AFH_channel_map中都应标记为未使用。

### 8.6.9电源管理

提供功能以允许低功耗操作。这些特征在处理数据包时处于微观层面，在使用某些操作模式时处于宏观层面。

#### 8.6.9.1数据包处理

为了最小化功耗，在TX和RX侧都能最大限度地减少数据包处理。在TX侧，仅通过发送有用的数据来最小化功率。这意味着如果只需要交换链路控制信息，则可以使用NULL数据包。如果没有要发送的链路控制信息，或者如果传输仅涉及NAK（NAK在无应答时是隐含的），则不需要传输。如果有要发送的数据，则必须调整有效载荷长度，以便只发送有效的数据字节。在RX侧，分组处理在不同的步骤中进行。如果在搜索窗口中没有找到有效的访问代码，收发器可能会返回睡眠状态。如果找到访问代码，接收机设备将开始处理数据包头。如果HEC发生故障，设备可能会在报文头后返回休眠状态。一个有效的标题指示有效载荷是否跟随，以及涉及多少个时隙。

#### 8.6.9.2插槽占用率

如第6.5节所述，分组类型表示分组可能占用多少个时隙。分组报头中未被寻址的从站可以为分组占用的剩余时隙进行休眠。这可以从TYPE代码读取。

#### 8.6.9.3低功耗操作的建议

降低功耗的最常用和最灵活的方法是使用嗅探。保留也可以通过持续期间的反复协商来使用。

#### 8.6.9.4增强的数据速率

由于能够以更少的数据包或相同（或类似的）数据包发送给定数量的数据，而是具有较短的有效载荷，因此增强型数据速率提供了省电功能。

### 8.6.10微微网时钟调整

主人可以在存在微微网的过程中使用两种机制来调整微微网时钟：粗调时钟调整和时钟拖动。两种机制可以在同一微微网内使用。

#### 8.6.10.1粗调时钟调整

主机通过选择一个调整时刻（clk_adj_instant）来进行粗略的时钟调整，该调整时刻（clk_adj_instant）将是主从到时隙，调整量，然后通过发送LMP_clk_adj将这些参数广播到所有从站（见[Vol 2] C部分，第4.1.14.1节）。调整量被指定为两个值：clk_adj_slots，它是clk_adj_instant处的CLK [27：1]值的变化，clk_adj_us，它是旧的主插槽开始之间的微秒数时钟（CLKold）和新时钟（CLKnew）域。

主人应为每个从属机构提供使用LMP_clk_adj_ack确认调整的机会（见[第2卷] C部分，第4.1.14.1节）。如果主机接收到的任何其他数据包超过LMP_clk_adj_ack与当前的clk_adj_id，它应该轮询从站更多次，直到接收到预期的确认或从机响应一个NULL数据包。如果任何从站不承认调整，主站将开始粗调时钟调整恢复模式（见第8.6.10.2节）。

当clk_adj_instant发生时，主器件会将（clk_adj_slots * 625 + clk_adj_us）μs添加到time_base_offset中，从器件将向slave_offset添加相同的量。如果在多时隙分组期间发生clk_adj_instant，则调整将被延迟，直到下一个主从到时隙的开始。如果角色切换在clk_adj_instant之前成功，则应丢弃等待的粗调时钟调整。调整的效果是设备将使用从clk_adj_instant开始的新时钟域。

图8.14显示了正时钟调整的示例。在此示例中，clk_adj_instant设置为时隙12（其在旧时钟域），clk_adj_slots设置为6，clk_adj_us设置为400。时间向前移动clk_adj_slots * 625 + clk_adj_us = 6 * 625 + 400 = 4150μs。新时钟域中的初始时隙为CLKnew [27：1] = clk_adj_instant + clk_adj_slots = 12
+ 6 = 18。这是一个偶数值，所以第一个插槽是一个主插槽。积极的
clk_adj_us意味着第一个时隙被假定为在clk_adj_instant之前启动了clk_adj_us，因此在该时刻之后仍然保留625 - clk_adj_us = 225μs。由于传输不能通过一个插槽部分启动，所以该部分插槽不可用。clk_adj_instant之后的第一个完整插槽是可以用于例如eSCO的从插槽。如果clk_adj_slots是一个奇数，则第一个完整的插槽将是主插槽。这个例子中的第一个完整的主插槽发生在CLKnew [27：1] = 20。


图8.14：正粗调时钟调整

图8.15显示了负时钟调整的示例。在此示例中，clk_adj_instant再次设置为时隙12，clk_adj_slots设置为0，clk_adj_us设置为-400。时间被clk_adj_slots * 625 + clk_adj_us = 0 * 625 +（-400）= -400μs移动，向后400μs。CLKnew域中的初始时隙为CLKnew [27：1] = clk_adj_instant + clk_adj_slots = 12 + 0 =
12。这是一个偶数值，所以第一个插槽是一个主插槽。负clk_adj_us表示在clk_adj_instant之后，CLKnew域中的第一个插槽启动clk_adj_us。CLKnew域中的第一个时隙和clk_adj_instant（在这种情况下为400μs）之间的时间实际上是前一个时隙的延续，即使其数量发生变化，因此也是不可用的。（当clk_adj_us为负数时，即使clk_adj_slots不为零也是如此）。

图8.15：负粗略时钟调整

如果clk_adj_us为零，则调整将更改插槽编号，而不是插槽开始的实际时间。因此，所有插槽仍然可用，尽管如果clk_adj_slots为奇数，则将有两个连续的从插槽。

#### 8.6.10.2粗调时钟调整恢复模式

在粗调时钟调整恢复模式下，主机进入同步训练子模块（见8.11.2节）。主机应保留在该子状态中，并发送同步列数据包，直到所有从机都已使用LMP_clk_adj_ack PDU确认调整，或者对于最后一个无响应从站的链路监视超时已过期。主机可以取消粗调时钟调整恢复模式，以启动另一个粗调时钟调整或任何其他原因。在粗调时钟调整恢复模式下，主机将继续播放LMP_clk_adj PDU（参见[[Vol 2] C部分，第4.1.14.1节）。

当从站不检测到其主站的任何传输时，可能会进入同步扫描子站（见第8.11.1节）并扫描
同步火车包，如第2.7节所述。TSync_Scan_Window应该被设置得足够大，以便能够接收至少一个同步
火车包由于粗略的时钟调整，可能已经失去与主机的连接的从机应优先考虑同步扫描。

接收与其主机的BD_ADDR同步列表分组的从机将更改slave_offset的值，使CLK对应于数据包的内容，然后退出同步扫描子状态。如果新时钟在CLKOLD-LSTO到CLKOLD（包括LSTO）的范围内
链接监督超时期限），则视为负数
更改。在这种情况下，从机不应发送任何数据包，并且不应忽略所有接收到的定向数据包，直到CLK的值在更改后严格地大于上一次发送或接收（如果适用）数据包时的CLK值。如果新时钟超出该范围，那么这个时钟将被视为一个积极的变化（因此可能涉及一个时钟包装）。

#### 8.6.10.3时钟拖曳

时钟拖曳意味着主机定期调整其time_base_offset（见第2.2.4节），直到完成所需的时间调整。

每个单独的调整应由主机到每个从机的有向分组和来自每个从机的响应（例如基带确认）来执行。如果从站不响应，则主机应暂停更新time_base_offset（但应继续轮询该从站），直到每个从站都响应或至少未响应至少为CLK_adj_dragTO为止。如果多个从站无法响应，主机应确保每个故障从站获取至少一个CLK_adj_dragTO以进行响应（这些可能为多个从站并发）。在该从站的链路监视超时期间，主机不需要允许任何给定从站的多个暂停的CLK_adj_dragTO。

单次调整应小于或等于3μs。在125ms的任何时间段内，单个方向的总调整应小于或等于5μs。注意：这些要求适用于对time_base_offset的更改，并应用于主机参考时钟的精度（见第1.1节）。这意味着从机可能会观察到CLK大于20ppm的变化。

如果主机在启动粗调时钟调整，新的时钟拖动或包含即时或定时控制标志的序列时执行时钟拖动，或者从从机接收请求以启动此类序列，则它将中止当前时钟在处理新请求或执行序列之前拖动。如果主器件在CLK_adj_dragTO期间暂停了时钟拖动，它将拒绝新的请求，直到由于从机响应或超时时间到期而取消超时。

### 8.6.11插槽可用性掩码（SAM）

插槽可用性掩码（SAM）允许两个蓝牙设备彼此指示其发送和接收时隙的可用性。从基带的角度来看，SAM提供了一个映射 - SAM插槽映射 - 标志着蓝牙插槽的可用性。可用性来自外部条件（例如，MWS共存）或内部条件（例如，对于星际分布的拓扑管理）。SAM插槽图使用[Vol 2] C部分5.2节中定义的四种类型代码中的一个标记每个插槽，并为了方便起见，重复表8.7。

表8.7：SAM插槽类型

注意：主机可以标记可用于接收的主机到从机时隙和可用于传输的从主机到主机时隙，因为这样的时隙可以以这种方式用于多时隙分组;类似于奴隶。所有插槽设置为类型3的SAM插槽映射相当于不使用SAM并执行正常调度。

图8.16显示了SAM插槽图的示例。主机到从机插槽用字母“M”和从属主机插槽标有字母“S”。

图8.16：SAM插槽图的示例

SAM插槽图具有有限的长度，无限期重复，直到相关的LMP程序改变为止。SAM锚点以TSAM的间隔规则地间隔开，以时隙为单位。在相邻的SAM锚点之间，
时隙映射表示设备何时能够发送和接收。SAM
时隙映射有效地重复每个TSAM直到它被改变。

SAM间隔TSAM进一步被划分为相等长度的TSAM-SM的NSAM-SM子间隔，使得TSAM = TSAM-SM * NSAM-SM。 TSAM-SM应为一个偶数整数，以便包含TX / RX插槽对。

将使用“SAM子映射”（或者当从上下文中没有歧义时简单地“子映射”）来表示TSAM-SM时隙的子间隔。每个子图被分配在[第2卷]部分C中定义的四种使用类型之一，
第5.2节，为方便起见重复表8.8。

表8.8：SAM子图类型

SAM设施以子地图粒度指定每个SAM插槽图。图8.17显示了本地设备中的子地图方面的SAM插槽图的示例。每个框代表TSAM-SM插槽的子间隔
框上的标签指示子图的类型。请注意，在子图上
粒度级别，发送和接收等级相同。差异只会出现在类型为0的子地图中。

图8.17：根据本地设备子图中的SAM插槽图的示例

除了SAM插槽映射之外，控制器还维护单个“SAM类型0子映射”，用于指定显示为类型0的那些子映射的单个插槽的可用性。然后，控制器将子地图粒度的SAM插槽映射与类型0子映射的第一个TSAM-SM条目组合，以生成有效映射。图8.18显示了SAM插槽图和SAM类型0子图以及生成的有效图。

图8.18：组合SAM插槽图和SAM类型0子图的示例

图8.19显示了并置MWS的SAM类型0子地图的示例。

图8.19：具有并置MWS的蓝牙设备上的SAM类型0子图的示例

该示例中的假设是，为了防止蓝牙和MWS无线电之间的相互干扰，在MWS下行链路持续时间期间蓝牙传输不可用，并且在MWS上行链路持续时间期间蓝牙接收不可用。MWS帧长度为10 ms，SAM类型0子地图需要具有相同的长度，因此TSAM-SM为16。

图8.20显示了在MWS上行链路中具有低流量负载的并置蓝牙设备的另一个示例。在这种情况下，实现选择标记可用于TX和RX的MWS上行链路部分，因为它们很有可能接收主分组并在没有来自MWS的干扰的情况下对其进行响应。

图8.20：具有低上行链路流量负载的并置MWS的蓝牙设备上的SAM类型0子映射的示例

SAM允许每个设备向其他设备发送其本地时隙可用性，在这种情况下，插槽的可用性取决于组合的时隙映射。关于这种SAM时隙映射的调度建议将在第8.6.11.2节中进行描述。

支持SAM功能的设备应能够存储每个连接的远程设备的三个不同的SAM插槽图。一个远程设备只能定义一个类型0的子地图，可以通过任何一个定义的SAM插槽映射来引用它。远程设备可以随时重新定义其类型0子地图。

#### 8.6.11.1 SAM锚点

SAM时隙映射是周期性的，由间隔TSAM和偏移DSAM定义。图8.21显示了设计用于对应于周期性MWS主动和不活动周期的SAM插槽图的示例。

图8.21：周期性MWS活动和非活动周期的SAM插槽图的示例

SAM锚点是SAM插槽图中第一个插槽的起始点。使用当前主时钟从TSAM和DSAM计算SAM锚点，这是两个设备都已知的。第一个SAM锚点是
由SAM_Instant指示。为了防止由时钟回绕引起的问题，LMP消息携带附加的定时控制标志，指示是否使用初始化过程1或2。当当前主时钟（CLK27）的MSB为0时，启动设备应使用初始化1;当当前主时钟（CLK27）的MSB为1时，应使用初始化2。响应设备应用初始化标志指示的初始化方法。SAM锚点应在时钟满足适用方程的时隙上进行初始化：

CLK27-1 mod TSAM =用于初始化的DSAM 1
（CLK 27，CLK26-1）mod TSAM =用于初始化的DSAM 2

初始化后，通过将固定间隔TSAM加到当前锚点的时钟值，可以找到下一个SAM锚点的时钟值CLK（k + 1）：

CLK27-1（k + 1）= CLK27-1（k）+ TSAM

SAM锚点应为主从从槽。作为推论，每个SAM子映射的第一个插槽也是一个主从从插槽。

#### 8.6.11.2 SAM计划

SAM使每个设备能够将其本地插槽可用性发送到另一个设备。蓝牙控制器中的调度程序应考虑来自本地和远程设备的SAM插槽映射以进行分组调度。使用SAM信息的唯一效果是限制设备的传输和接收机会。

对于重传窗口中的所有ACL数据包和eSCO数据包：

1。如果所需的主从从站插槽在主机的SAM插槽图中被标记为可用于传输，并且可以在从站的SAM插槽图中进行接收，主设备才应该发送一个数据包。
2。如果所需的插槽在主机的SAM插槽图中被标记为可用于接收，并且可以在从机的SAM插槽图中进行传输，则从机应该只传输分组。
3。从机可能选择不主机在从主机到从机插槽中监听，这些插槽被标记为不能在主机的SAM插槽图中传输，或者在从机的SAM插槽图中无法接收。

对于所有ACL数据包，如果紧随主数据包之后的插槽被标记为可用于在从站的SAM插槽图中进行传输并且可以在主站的SAM插槽图中进行接收，则主站应仅传输数据包。

对于重传窗口中的eSCO数据包，主机只能传输数据包：

紧随主器件包之后的插槽被标记为可用于在从机的SAM插槽图中传输，并可在主机的SAM插槽图中进行接收;
这是主机在这个重传窗口中发送这个数据包的最后机会。要么
3.对于同一重传窗口中为主机发送相同数据包提供足够剩余时隙的所有后续主从从时隙，本节中的规则说明主机不应发送数据包。

在SCO和eSCO保留时隙中，主机或从机可以选择不传输SCO或eSCO包，除非所需的插槽被标记为可用于本地SAM插槽映射中的传输，并可在远程SAM插槽图中进行接收。

下面的图8.22说明了从主站和从站组合SAM槽位图可能的调度结果。

图8.22：来自主站和从站组合SAM槽位图的可能调度结果示例

## 8.7 SNIFF MODE

在嗅觉模式下，可能会减少从机在微微网中的活动的占空比。如果从站在ACL逻辑传输中处于活动模式，则它将在每个ACL时隙监听主流量，除非该链路被视为分散网络链路或由于保持模式而不存在。使用嗅探模式，从机正在侦听的时隙减少，因此主机只能在指定的时隙内传送到从机。嗅探锚点定期与Tsniff间隔隔开。


图8.23：嗅探锚点

从机侦听从主机到从机的传输时隙从嗅探锚点开始。应使用以下规则来确定是否继续收听：

- 如果小于Nsniff，则从嗅探锚点开始，主从传输槽已经过去，则从站将继续监听。
- 如果从站在上一个Nsniff超时主机到从站传输时隙中接收到具有包含ACL数据（DM，DH，DV或AUX1数据包）的匹配LT_ADDR的数据包，则它将继续侦听。
- 如果从站已经在前面的Nsniff超时从站到主站传输槽中发送了包含ACL数据（DM，DH，DV或AUX1报文）的数据包，则它将继续监听。
- 如果从站在上一个Nsniff超时主站到从站传输槽中接收到具有匹配的LT_ADDR的任何数据包，则它可以继续监听。
- 设备可以覆盖上述规则，并在Nsniff超时之前停止侦听，或者如果其他微微网具有活动，则其余的Nsniff尝试插槽。

来自一个嗅探超时的活动可能延伸到下一个嗅探锚点。任何来自先前嗅探超时的活动不会影响下一个嗅探锚点之后的活动。因此，在上述规则中，只考虑自上一个嗅探锚点以来的时隙。
请注意，Nsniff attempt = 1，Nsniff timeout = 0会使从机只在从sniff锚点开始的时隙侦听，而不管从主机接收到的数据包。

Nsniff attempt = 0不得使用。

嗅探模式仅适用于异步逻辑传输及其关联的LT_ADDR。嗅觉模式不适用于同步逻辑传输，因此主机和从机仍然要遵循同步链路的保留时隙和重传窗口。

要进入嗅探模式，主机或从机应通过LM协议发出嗅探命令。该消息包括嗅探间隔Tsniff和偏移量Dsniff。另外，初始化标志指示是否使用初始化过程1或2。当当前主时钟（CLK27）的MSB为0时，器件应使用初始化1;当当前主时钟（CLK27）的MSB为1时，应使用初始化2。从机将应用初始化标志所指示的初始化方法，而不管其时钟位值CLK27如何。由主机和从机决定的嗅探锚点应在时钟满足适用公式的时隙上进行初始化：

CLK27-1 mod Tsniff = Dsniff进行初始化1


（CLK27，CLK26-1）mod Tsniff = Dsniff进行初始化2这意味着Dsniff必须是均匀的

初始化后，下一个嗅探锚点的时钟值CLK（k + 1）应通过将固定间隔Tsniff与当前嗅探锚点的时钟值相加：

CLK27-1（k + 1）= CLK27-1（k）+ Tsniff

### 8.7.1嗅探转换模式

嗅觉转换模式是在嗅觉和活动模式之间转换期间使用的特殊模式。这是必需的，因为在这个转换期间，不清楚从机的哪个模式（Sniff或Active），并且有必要确保从机被正确轮询，而不考虑它的模式。

在嗅探转换模式下，主机将保持主动模式轮询间隔，以防从机处于主动模式。此外，主机将在嗅探尝试中至少一次轮询从站，从每个嗅探锚点开始传输时隙。请注意，此传输也计数用于活动模式轮询。在嗅觉转换模式下，主机应使用其高功率精确时钟。

主进入嗅觉转换模式的精确情况在[第2卷] C部分4.5.3.1中定义。

### 8.7.2嗅觉覆盖

当链路管理器启用嗅探子速率时，设备在嗅探模式和嗅探子速率模式之间交替显示。嗅觉加速模式允许设备使用少量的嗅探锚点。设备将根据嗅探模式超时值从嗅探模式转换到嗅探子模式（参见第8.7.2.1节）。当从远程设备接收到ACL-U，ASB-U，ACL-C或ASB-C数据时，设备将从嗅探子速率模式转换到嗅探模式。

图8.24：嗅觉加速

嗅觉子模式中的从设备在发送需要确认的数据包之后也应暂时进入嗅探模式，直到接收到基带确认。

注意：一旦启用嗅觉子速率，主设备和从设备可能在不同时间处于嗅探模式或嗅觉子速率模式。第8.7.2.2节中定义的规则描述了两个设备如何保持同步并可靠地交换数据。

#### 8.7.2.1嗅探模式超时

每当包含ACL-U，ASB-U，ACL-C或ASB-C数据的数据包被嗅探子模式下的设备接收时，它将转换到嗅探模式，重新启动嗅探模式超时，所有嗅探锚点直到最小数量的时隙等于接收的min_sniff_mode_timeout已过期。如果在接收到最后一个ACL-U，ASB_U，ACL-C或ASB-C数据之前，从min_sniff_mode_timeout时隙之前接收到ACL-U，ASB_U，ACL-C或ASB-C数据，则重新启动超时。NULL和POLL数据包不包含ACL或ASB数据，不得重新启动嗅探模式超时。

请注意，有两种嗅探模式超时值：一种用于本地设备，一种用于远程设备。

#### 8.7.2.2嗅觉遮罩模式

当嗅探模式超时到期时，设备将进入sniff子速率模式。在嗅觉子速率模式下，主机必须发送到主机的强制嗅探子固定点，从机应监听主机，定义如下（其中M为主机接收的最大子速率，N为接收到的最大子速率通过从机，A是嗅觉子速率，k是任何正整数）：

表8.9：嗅探子固定点

1注：??X ？？表示数学“floor”函数，相当于舍入到最接近的整数。因此，??X / Y？产生最高的整数j，其中Y - j？X 。
2注意：当启用嗅觉子速率时，第8.7节中针对Nsniff尝试和Nsniff超时指定的规则应适用于嗅探子加速点。

## 8.8保持模式

在CONNECTION状态下，可以将从属的ACL逻辑传输置于保持模式。在保持模式下，从站暂时不支持通道上的ACL数据包。在保留同步时隙（来自SCO和eSCO链路）的任何同步报文都应该被支持。使用保持模式，可以自由地执行扫描，寻呼，查询或参加另一个微微网的其他操作。处于保持模式的设备也可以进入低功耗睡眠模式。在保持模式期间，从设备保持其逻辑传输地址（LT_ADDR）。

在进入保持模式之前，主器件和从器件同步从器件保持在保持模式的持续时间。定时器应该用holdTO值初始化。当定时器到期时，从机将唤醒，同步到通道上的流量，并等待进一步的主站传输。

## 8.9本部分不再使用


## 8.10无连续顺序广播模式

在无连接从广播模式下，主机将数据包广播到零个或多个从站。

主机可以在无连接从属广播模式下向多个从站广播消息。为此，主机应保留仅由无连接从站广播流量使用的LT_ADDR。在无连接从广播模式下，主设备以指定的间隔发送数据包。

### 8.10.1无连接从播广播发送操作

在无连接从广播模式下，主设备在主机到主机传输时隙中以主机所要求的间隔在CSB逻辑传输上发送分组。

如果主机尚未向BR / EDR控制器提供要启用广播的任何数据包传输，或者数据长度为零，BR / EDR控制器将传送NULL数据包。这与主机自启用广播以来提供数据但自从以前的广播数据包不提供新数据的情况不同。在这种情况下，BR / EDR控制器会重新发送最新数据。

主机可以通过HCI命令提供无连接从播播数据。由于HCI命令限制为255字节，因此单个命令不能携带较大数据包允许的最大有效负载，例如DH5。因此，用于无连接从播广播的HCI命令允许在HCI级别上分散大的有效载荷。BR / EDR控制器应在发送前组装数据包的所有HCI片段，不得发送不完整的数据包。在这种装配完成之前，控制器应继续传送先前的数据（如果有的话）。

无连接从播广播数据包的时序如图8.25所示。

图8.25：无连接从站广播时序

无连接从站广播实例由无连接从属广播间隔（TConnectionless_Slave_Broadcast）分隔。无连接从播广播间隔可以是从0x0002到0xFFFE插槽的任何偶数值
在CSB设置期间在BR / EDR控制器和主机之间协商。在每个无连续从播广播即时的开始，使用适配的微微网物理信道来发送无连接从播广播分组。无连接从广播数据包不得加密。
在CSB_supervisionTO时隙不通过无连接从广播数据包之后，主机将停止发送无连接从属广播数据包。CSB_supervisionTO可以是从0x0002到0xFFFE插槽的任何偶数值。由于来自较高优先级的流量的调度冲突，无连接从站广播数据包可能无法发送一段连续的时间段。

### 8.10.2无连接从播广播接收操作

在无连接从属广播模式中，从机与无连接从广播发射机同步，并且正在接收由主机为CSB逻辑传输保留的LT_ADDR上的配置文件广播数据。
当请求同步建立时，主机向控制器提供主站的时钟偏移量和从同步列车接收到的下一个无连接从站广播时刻。由于主机的延迟，过去可能发生无连接从播广播即时。BR / EDR控制器过去至少需要1秒钟支持无连接从属广播时钟。从机应通过使用主机的时钟偏移量和自己的时钟来确定无连接从动广播瞬时是否在过去或将来，以估计当前主时钟并从下一个广播时刻开始侦听。

Skip参数由主机设置，并指定接收方在成功接收无连接从播广播数据包后可能跳过的连续无连接从属广播时刻的数量。如果无连接从广播数据包成功接收，则有效载荷数据将转发给主机。如果在无连接从播广播瞬发期间由从设备接收到无连接从播广播数据包，则从站将忽略“跳过”，而是在每个调度的无连接从站广播瞬间监听，直到能够成功接收到无连接从属广播数据包或直到CSB_supervisionTO数槽已经过去了

在CSB_supervisionTO时隙通过后，BR / EDR控制器将停止监听无连接从广播数据包，而不接收无连接从播广播数据包。

BR / EDR控制器可以通过HCI事件将无连接从播播数据传送到主机。因为HCI事件被限制在255字节，所以接收到的分组可能或不适合于单个HCI事件。BR / EDR控制器应使用多个HCI事件来分片和传输这些数据包。

### 8.10.3无连接从播广播中的AFH

无连接从广播数据包应在适配的微微网通道上传输，并且同步列应始终包含PBD逻辑链路的当前AFH信道图。

## 8.11同步建立物质

### 8.11.1同步扫描子

同步扫描子状态由从站使用以从微微网主设备接收同步列车数据包。可以从STANDBY或CONNECTED状态输入同步扫描子状态。在同步扫描子状态中，设备使用同步扫描过程（参见第2.7.3节）。在每个同步扫描窗口期间，设备将以与主信道接入码（CAC）匹配的相关器在单个频率上进行监听。

如果在同步扫描过程中相关器超过触发阈值，扫描设备将接收同步列表数据包，其内容如表8.10所示。在接收到同步列车数据包后，设备将退出同步扫描子状态，并适当返回到STANDBY或CONNECTED状态。如果未收到数据包，则设备应该保留在同步扫描子状态中。如果sync_scanTO在接收到同步列车分组之前过期，则设备将返回到STANDBY状态。尝试与无连接从属广播传输同步的设备将忽略其有效载荷中的无连接从属广播LT_ADDR字段设置为零的任何同步列分组。

同步扫描可能被较高优先级的流量中断。特别地，保留的同步时隙应具有比同步扫描更高的优先级。

### 8.11.2同步火车子体

同步训练子状态由微微网的主机使用以发送同步训练分组。可以从STANDBY或CONNECTED状态输入同步列表。在同步列车中，设备使用同步列车程序（见2.7.2节）。在同步列车过程中，主机在第2.6.4.8节中指定的频道上重复发送同步列表数据包。在同步训练中，

- 如果启用无连接从播广播模式，则主机除了同步列车数据包之外还将继续发送无连接从属广播数据包;
- 如果主机处于粗调时钟调整恢复模式，则它将继续在所有有效逻辑传输上发送和接收所有已经确认粗调时钟调整的从站（见[第2卷第C部分，第4.1.14.1节]）。

保留的SCO和eSCO插槽的优先级要高于同步列。一旦主机进入同步训练子状态，它将保持在同步训练子状态中，直到sync_trainTO到期或者否则主机指示。当退出同步训练子状态时，主机将转换到STANDBY或CONNECTED状态。

同步列表分组是类型DM3和LT_ADDR为零的基本速率ACL分组。FLOW，ARQN和SEQN都应在传输时设置为零，并在收到时忽略。HEC LFSR应使用主UAP进行初始化。在有效载荷报头中，LLID应包含值10b（L2CAP消息的开始或不分段）。有效载荷报头中的流量在传输时应设置为零，并在接收时忽略。有效载荷体长度（LENGTH）应为28字节。CRC LFSR应使用主UAP进行初始化。不使用数据白化。不使用加密

有两种可能的格式。当使用无连接从属广播模式的微微网主机的设备发送同步列时，应使用格式1，否则使用格式2。同步列中使用的DM3分组的有效载荷部分的格式如表8.10所示。

表8.10：同步列车分组有效载荷体

当使用格式1时，主机提供同步列车分组有效载荷主体的服务数据。BR / EDR控制器提供所有其他字段的数据。

同步扫描子站中的所有设备都应接收任何长度为28到121个字节的负载，并忽略字节28（从...开始计数）
0）及以上。

当使用格式1时，同步列分组有效载荷中的未来无连接从属广播即时对应于接下来的4个广播时刻之一。图8.26显示了此字段的有效值和无效值的示例。

图8.26：指向无连接从站广播即时的同步列车示例

主机不得在无连接从属广播瞬发中发送同步列车数据包。

＃9音频

在空中接口上，可以使用64kb / s的日志PCM（脉冲编码调制）格式（A律或λ-daw），或者可以使用64kb / s的CVSD（连续可变斜率增量调制） 。后一格式应用具有音节压扩的自适应增量调制算法。

线路接口上的语音编码被设计为具有等于或优于64kb / s日志PCM质量的质量。

表9.1总结了空中接口支持的语音编码方案。在链路管理器协商后选择适当的语音编码方案。

表9.1：空中接口支持的语音编码方案

## 9.1 LOG PCM编解码器

由于空中接口上的同步逻辑传输可以支持64kb / s的信息流，所以可以使用64kb / s的日志PCM流量进行传输。可以应用A律或σ-压缩。如果线路接口使用A律并且空中接口使用？-law或反之亦然，则将执行从A律到α-lo的转换。压缩方法应遵循ITU-T建议G. 711。

## 9.2 CVSD编解码器

通过空中接口的语音更强大的格式是增量调制。该调制方案遵循波形，其中输出位指示预测值是否小于或大于输入波形。为了减少斜率过载效应，应用音节式压扩：根据平均信号斜率调整步长。CVSD编码器的输入应为64 ksamples / s线性PCM（通常为16位，但实际值为实现特定）。CVSD编码器和CVSD解码器的框图如图9.1，图9.2和图9.3所示。系统的时钟频率应为64 kHz。

图9.1：具有音节压扩的CVSD编码器框图


图9.2：具有音节压扩的CVSD解码器框图

图9.3：累加器程序


令sgn（x）= 1为x ??0，否则sgn（x）= -1。在空中这些数字应由符号位表示;即负数映射到“1”，正数映射到“0”。

表示CVSD编码器输出位b（k），编码器输入x（k），累加器内容y（k）和步长α（k）。此外，令h为累加器的衰减因子，表示步长的衰减因子，作为音节压缩参数。后一参数通过考虑K个最新的输出位来监视斜率


让（EQ 14）

然后，CVSD编码器内部状态应根据下列方程组进行更新：

（EQ 15）

（EQ 16）

（EQ 17）

（EQ 18）

（EQ 19）


在这些方程式中？分和？max是最小和最大步长，ymin和ymax分别是累加器的负和正饱和度值。在空中，这些位应按照相同的顺序发送
由CVSD编码器生成。

对于64kb / s的CVSD，应使用表9.2所示的参数。数字是基于从累加器输出的16位有符号数字。
这些值导致累加器衰减的时间常数为0.5 ms，步长衰减为16 ms的时间常数

表9.2：CVSD参数值。这些值基于累加器的16位有符号数字输出


## 9.3错误处理

在DV，HV3，EV3，EV5，2-EV3，3-EV3，2-EV5和3-EV5数据包中，语音不受FEC保护。在易出错的环境中，语音质量取决于语音编码方案的稳健性，而在eSCO的情况下，则取决于重传方案。特别地，CVSD对随机位错误不太敏感，随机位错误经历了白色背景噪声。然而，由于通道访问码，HEC测试不成功或CRC失败，当数据包被拒绝时，必须采取措施“填写”丢失的语音段。

HV2和EV4数据包中的语音有效负载由2/3速率FEC保护。对于检测到但无法校正的错误，接收机应尽量减少听觉效果。例如，从具有未校正错误的15位FEC段中，应该使用在FEC解码器之前找到的10位信息部分。HV1数据包由3位重复FEC保护。对于该代码，解码方案将总是假定为零或一位错误。因此，HV1分组不存在可检测但不可校正的错误事件。

## 9.4一般音频要求

### 9.4.1信号电平

对于A律和？对数PCM编码信号，信号电平的要求应遵循ITU-T建议G.711。

在CVSD编码器的16位线性PCM接口处的全摆幅定义为3 dBm0。

### 9.4.2 CVSD音频质量

对于蓝牙音频质量，要求放在发射机侧。64 ksamples / s线性PCM输入信号应具有高于4 kHz的可忽略的光谱功率密度。在64 ksamples / s线性PCM输出处，解码信号的4-32 kHz频带中的功率谱密度应在0-4 kHz范围内比最大值低20 dB。

＃附录一般音频推荐

A.1最大声压

每个制造商有责任以安全的方式设计他们的音频产品，以免对人耳造成伤害。蓝牙规范没有规定音频设备的最大声压。

A.2其他电话网络要求

设计蓝牙音频产品是每个制造商的唯一责任，使其符合可能连接到的所有电话网络的法规要求。

A.3蓝牙音频水平

音频电平应计算为发送响度等级，SLR和接收响度等级RLR。计算方法在ITU-T P.79建议书中规定。

ITU-T P.51和P.57建议书描述了手机和耳机的物理测试设置

ITU-T P.34建议书规定了免提电话的物理测试设置和“车载免提系统”。

ITU-T建议P.79给出了电话机响度等级（LR）计算的一般方程式，由...给出

wi =加权系数（不同的LR）。

Si =频率Fi，电声路径N1，N2，连续滤波器组号的灵敏度（Art。指数：200-4000Hz）

（EQ 20）用于根据图A.1和（RLR）计算（SLR），如图A.2所示。在计算LR时，必须只包括发生实际信号传输的频段的那些部分，以确保保留LR的附加属性。因此ITU-T
P.79在LR计算中仅使用200-4000Hz的频段。

A.4麦克风路径

SLR测量模型

图A.1：SLR测量设置

A.5扬声器路径


RLR测量模型

图A.2：RLR测量设置

A.6蓝牙语音接口

蓝牙语音接口的规范首先应遵循ITU-T建议书P.79，其中规定了电话机的响度等级。这些建议给出了用于计算相对于耳参考点（ERP）的音频信号的响度等级的一般准则和具体算法。

对于不同蜂窝系统终端的蓝牙语音接口，应使用基于蜂窝标准的响度和频率推荐。例如，GSM 03.50给出了与蓝牙GSM终端互连的响度等级和频率掩码的推荐。

1- CVSD解码器的输出是16位线性PCM数字采样，采样频率为8 ksample / s。蓝牙还支持A-law和？-law类型的8位日志PCM样本。对于给定的16位CVSD样品，耳参考点的声压应符合蜂窝标准规范中给出的声压级。

2-在CVSD解码器的输出端可以由16位线性PCM采样表示的最大声压应根据ITU P.79中的响度等级和PGA值为0 dB来指定。可编程增益放大器（PGA）用于控制用户在终端的音频电平。为了在各种PCM表示之间进行转换：A-law，？-law和线性PCM，ITU-T G.711，G.712，G.714给出了指导原则和PCM值关系。也建议使用基于ITU-T G.711的零码抑制来避免网络不匹配。

A.7 FREQUENCY MASK

为了将蓝牙终端与数字蜂窝移动终端进行接口，推荐CVSD解码器信号与蜂窝标准中给出的频率掩码的一致性，以保证语音编码器的正确功能。以下表A.1给出了频率掩模的建议。下面的图A.3显示了蓝牙频率掩码（实线）的图表。GSM频率屏蔽（虚线）如图A.3所示进行比较。

图A.3：蓝牙推荐频率屏蔽图。给出GSM发送频率掩码进行比较（虚线）

表A.1：推荐的蓝牙频率屏蔽

表A.1：推荐的蓝牙频率屏蔽

＃附录B定时器


本附录包含与本规范中定义的不活动超时相关的基带定时器列表。定时器的定义和默认值列在下面所有定时器值都在插槽中给出。

B.1定时器列表

### B.1.1 inquiryTO

查询定义了查询子状态持续的时隙数。主机可以更改定时器值。HCI提供更改定时器值的命令。

### B.1.2 pageTO

page_L定义当extended_pa​​geTO为零时，页面子状态可以在收到响应之前持续的时隙数。主机可以更改定时器值。HCI提供更改定时器值的命令。

### B.1.3 extended_pa​​geTO

extended_pa​​geTO定义了在接收到响应之前页面子状态可以超出pageTO的附加插槽的数量。主机可以更改定时器值。HCI提供更改定时器值的命令。

### B.1.4 pagerespTO

在从站中，它定义了发送页面确认ID数据包后，从站等待主站的响应（FHS数据包）的时隙数。在主机中，pagerespTO定义主机在返回页面子状态之前应等待FHS分组确认的时隙数。主设备和从设备都应该为此超时使用相同的值，以确保在达到pagerespTO之后的常见页面/扫描间隔。

pagerespTO值为8个插槽。

### B.1.5 newconnectionTO

每次通过分页，扫描或角色切换启动新的连接时，主机将发送一个POLL数据包作为新连接中的第一个数据包。该POLL数据包的传输和确认用于确认新的连接。如果从站不接收到POLL分组，或者主机没有接收到响应分组用于新连接的时隙数量，主机和从机应返回到前一个子状态。

newconnectionTO值是32个插槽。

### B.1.6监督

主机和从机都使用监控模式来监控链路丢失。如果设备没有收到任何通过HEC检查的数据包，并且在监视时间段内具有正确的LT_ADDR，则应重置链路。监控定时器保持运行在保持模式和嗅探模式。

主机可以更改监视点值。HCI提供更改定时器值的命令。在基带级别，应使用相当于20秒的默认值。

### B.1.7 CSB_supervisionTO

从站使用CSB_supervisionTO来监控连接丢失，并由主机监视调度冲突，并且范围为0x0002至0xFFFE，只有偶数值有效。在基带级别，应使用相当于5.12秒的默认值。主机可以更改CSB_supervisionTO的值。

### B.1.8 synchronization_trainTO

master_trainTO由master使用，以确定继续广播Synchronization Train数据包的时间，并且范围为0x00000002到0x07FFFFFE，只有偶数值有效。在基带级别，应使用等于120秒的默认值进行无连接从属广播，并应使用相当于20秒的默认值进行粗调时钟调整恢复模式。主机可以更改在无连接从播广播期间使用的synchronization_trainTO的值。

### B.1.9 synchronization_scanTO

从机使用synchronization_scanTO来确定何时停止扫描同步列车数据包。它的范围是0x0022到0xFFFE，只有偶数值有效。在基带级别，无连接从属广播应使用相当于5.12秒的默认值，而在粗调时钟调整恢复模式下应使用相当于20秒的默认值。主机可以更改在无连接从动广播期间使用的synchronization_scanTO的值。

### B.1.10 authenticatedPayloadTO

authenticatedPayloadTO是接收包含MIC的数据包之间允许的最大时间（秒）。主机可以更改authenticatedPayloadTO的值。

authenticatedPayloadTO的默认值为30秒。

### B.1.11 CLK_adj_dragTO

CLK_adj_dragTO是在主器件拖动时钟后从机未响应时，最小暂停时间（以秒为单位）。

CLK_adj_dragTO值应为1秒。


＃附录C AFH建议书

操作保持，SNIFF和CSB连接无故障广播

在保持模式和嗅觉模式下，AFH能力的从站的三种可能的AFH操作模式与连接状态期间使用的三种AFH操作模式相同：

- 启用（使用没有使用某些RF通道的AHS）
- 启用（使用AHS（79））
- 禁用

主机可以将AFH功能的从机置于三种AFH操作模式中的任何一种。

C.1主要操作

具有一个或多个从站保持或嗅探并决定同时更新的主站应该安排一个AFH_Instant一段时间，允许它使用新的适配器更新所有这些从站（以及其活动从站）。

具有非重叠“唤醒”时间的多个从站（例如具有不同时序参数的嗅探模式的从站）的主站可以在相同的适配条件下使其启用，只要其AFH_Instant的调度允许足够的时间更新它们。

这个时机总结在下图中。在这个例子中，主机决定需要同时应用于其所有从机的跳频序列自适应。然而，它不能安排AFH_Instant，直到它通知其活动从站，其从站处于保持状态，并且其从站处于嗅探状态。

如果它决定只有一些从站需要新的适配，那么在安排AFH_Instant时，只需要考虑这些从站。

图C.1：AFH_Instant中的时间限制，从站处于保持和嗅探

C.2 [本部分不再使用]

C.3 SNIFF中的AFH操作

一旦从机被置于嗅探模式，主机可能会定期更换其AHS，而不使从机从嗅觉模式中移除。

C.4 AFH操作保持

处于保持模式的从站不能发送或接收任何LMP消息。一旦从机已经保持模式，主机可以随后更新从站的适配。

C.5 AFH操作在连续的SLAVE BROADCAST中

主机的BR / EDR控制器通知主控主机PBD逻辑链路AFH通道映射已更改后，主机主机可以重新启动同步列，以允许从站获取更新的AFH通道映射。这在下面的MSC中显示。

图C.2：AFH地图更改 - 无连接从站广播主站

AFH频道映射的修改将影响使用不同AFH频道映射的从站。根据从站的当前AFH通道映射与主站的当前AFH通道映射之间的重叠，从站可能会错过一些无连接从站广播时刻，并且在不相交或几乎不相交的AFH通道映射的情况下，从站可能会失去同步。

如果降级超过所需阈值，从站应监视无连接从站广播接收速率并获取主站（通过同步列）的当前AFH信道映射。