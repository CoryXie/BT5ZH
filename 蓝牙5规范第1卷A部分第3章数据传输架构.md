# 蓝牙5规范第1卷A部分第3章数据传输架构

标签（空格分隔）： Bluetooth

---

# 3 数据传输架构

蓝牙数据传输系统遵循分层架构。 蓝牙系统的描述描述了直到并包括L2CAP信道的蓝牙核心传输层。 所有蓝牙操作模式都遵循相同的通用传输体系结构， 如图3.1所示。

![图3.1：蓝牙通用数据传输架构](http://upload-images.jianshu.io/upload_images/3764796-aa4812e9e4a63dda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

为了效率和遗留原因，蓝牙传输架构包括逻辑层的子划分，区分逻辑链路和逻辑传输。 该子部分提供了在两个或更多个设备之间提供独立传输的逻辑链路的通用（且通常被理解）的概念。 需要逻辑传输子层来描述一些逻辑链路类型之间的相互依赖关系（主要是由于传统行为的原因）。

在版本1.2之前，蓝牙核心规范将ACL和SCO链路描述为物理链路。 随着扩展SCO（eSCO）的添加和未来的扩展，最好将它们视为逻辑传输类型，更准确地封装其目的。 然而，由于它们共同使用诸如LT_ADDR和确认/重复请求（ARQ）方案之类的资源，它们不是可能需要的独立的。 因此，架构不能用单个传输层来表示这些逻辑传输。 额外的逻辑传输层在描述这种行为方面有一些方法。

## 3.1 核心流量承载

蓝牙核心系统为服务协议和应用数据的传输提供了许多标准流量承载。 这些在下面的图3.2中示出（为了便于表示，以右侧的左侧和下侧的较高层示出）。

![图3.2：蓝牙流量承载](http://upload-images.jianshu.io/upload_images/3764796-2c6b523a7b9c7fa3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

可用于应用程序的核心流量承载如图所示
3.2 作为阴影的圆角矩形。 定义为提供这些服务的体系结构层在第2节中描述。 多个数据流量类型显示在链接到通常适合于传输该类型的数据流量的流量承载的图表的左侧。

逻辑链路使用关联的逻辑传输的名称和指示传输的数据类型的后缀来命名。 （C表示携带LMP或LL消息的控制链路，U表示承载用户数据的L2CAP链路（L2CAP PDU），S表示携带未格式化的同步数据或同步数据的流链路）。通常将后缀从逻辑链路中删除而不引入歧义，因此，在讨论LMP协议的情况下，引用缺省ACL逻辑传输可以解析为ACL-C逻辑链路，正在讨论LL协议的情况下的LE-C逻辑链路，AMP- C逻辑链路在PAL的情况下正在讨论协议，或者正在讨论L2CAP层时的ACL-U，LE-U或AMP-U逻辑链路。

图3.2中的应用流量类型映射到蓝牙核心流量承载基于流量特性与承载特性的匹配。 建议使用这些映射，因为它们提供了使用其给定特征传输数据的最自然和最有效的方法。

然而，应用（或蓝牙核心系统的实现）可以选择使用不同的业务承载或不同的映射来实现类似的结果。 例如，在仅具有一个从站的BR / EDR微微网中，主站可以选择通过ACL-U逻辑链路而不是ASB-U逻辑链路传输L2CAP广播。 这可能在带宽方面更有效（如果物理信道质量不会太差）。 如果保留了应用程序流量类型的特性，则只能使用图3.2中的替代传输路径。

图3.2 显示了一些应用程序流量类型。 这些用于对可能提交给蓝牙核心系统的数据类型进行分类。 原始数据流量类型可能与提交到蓝牙核心系统的类型不同，如果中介过程修改它。 例如，以恒定速率生成视频数据，但是中间编码处理可以将其改变为可变速率，例如通过MPEG4编码。 为了蓝牙核心系统的目的，只有提交的数据的特征是令人感兴趣的。

### 3.1.1 帧数据流量

L2CAP层服务为异步和等时用户数据提供面向帧的传输。 应用程序以可变大小的帧（最多达到通道的协商最大值）向该服务提交数据，并且这些帧以相同的形式传送到远程设备上的相应应用程序。 不需要应用程序将额外的成帧信息插入到数据中，尽管如果需要（蓝牙核心系统不可见，则可能会这样做）。

可以创建面向连接的L2CAP通道，用于在两个蓝牙设备之间传输单播（点对点）数据。 面向连接的通道提供了一个上下文，其中特定属性可以应用于在通道上传输的数据。 例如，可以应用服务质量参数或流量和错误控制模式。 使用L2CAP连接程序创建面向连接的L2CAP通道。

无连接的BR / EDR L2CAP通道用于广播数据或传输单播数据。 在微微网拓扑的情况下，主设备始终是广播数据的来源，从设备是接收者。 无连接L2CAP通道上的广播流量是单向的。 在无连接L2CAP信道上发送的单播数据可以是单向或双向的。 在L2CAP上发送的单播数据无连接通道提供了一种替代机制，发送的数据具有与在基本模式下工作的L2CAP面向连接的通道相同的可靠性水平，但没有通过打开L2CAP面向连接的通道引起的额外的延迟。 不支持LE L2CAP无连接通道。

BR / EDR L2CAP信道具有相关联的QoS设置，其定义了数据帧传送的约束。 这些QoS设置可以用于指示（例如）数据是同步的，因此具有有限的寿命，之后它变得无效，或者在给定的时间段内应该传送数据，或者数据是可靠的，并且应该交付没有错误，不管多长时间。

当建立ACL-U和/或LE-U逻辑链路时，一些L2CAP信道是固定信道。 这些固定信道具有固定信道标识符和固定配置，并且在配置创建后不允许协商。 这些固定信道用于BR / EDR和LE L2CAP信令（ACL-U或LE-U），无连接信道（ACL-U和ASB-U），AMP管理协议（ACL-U），安全管理器协议（LE- U），属性协议（ACL-U或LE-U）和AMP测试管理器（ACL-U）。

L2CAP信道管理器负责安排在适当的基带逻辑链路上传输L2CAP信道数据帧，可能将其复用到具有相似特性的其他L2CAP信道的基带逻辑链路上。

### 3.1.2 非数据流量

如果应用程序不需要以帧的形式传送数据，可能是因为它包括流内成帧，或因为数据是纯流，则可以避免使用L2CAP通道并直接使用基带逻辑链路。

蓝牙核心系统支持使用SCO-S或eSCO-S逻辑链路直接传输同步和恒定速率的应用数据（用于预置数据的比特率或帧速率）。 这些逻辑链路保留物理信道带宽并提供锁定到微微网时钟的恒定速率传输。数据在固定大小的数据包中以固定的时间间隔传送，这两个参数在通道建立期间协商。 eSCO链路提供更多的比特率选择，并通过在发生错误的情况下使用有限的重传来提供更高的可靠性。 eSCO支持增强数据速率操作，但不支持SCO逻辑传输。 SCO和eSCO逻辑传输不支持多路复用的逻辑链路或蓝牙内核中任何进一步的分层。 应用程序可以选择在提交的SCO / eSCO流中分层多个流，只要提交的流是或具有恒定速率流的外观即可。

蓝牙核心系统还支持使用配置文件广播数据（PBD）逻辑链路直接传输应用数据。 该逻辑链路类似于SCO-S和eSCO-S，因为它保留物理信道带宽，提供固定速率传输锁定到微微网时钟，并以固定的间隔传输数据。 它不支持复用的逻辑链路或蓝牙内核中的任何进一步分层，但与SCO-S和eSCO-S不同，它支持从单个发射机向许多接收机广播数据。

应用程序从基带中可用的逻辑链路选择最合适的类型，并创建并配置它来传输数据流，并在完成后释放。 （该应用通常还将使用成帧的L2CAP单播信道将其C平面信息传输到远程设备上的对等应用）。

如果应用数据是同步的且具有可变速率，那么这只能由L2CAP单播信道承载，因此将被视为成帧数据。

LE系统不支持未格式化的数据流量。

### 3.1.3 交通承担者的可靠性

#### 3.1.3.1 BR / EDR可靠性

蓝牙是一种无线通信系统。 在恶劣的RF环境中，这个系统应该被认为是内在的不可靠的。 为了抵消这一点，系统在每个层提供了一定程度的保护。 基带分组报头使用前向纠错（FEC）编码，以允许接收机进行纠错和报头错误检查（HEC）来检测校正后剩余的错误。 某些基带分组类型包括有效载荷的FEC。 此外，一些基带分组类型包括循环冗余错误检查（CRC）。

在ACL逻辑传输中，错误检测算法的结果用于驱动简单的ARQ协议。 这通过重新发送不通过接收机的错误检查算法的分组来提供增强的可靠性。 如果数据包的使用寿命已经过期，可以通过在发射机处丢弃未成功发送的数据包来修改此方案来支持延迟敏感数据包。 eSCO链接使用该方案的修改版本，通过允许有限数量的重传来提高可靠性。

由此ARQ方案获得的可靠性仅与HEC和CRC码检测错误的能力一样可靠。 在大多数情况下，这是足够的，但是已经表明，对于较长的数据包类型，未检测到的错误的概率太高，无法支持典型应用程序，特别是那些传输大量数据的应用程序。

L2CAP层提供了额外的错误控制级别，其设计用于检测基带层中偶然的未检测到的错误并请求重传受影响的数据。 这提供了典型蓝牙应用所需的可靠性水平。

广播链路没有反馈路由，并且不能使用ARQ方案（尽管接收机仍然能够检测接收到的分组中的错误）。 相反，每个数据包被多次传输，希望接收机能够成功地接收至少一个副本。 尽管采用这种方法，仍然没有保证成功收到，所以这些链接被认为是不可靠的。

总而言之，如果链路或信道被表征为可靠的，则这意味着接收机能够检测接收到的分组中的错误并请求重传，直到错误被去除。 由于错误检测系统使用的一些残留（未检测到）错误可能仍然保留在接收的数据中。 对于L2CAP通道，这些级别与其他通信系统相当，尽管对于逻辑链路，残余错误级别稍高。

发射机可以从发射队列中去除分组，使得接收机不接收序列中的所有分组。 如果发生这种情况，将丢失的数据包的检测委托给L2CAP层。

在不可靠的链路上，接收机能够检测接收到的报文中的错误，但不能请求重传。 接收器传递的数据包可能没有错误，但不能保证序列中的所有数据包都被接收。 因此，该链接被认为是根本不可靠的。 这些链接的用途有限，这些用途通常取决于来自较高层的数据的连续重复，同时它们是有效的。

流链路在可靠和不可靠的链路之间具有可靠性特征，这取决于当前的操作条件。

#### 3.1.3.2 LE可靠性

像BR / EDR一样，在恶劣的RF环境中，LE系统应该被认为是内在的不可靠的。 为了抵消这一点，系统在每层提供了一定程度的保护。 LL分组使用24位循环冗余错误检查（CRC）来覆盖分组有效载荷的内容。 如果CRC验证在分组有效载荷上失败，则分组不被接收器确认，并且分组被发送者重传。

广播链路没有反馈路由，并且不能使用确认方案（尽管接收机仍然能够检测接收到的分组中的错误）。 相反，每个数据包被多次发送，以增加接收机能够成功接收至少一个拷贝的概率。 尽管采用这种方法，仍然没有保证成功收到，所以这些链接被认为是不可靠的。

总而言之，如果链路或信道被表征为可靠的，则这意味着接收机能够检测接收到的分组中的错误并请求重传，直到错误被去除。

在不可靠的链路上，接收机能够检测接收到的报文中的错误，但不能请求重传。 接收器传递的数据包可能没有错误，但不能保证序列中的所有数据包都被接收。 因此，该链接被认为是根本不可靠的。 这些链接的用途有限，这些用途通常取决于来自较高层的数据的连续重复，同时它们是有效的。

#### 3.1.3.3 AMP可靠性

每个AMP的可靠性取决于底层的MAC / PHY技术。 某些AMP仅在标记为可刷新时刷新用户流量，而其他AMP可以刷新用户流量。

蓝牙核心通过强制对AMP上使用的任何L2CAP通道强制使用增强型重传模式或流式传输模式，来保持Core上方协议和配置文件的可靠性。

## 3.2 运输建筑实体

蓝牙传输架构实体如图3.3所示，并在后续部分中从最低层向上描述。

![图3.3：传输架构实体和层次结构概述](http://upload-images.jianshu.io/upload_images/3764796-7dde2dfe6bacd6fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

BR / EDR物理传输封装BR / EDR物理信道。 使用BR / EDR物理传输的传输使用BR / EDR通用分组结构。 LE物理传输封装了LE物理通道。 使用LE物理传输的传输使用LE通用分组结构。

### 3.2.1 BR / EDR通用分组结构

通用分组结构几乎反映了蓝牙BR / EDR系统中的架构层。 BR / EDR分组结构设计用于在正常操作中的最佳使用。 如图3.4所示。

![图3.4：BR / EDR包结构](http://upload-images.jianshu.io/upload_images/3764796-b1dda3010d309650.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

数据包通常只包含用于表示事务所需的层所必需的字段。 因此，通过查询扫描物理信道的简单查询请求不产生或要求逻辑链路或更高层，因此仅由信道访问码（与物理信道相关联）组成。

所有数据包都包括通道访问代码。 这用于识别特定物理信道上的通信，并排除或忽略恰好在物理接近的正在使用相同RF载波的不同物理信道上的数据包。

BR / EDR分组结构中没有直接字段表示或包含与物理链路有关的信息。 该信息由分组报头中承载的逻辑传输地址（LT_ADDR）和信道访问码（CAC）的组合所暗示。

大多数BR / EDR分组包括分组报头。 数据包头部始终存在于支持物理链路，逻辑传输和逻辑链路的物理信道上发送的数据包中。 分组报头携带LT_ADDR，由每个接收设备使用，以确定分组是否寻址到设备，并用于在内部路由分组。

BR / EDR分组报头还承载了每个逻辑传输操作的链路控制（LC）协议的一部分（除了运行在逻辑传输上携带的共享LC协议的ACL和SCO传输之外）。

增强数据速率（EDR）数据包在有效载荷之前具有保护时间和同步序列。 这是用于物理层改变调制方案的领域。

有效载荷头部存在于支持多个逻辑链路的逻辑传输上的所有数据包中。 有效载荷报头包括用于路由有效载荷的逻辑链路标识符字段和指示有效载荷主体的长度的字段。 一些分组类型还包括用于检测接收到的分组中的大多数错误的分组有效载荷的末尾的CRC。 当启用AES-CCM加密时，ACL分组在CRC字段之前包括消息完整性检查（MIC）。

EDR数据包在CRC之后有一个尾随。

数据包有效载荷主体用于传输用户数据。 该数据的解释取决于逻辑传输和逻辑链路标识符。 对于ACL逻辑传输，链路管理器协议（LMP）消息和L2CAP信号在分组有效载荷体中传送，以及来自应用的一般用户数据。

对于SCO，eSCO和CSB逻辑传输，有效载荷主体包含逻辑链路的用户数据。

### 3.2.2 LE通用分组结构

LE无线电操作基于三个PHY并且使用两种调制方案。 表3.1总结了每个LE PHY的属性。 发送的每个数据包使用单个PHY。 每个PHY使用单个调制方案。 两个PHY未被编码 - 也就是说，每个位直接映射到分组中的单个无线电符号 - 而第三个PHY被纠错编码。 有两种编码方案：S = 8和S = 2，其中S是每位的符号数。

![表3.1：PHY的总结，调制方案和编码方案](http://upload-images.jianshu.io/upload_images/3764796-ef6890873189ab7a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

表3.1中所指的“接入报头”包括在PDU报头开始之前与特定PHY相关联的分组格式中的所有比特，但不包括前导码。 排除前导码，因为对于所有的PHY，这是未编码的。

表3.1中所指的“有效载荷”包括从PDU头到分组结束的分组格式的所有比特。

链路层空中接口分组的一般结构紧密反映了LE系统中发现的架构层次。 LE无编码PHY的分组结构设计用于在正常操作中的最佳使用， 如图3.5所示。

![图3.5：LE未编码PHY的分组结构](http://upload-images.jianshu.io/upload_images/3764796-7cbe1cd809752072.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

LE编码PHY的分组结构设计用于扩展范围操作中的最佳使用， 如图3.6所示

![图3.6：LE编码PHY的分组结构](http://upload-images.jianshu.io/upload_images/3764796-269b88e22cbbf943.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

当使用LE编码PHY时，建议仔细考虑无线电接入时间对功耗和占空比的影响，以便调度和共存在空中。 具有S = 8编码（125kb / s）的LE编码PHY代表最坏的情况，当考虑无线电接通时间和占空比时，其中每个通过空中发送的分组将比LE 1M大约8倍。

表3.2 说明了具有不同大小的AdvData的广告事件的播出时间。 第一个是使用可连接和可扫描的无向广告事件，其中AdvData在主要广告渠道上发送。 第二个是使用AdvData被卸载到辅助广告渠道的事件。 第3.3.2.2节介绍了主要和次要广告渠道的使用情况 。 括号中的数字是假设的，并显示在兼容实现中无效的情况。

![表3.2：各种广告事件的播出时间](http://upload-images.jianshu.io/upload_images/3764796-cd303d150a42ed90.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

注意：没有卸载的事件是使用三个ADV_IND PDU进行计算的，而卸载的事件使用三个仅包含AuxPtr和ADI字段的ADV_EXT_IND PDU加上一个AUX_ADV_IND PDU，并且存在AdvData和ADI字段并保存AdvData。

表3.3 对于一些有效载荷大小的范围，说明了在具有S = 8编码的LE 1M PHY和LE编码PHY上的连接的链路层数据信道PDU数据包持续时间的差异。 可以从该信息容易地计算具体实现的连接占空比。

![表3.3：各种数据通道数据包的通话时间](http://upload-images.jianshu.io/upload_images/3764796-4e2eefabb6a4c0aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
![表3.3：各种数据通道数据包的通话时间](http://upload-images.jianshu.io/upload_images/3764796-d74f4cdd78ffb17f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

物理链路标识符不包含在链路层空中接口报文中。 物理信道标识符是固定的，在连接建立时确定，或者是在定期的广告设置中确定的。 所有LE包都包含访问地址。 这用于识别物理信道上的通信，并排除或忽略在物理接近的正在使用相同PHY信道的不同物理信道上的数据包。 接入地址确定分组是否被引导到用于非周期性广告的广告物理信道（以及因此广告物理链路），用于周期性广告的周期性物理信道，或微米网物理信道（以及因此主动物理信道链接到设备）。 用于非定期广告的LE广告物理频道使用固定的访问地址。 用于周期性广告的LE周期性物理信道和LE微微网物理信道使用随机生成的32位值作为其接入地址。 这提供了大量周期性广告和可以在LE周期性广告或LE微微网中寻址的大量有源设备。

所有LE分组包括PDU报头。 PDU报头确定通过物理信道承载的广告广播或逻辑链路的类型。

对于广告信道PDU，PDU报头包含广告有效载荷的类型，广告中包含的地址的设备地址类型和广告信道PDU有效载荷长度。 大多数广告渠道PDU有效载荷包含广告客户的地址和广告数据。 一个广告渠道PDU有效载荷仅包含广告主的设备地址和广告所针对的发起者的设备地址。 具有扫描请求有效载荷的广告渠道PDU包含扫描仪的设备地址和广告客户的设备地址。 具有扫描响应的广告渠道PDU包含广告客户的设备地址和扫描响应数据。 具有连接请求有效载荷的广告渠道PDU包含发起者的设备地址，广告商的设备地址和连接设置参数。

对于数据信道PDU，PDU报头包含逻辑链路标识符（LLID），下一个预期序列号（NESN），序列号（SN），更多数据（MD）和有效载荷长度。 对于包含控制命令的数据信道PDU，数据信道PDU有效载荷包含命令操作码和特定于该命令的控制数据。 有一个可选的消息完整性检查（MIC）值用于认证数据PDU。 对于作为数据的数据信道PDU，数据信道PDU有效载荷包含L2CAP数据。

## 3.3 物理通道

定义了多种类型的物理通道。 所有蓝牙物理通道的特征在于一组PHY频率与时间参数相结合，并受到空间考虑的限制。 对于基本和适应的微微网物理信道，跳频用于周期性地改变频率以减少干扰的影响并且由于监管的原因。

蓝牙BR / EDR系统和LE系统在使用物理通道的方式略有不同。

### 3.3.1 BR / EDR物理频道

在BR / EDR核心系统中，对等设备使用共享物理信道进行通信。 为了实现这一点，它们的收发器需要同时调整到相同的PHY频率，并且它们需要在彼此的标称范围内。

鉴于RF载波的数量是有限的，并且许多蓝牙设备可以在相同的空间和时间区域内独立地操作，所以存在两个独立的蓝牙设备将其收发器调谐到相同RF载波的强烈可能性，导致物理信道碰撞。 为了减轻这种冲突的不必要的影响，物理信道上的每个传输都以接入码开始，该接入码被调谐到物理信道的设备用作相关码。 该通道访问代码是物理通道的属性。 访问代码存在于每个发送的数据包的开始处。

定义了几个BR / EDR物理通道。 每个都被优化并用于不同的目的。 这些物理信道中的两个（基本微微网通道和适配的微微网通道）用于连接的设备之间的通信，并且与特定的微微网相关联。 其他BR / EDR物理通道用于发现（查询扫描通道）和连接（页面扫描通道）蓝牙设备。 设备使用同步扫描物理信道来获取关于无连接从属广播物理链路的定时和频率信息，或者恢复当前微微网时钟。

蓝牙设备在任何给定的时间只能使用一个BR / EDR物理通道。 为了支持多个并发操作，设备在通道之间使用时分复用。 以这种方式，蓝牙设备可以看起来在几个微微网中同时操作，以及可发现和可连接。

每当蓝牙设备与物理通道的定时，频率和访问代码同步时，它被称为“连接”到该通道（无论其是否积极地参与通道上的通信）。 蓝牙规范假设设备只能在任何时候连接到一个物理通道。 高级设备可能有能力同时连接到多个物理通道，但规范并不认为这是可能的。

#### 3.3.1.1 基本微微网通道

##### 3.3.1.1.1 概观

基本的微微网通道用于在正常操作期间连接的设备之间的通信。

##### 3.3.1.1.2 特点

基本微微网通道的特征在于通过PHY信道跳频的伪随机序列。 跳频序列对于微微网是唯一的，由主设备的蓝牙设备地址决定。 跳频序列中的相位由主机的蓝牙时钟决定。 参与微微网的所有蓝牙设备都与通道进行时间和跳跃同步。

信道被划分成时隙，其中每个时隙对应于PHY跳频。 连续跳数对应于不同的PHY跳频。 时隙根据微微网主机的蓝牙时钟进行编号。 分组由参与微微网的蓝牙设备发送，对齐以在时隙边界开始。 每个数据包以从微微网主机的蓝牙设备地址派生的通道访问代码开始。

在基本的微微网通道上，主控制器控制对通道的访问。 主机只在偶数时隙开始传输。 由主机发送的数据包与时隙开始对齐，并定义微微网定时。 由主机发送的报文可能占用多达五个时隙，具体取决于报文类型。

每个主传输是携带有关逻辑传输之一的信息的分组。 从设备可以在物理信道上进行响应。 响应的特征由所寻址的逻辑传输定义。

例如，在面向异步连接的逻辑传输（ACL）上，寻址的从设备通过发送包含与下一（奇数）时隙开始名义上对齐的相同逻辑传输的信息的分组进行响应。 取决于分组类型，这样的分组可以占用多达五个时隙。 在广播逻辑传输上，不允许任何从属应答。

##### 3.3.1.1.3 拓扑

基本的微微网通道可以被任何数量的蓝牙设备共享，仅由微微网主设备上可用的资源限制。 只有一个设备是微微网主，所有其他设备都是微微网从站。 所有沟通在主设备和从设备之间。 在微微网通道上的从设备之间没有直接通信。

然而，在微微网中可以支持的逻辑传输的数量有限制。 这意味着尽管对于共享频道的蓝牙设备的数量没有理论上的限制，但是与主机交换数据可能积极地涉及的这些设备的数量有限制。

##### 3.3.1.1.4 支持的层

基本的微微网通道支持用于通用通信的多个物理链路，逻辑传输，逻辑链路和L2CAP信道。

#### 3.3.1.2 改编微微网通道

##### 3.3.1.2.1 概观

适应的微微网通道与基本微微网通道有两种不同。 首先，从机发送的频率与其在前一个传输中的主机使用的频率相同。 换句话说，主器件和后续从器件数据包之间不会重新计算频率。 第二，适应的微微网通道可以基于少于全79频率。 可以通过标记为“未使用”从跳频图案中排除多个频率。 包括79个频率的其余部分。 这两个序列是相同的，除了每当基本的伪随机跳频序列选择未使用的频率时，它被替换为从使用的集合中选择的替代。 所使用的频率集可以在相同的适配微微网通道上的不同物理链路之间变化。

由于适配的微微网通道使用与基本微微网通道相同的定时和访问代码，所以两个通道上的物理链路通常是重合的。 这提供了故意的好处，因为它允许基本微微网通道或适配的微微网通道中的从站来调整与主机的同步。

适配的微微网物理信道的拓扑和支持的层与基本的微微网物理信道相同，但有一个例外：在适配的微微网物理信道上，单个主机可以使用单个CSB向无限数量的从设备发送数据逻辑运输。 然而，在这种情况下，数据只能从主机传输到从机，而不能从从机传送到主机。

#### 3.3.1.3 查询扫描频道

##### 3.3.1.3.1 概观

为了发现设备，使用查询扫描通道。 可发现的设备在其查询扫描通道上侦听查询请求，然后发送对该请求的响应。 为了使设备发现其他设备，它以伪随机的方式遍历所有可能的查询扫描信道频率，遍历（跳），在每个频率上发送查询请求并监听任何响应。

##### 3.3.1.3.2 特点

查询扫描通道遵循较慢的跳频模式，并使用访问代码来区分使用不同物理通道的两个同位置设备的相同射频的偶尔占用。

在查询扫描通道上使用的访问代码取自所有蓝牙设备共享的一组预留查询访问代码。 一个访问代码用于一般查询，并且有一些附加访问代码被保留用于有限的查询。 每个设备都可以访问多个不同的查询扫描通道。 由于所有这些信道共享相同的跳频模式，如果能够同时关联多于一个的访问码，则设备可以同时占用多于一个的查询扫描信道。

使用其查询扫描信道之一的设备在该信道上保持被动，直到其从另一蓝牙设备在该信道上接收到查询消息。 这通过适当的查询访问代码来标识。 查询扫描设备随后将遵循查询响应过程来向查询设备返回响应。

为了使设备发现其他蓝牙设备，它使用查询扫描通道发送查询请求。 由于没有设备发现的知识，它不能知道查询扫描通道的确切特性。

该设备利用这样的事实，即查询扫描信道具有减少的跳频数量和较慢的跳频速率。 查询设备在查询扫描跳频率的每一个上发送查询请求并收听查询响应。 传输速度更快，允许查询设备在相当短的时间内覆盖所有查询扫描频率。

##### 3.3.1.3.3 拓扑

查询和发现设备使用简单的数据包交换来完成查询功能。 在此事务期间形成的拓扑结构是一个简单且暂时的点对点连接。

##### 3.3.1.3.4 支持的图层

在查询和可发现的设备之间的分组交换期间，可以认为这些设备之间存在临时物理链路。 然而，这个概念是无关紧要的，因为它没有物理表示，只是设备之间的简单交易所暗示的。 没有其他架构层被认为被支持。

#### 3.3.1.4 页面扫描通道

##### 3.3.1.4.1 概观

可连接设备（准备接受连接的设备）使用页面扫描通道进行。 可连接设备在其页面扫描通道上侦听页面请求，一旦接收到，就进入与该设备的一系列交换。 为了使设备连接到另一设备，它以伪随机方式遍历所有页面扫描信道频率（跳），在每个频率上发送寻呼请求并收听响应。

##### 3.3.1.4.2 特点

页面扫描通道使用从扫描设备的蓝牙设备地址派生的访问代码来识别通道上的通信。 页面扫描通道使用比基本和适应的微微网通道的跳频更慢的跳频速率。 跳选择算法使用扫描设备的蓝牙设备时钟作为输入。

使用其页面扫描通道的设备保持被动，直到它从另一个蓝牙设备接收到页面请求。 这是通过页面扫描通道访问代码来标识的。 然后，两个设备将按照页面过程形成连接。 在页面程序的成功结束之后，两个设备切换到以寻呼设备为主的特征的基本微微网通道。

为了使设备连接到另一个蓝牙设备，它使用目标设备的页面扫描通道来发送寻呼请求。 如果寻呼设备不知道目标设备的寻呼信道的相位，则它不知道目标设备的当前跳频。 寻呼装置在每个寻呼扫频跳频上发送寻呼请求并收听寻呼响应。 这是以更快的跳频速率完成的，允许寻呼设备在合理的短时间内覆盖所有的页面扫描频率。

寻呼设备可以具有目标设备的蓝牙时钟的一些知识（在两个设备之前的先前的查询交易中指示，或者作为先前参与微微网与设备的结果），在这种情况下，能够预测目标设备的页面扫描通道的相位。 它可以使用该信息来优化寻呼和寻呼过程的同步，并加速连接的形成。

##### 3.3.1.4.3 拓扑

寻呼和可连接设备使用简单的数据包交换来实现寻呼功能。 在此事务期间形成的拓扑结构是一个简单且暂时的点对点连接。

###### 3.3.1.4.4 支持的层

在寻呼和可连接设备之间的分组交换期间，可以认为这些设备之间存在临时物理链路。 然而，这个概念是无关紧要的，因为它没有物理表示，只是设备之间的简单交易所暗示的。 没有其他架构层被认为被支持。

#### 3.3.1.5 同步扫描通道

##### 3.3.1.5.1 概观

为了接收在CSB逻辑传输上发送的分组，设备必须首先获得关于这些分组的定时和频率信道的信息。 如果设备缺少粗调时钟调整通知，则需要恢复当前的微微网时钟。 提供同步扫描通道用于这些目的。 扫描设备在同步扫描信道上侦听同步列车数据包。 一旦收到同步列车数据包，设备可能会停止监听同步列车包，因为它具有开始接收在CSB逻辑传输上发送的分组或恢复微微网时钟所必需的定时和频率信息。

##### 3.3.1.5.2 特点

同步扫描信道使用从同步列车发射机的蓝牙设备地址导出的接入码来识别信道上的同步列车分组。 一旦接收到同步列车数据包，扫描BR / EDR控制器可以根据主机的需要和任何适用的配置文件开始接收在CSB逻辑传输上发送的分组。

##### 3.3.1.5.3 拓扑

在此扫描期间形成的拓扑是瞬态和点对多点。 可以有无限数量的扫描设备同时从同一同步列车发射机接收同步列车分组。

##### 3.3.1.5.4 支持的层

存在从同步列车发送装置到扫描装置的分组的单向流。 这可以被认为是直到扫描设备接收到所需信息才存在的临时物理链路。 没有其他架构层被认为被支持。

### 3.3.2 LE物理频道

在LE核心系统中，两个蓝牙设备使用共享物理通道进行通信。 为了实现这一点，它们的收发器需要同时调整到相同的PHY频率，并且它们需要在彼此的标称范围内。

鉴于PHY信道的数量受到限制，并且许多蓝牙设备可以在相同的空间和时间区域内独立地操作，所以存在两对独立的蓝牙设备将其收发器调谐到相同PHY信道的强烈可能性，导致碰撞 与BR / EDR不同，其中使用访问代码来识别微微网，LE使用随机生成的访问地址来识别设备之间的物理通道。 在两个设备碰巧在同一区域共享相同PHY信道的情况下，目标设备接入地址被用作相关器，以确定通信所针对的设备。

定义了三个LE物理通道。 每个都被优化并用于不同的目的。 LE微微网通道用于连接设备之间的通信，并与特定的微微网相关联。 LE广告频道用于向LE设备广播广告。 这些广告可用于发现，连接或发送用户数据到扫描仪或启动器设备。 周期性物理信道用于以指定的间隔在周期性通告中向扫描仪设备发送用户数据。

在任何给定的时间，LE设备只能使用这些LE物理通道之一。 为了支持多个并发操作，设备在通道之间使用时分复用。 以这种方式，蓝牙设备可以出现以支持连接的设备，同时发送广告广播。

每当LE设备与物理信道的定时和频率同步时，它被称为与该信道连接或同步（无论其是否主动参与通道上的通信）。 蓝牙规范假设设备一次只能连接到一个物理通道。 高级设备可能能够同时连接或同步到多个物理通道，但是该规范并没有做出这一假设。

#### 3.3.2.1 LE微微网通道

##### 3.3.2.1.1 概观

在正常操作期间，LE微微网通道用于连接的LE设备之间的通信。

##### 3.3.2.1.2 特点

LE微微网通道的特征在于PHY信道的伪随机序列和由主机提供的三个附加参数。 第一个是指示在微微网中使用的PHY信道的集合的频道映射。 第二个是伪随机数，用作整个PHY信道的索引。 第三个是在连接请求之后由主机发送的第一个数据包的时序。

该信道被分为连接事件，其中每个连接事件对应于PHY跳频信道。 连续连接事件对应于不同的PHY跳频通道。 在连接建立之后由主机发送的第一个分组为所有未来连接事件的定时设置了一个锚点。 在连接事件中，主设备将分组发送到微微网中的从设备，并且从设备可以或可以不以其自己的分组进行响应。

在LE微微网通道上，主控制器控制对通道的访问。 主机在定期发生的连接事件中开始传输。 由主机发送的数据包与连接事件开始对齐，并定义微微网定时。 主机发送的数据包长度可能会从10个字节变化到265个字节。

每个主传输包含携带有关逻辑传输之一的信息的分组。 从设备可以在物理信道上进行响应。

LE微微网通道类似于BR / EDR适配的微微网通道，因为所使用的一组PHY信道可被修改以避免干扰。 在连接设置过程中，主设备建立了通道图中使用的通道组。 在连接时，主人可以在必要时更改频道图，以避免新的干扰。

有37个LE微微网通道。 主机可以通过指示所使用的通道的频道映射来减少此号码。 当跳频图案击中未使用的信道时，未使用的信道被替换为所使用的信道集合。 LE Piconet物理通道可以使用任何LE PHY。

##### 3.3.2.1.3 拓扑

任何数量的LE设备都可以共享LE微微网通道，仅限于微微网主设备上可用的资源。 只有一个设备是微微网主; 所有其他人都是微微网奴隶。 所有通信都在主设备和从设备之间。 在微微网通道上的从设备之间没有直接通信。

在微微网中可以支持的逻辑传输数量几乎没有限制。 这意味着与主机共享通道的蓝牙设备的数量没有理论上的限制。

允许LE设备一次属于一个或多个微微网，即，LE设备可以是零个或多个微微网中的从设备，并且还可以是另一微微网的主设备。

两个LE设备标识或不可解析的私有地址之间只能存在一个LE微微网通道。

##### 3.3.2.1.4 支持的层

LE微微网通道支持用于通用通信的L2CAP通道。

#### 3.3.2.2 广告渠道

##### 3.3.2.2.1 概观

LE广告通道用于在两个设备之间建立连接，或者在未连接的设备之间传送广播信息。

##### 3.3.2.2.2 特点

有两个LE广告渠道：主要广告渠道和次要广告渠道。

主要广告频道是在LE频谱上均匀分布的三组固定PHY信道的集合。 可以通过广告设备减少主广告PHY信道的数量，以减少干扰。 主要广告渠道可以使用LE 1M或LE编码PHY。

主要广告渠道分为广告事件，每个广告事件可以跳转到所有三个广告PHY频道。 连续广告事件从第一广告PHY通道开始。 广告事件以规则的间隔发生，随机延迟稍作修改以帮助避免干扰。

在主广告渠道上，广告设备控制对频道的访问。 广告设备在广告事件中开始传输，并且在三个广告PHY信道中的一个或多个上发送广告包。 每个广告分组以固定的间隔在不同的广告PHY信道上发送。 可以使用七种类型的广告事件，每种广告事件类型具有不同大小的广告包。 这些广告包的PDU有效载荷可以从6到37个字节的长度变化。

由广告设备发送的一些广告事件允许监听设备同时发送在其中接收到广告包的相同广告PHY信道上的扫描请求或连接请求包。 广告设备可以在相同的广告事件中的同一广告PHY信道上再次发送扫描响应分组。 扫描响应包的有效载荷可以从6到37个字节的长度变化。

辅助广告信道是分布在LE频谱上的37个固定PHY信道的集合。 这些是与数据通道相同的固定LE PHY通道。 辅助广告信道使用与数据信道相同的信道索引。 在辅助广告信道上使用的广告分组的有效载荷可以在0到255个字节之间变化。 次要广告频道上的广告信息包不属于广告事件，也是扩展广告事件的一部分。 这些扩展广告事件与主广告渠道上的广告事件同时开始，并在次要广告渠道上以最后一个分组结束。

辅助广告信道用于卸载否则将在主广告信道上传送的数据。 当广告商有足够的空中时间可用时，在辅助广告频道上的广告包（“辅助包”）由广告商安排。 主广告信道上的广告分组包含PHY信道和辅助分组开始时间的偏移量。

辅助广告信道可以使用任何LE PHY。 在同一扩展广告事件中的次广告信道上的所有广告分组使用在主广告信道上的广告分组中指定的相同的PHY。

##### 3.3.2.2.3 拓扑

LE广告频道可由任意数量的LE设备共享。 任何数量的LE设备可以在共享广告频道的同时传送广告包。 任何数量的扫描设备都可以在广告频道上收听。 广告设备可以同时在LE微微网通道上进行广告和连接。扫描设备也可以同时连接到一个或多个LE微微网通道。

#### 3.3.2.3 定期物理频道

##### 3.3.2.3.1 概观

LE周期性物理信道用于在未连接的设备之间建立周期性广播。

##### 3.3.2.3.2 特点

周期性物理信道的特征在于PHY信道的伪随机序列和由广告商提供的附加参数。 这些是指示在周期性广播中使用的PHY信道的集合的信道映射，用于确定信道跳频序列的事件计数器，指示第一周期性广播分组的定时的偏移量以及连续周期性广播之间的间隔。

信道被划分为周期性广告事件，其中周期性广告事件的开始对应于PHY跳频信道。 连续周期性广告事件的开始对应于不同的PHY跳频信道。 在建立广播之后由广告商发送的第一个分组为所有将来的定期广告事件的定时设置了一个定位点。

在定期物理频道上，广告设备控制对频道的访问。 广告商以定期发布的定期广告事件开始传输。 由广告商传送的数据包与周期性广告事件和指定的广播时序对齐。 由广告商发送的数据包的有效载荷可以从0个字节到255个八位字节的长度变化。

每个广告商传输包含携带关于PADVB逻辑传输的信息的分组。 扫描仪无法在物理通道上传输。

有37个PHY通道。 广告商可以通过指示所使用的频道的频道映射来减少此号码。 当跳频图案击中未使用的信道时，未使用的信道被替换为所使用的信道集合。 周期性物理信道可以使用任何PHY。 在描述周期性物理信道的特征的分组中，所有周期性广告事件使用广告商使用的相同PHY。

##### 3.3.2.3.3 拓扑

LE定时物理信道可由任意数量的LE设备共享。 任何数量的LE设备可以在共享相同的周期性物理PHY信道的同时传输周期性的广告分组。 任何数量的扫描设备都可以在周期性物理通道上监听。 广告设备可以在LE周期性物理信道上同时发布和同步。 扫描设备也可以同时同步到一个或多个LE周期性物理信道。

#### 3.3.3 AMP物理频道

##### 3.3.3.1 概观

在正常操作期间，AMP物理通道用于连接的设备之间的通信。 它与相关的BR / EDR控制器之间的适配微微网通道并行使用。

##### 3.3.3.2 特点

AMP物理信道特性取决于引用的MAC和PHY。 有关每个PAL的参考MAC和PHY，请参见第5卷 。

##### 3.3.3.3 拓扑

AMP物理信道可以由任何数量的蓝牙设备共享，仅受微微网BR / EDR主设备上可用的资源和可用的LT_ADDR的数量的限制。 AMP物理通道内的角色不被使用。 所有通信都在BR / EDR微微网主机和单个BR / EDR微微网从站之间。 BR / EDR微微网从器件在AMP物理通道之间没有直接的通信。

尽管可以共享AMP物理信道的蓝牙设备的数量没有理论上的限制，类似于基本和适应的微微网通道，但是与主设备交换数据时可以主动参与的这些设备的数量有限制。

##### 3.3.3.4 支持的层

AMP物理信道支持用于通用通信的多个物理链路，逻辑传输，逻辑链路和L2CAP信道。

## 3.4 物理链接

物理链路表示蓝牙设备之间的基带连接。 物理链路总是与一个物理信道相关联（尽管物理信道可以支持多于一个的物理链路）。 在蓝牙系统内，物理链路是虚拟概念，在传输的分组的结构内没有直接的表示。

在BR / EDR中，接入码分组字段与主蓝牙设备的时钟和地址一起用于识别物理信道。 在LE中，使用在信道选择算法＃1的情况下包括hopIncre的访问地址和信道映射，或者在信道选择算法＃2的情况下使用事件计数器来识别物理信道。 对于BR / EDR和LE，没有直接识别的数据包的后续部分物理链接。 相反，物理链路可以通过与逻辑传输相关联来识别，因为每个逻辑传输仅在一个物理链路上被接收。

一些物理链接类型具有可能被修改的属性。 一个例子是链路的发射功率。 其他物理链接类型没有可修改的属性。 在具有可修改属性的物理链接的情况下，LM协议（BR / EDR）用于调整这些属性。 由于在较高层（通过逻辑链路）支持LM协议（BR / EDR），所以通过传输LM信令的逻辑链路的含义来识别适当的物理链路。

在通过多个不同物理链路广播传输的情况下，传输参数被选择为适合于所有物理链路。

### 3.4.1 BR / EDR链接由基本和适应的微微网物理通道支持

基本的微微网物理通道支持只能激活的物理链路。 适应的微微网物理信道可以支持多个物理链路，包括主动和无连接从属广播。 主动物理链路是主机和从机之间的点对点链路。 无连接从属广播物理链路是主机和零个或多个从机之间的点对多点链路。 当微控制器中的从站同步时，微微网物理通道上至少有一个物理链路总是存在。

#### 3.4.1.1 活动物理链接

主设备和从设备之间的物理链路在设备之间存在默认的ACL逻辑传输时处于活动状态。 活动物理链路没有自己的直接识别，而是通过与默认的ACL逻辑传输ID相关联来识别，与之对应一一对应。

活动物理链路在每个方向具有无线电发射功率的相关属性。 来自从设备的传输总是被引导到主机的主动物理链路，并且使用作为该从站中该链路的属性的传输功率来主控方向。 来自主机的传输可以通过单个活动物理链路（到特定从设备）或多个物理链路（到微微网中的一组从属设备）来引导。 在点对点传输的情况下，主机对所讨论的物理链路使用适当的发射功率。 （在点对多点传输的情况下，主机使用适用于寻址的器件集合的发射功率。）

主动物理链路可能被置于保持或嗅探模式。 这些模式的作用是修改物理链路处于活动状态并可能携带流量的周期。 定义调度特性的逻辑传输不受这些模式的影响，并根据其预定义的调度继续进行行为。 缺省ACL逻辑传输和其他具有未定义调度特性的链路受到主动物理链路的模式的限制。

#### 3.4.1.2 本节不再使用

#### 3.4.1.3 无连接从属广播物理链路

无连接从站当从站在存在CSB逻辑传输的微微网中同步时，从站上存在广播物理链路。 在主机上，当CSB逻辑传输存在时，是否存在任何从机同步的情况下，存在无连接从属广播物理链路。 无连接从属广播物理链路是主机和零个或多个从机之间的点对多点单向链路。

无连接从站广播物理链路不支持电源控制，因为没有从从站到主站的反馈。 流量总是从单个主站引导到零个或多个从站。

无连接从播广播数据包定期发送。 BR / EDR控制器选择主机请求的范围内的间隔。

### 3.4.2 BR / EDR链接由扫描物理通道支持

在查询扫描和页面扫描通道的情况下，物理链路存在相对较短的时间，不能以任何方式进行控制或修改。 这些类型的物理链接没有进一步阐述。

### 3.4.3 LE链接由LE物理通道支持

LE微微网物理通道支持LE活动物理链路。 物理链路是主机和从机之间的点对点链路。 当从机与主机连接时，它始终存在。

LE广告物理频道支持LE广告物理链路。 物理链接是广告主设备和一个或多个扫描器或启动器设备之间的广播。 当广告客户广播广告事件时，它始终存在。

LE周期性物理信道支持LE周期性物理链路。 物理链接是广告主设备和一个或多个扫描仪设备之间的广播。 当广告客户正在广播定期广告事件时，它始终存在。

#### 3.4.3.1 活动物理链接

如果设备之间存在默认的LE ACL逻辑传输，则主设备与从设备之间的物理链路处于活动状态。 活动的物理链路各自与单独的微微网物理信道相关联，其又由在链路层分组中使用的随机生成的接入地址来标识。 每个访问地址与活动物理链路的主站和从站都具有一对一的关系。

#### 3.4.3.2 广告物理链接

用于形成连接（活动物理链路）的广告设备和发起设备之间的广告物理链路可以存在相对较短的时间段。 这些广告物理链路不能以任何方式进行控制或修改，这些类型的物理链路不再进一步阐述。

用于定期广播用户数据的广告设备和扫描设备之间的广告物理链路可以存在较长时间段。 没有关于协议内的物理链路的标识信息。 应通过使用蓝牙设备地址建立广告和扫描设备之间的关系。

#### 3.4.3.3 定期物理链接

广告设备与一个或多个扫描设备之间的周期性物理链路通常存在较长的时间段。 周期性物理链路各自与单独的周期性物理信道相关联，周期性物理信道又由链路层分组中使用的随机生成的接入地址来标识。 每个访问地址与定期物理链接的广告商具有一对一的关系。

### 3.4.4 AMP物理通道支持的链接

AMP物理链路总是与一个AMP物理通道相关联（尽管AMP物理通道可能支持多个AMP物理链路）。 AMP物理链路是两个PAL之间的点对点链路。 AMP物理链路的特性取决于基础的AMP技术。

## 3.5 逻辑链接和逻辑运输

各种逻辑链路可用于支持不同的应用数据传输要求。 每个逻辑链路与具有多个特征的逻辑传输相关联。 这些特征包括流量控制，确认/重复机制，序列编号和调度行为。 逻辑传输能够携带不同类型的逻辑链路（取决于逻辑传输的类型）。 如果是这些蓝牙逻辑链路中的一些被复用到相同的逻辑传输上。 逻辑传输可以由基本或适配的微微网物理信道上的活动物理链路携带。

逻辑传输标识和实时（链路控制）信令在分组报头中承载，并且对于一些逻辑链路，在有效负载报头中承载识别。 使用LMP协议来执行不需要单个时隙响应时间的控制信令。

表3.4 列出了所有逻辑传输类型，支持的逻辑链路类型，物理链路和物理信道类型可以支持的类型，以及逻辑传输目的的简要说明。


![表3.4：逻辑传输类型](http://upload-images.jianshu.io/upload_images/3764796-f502f2c375cc6828.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![表3.4：逻辑传输类型](http://upload-images.jianshu.io/upload_images/3764796-13db2e14f5d639ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

每个链接类型的分类遵循三个类别中的选择过程。

### 3.5.1 铸件

第一类是铸造类。 这可以是单播还是广播。

单播链接。 完全两个端点之间存在单播链路。 可以在单播链路上以任一方向发送流量。

广播链接。 一个源设备和零个或多个接收机设备之间存在广播链路。 流量是单向的，即仅从源设备发送到接收器设备。 广播链路是无连接的，意味着没有创建这些链接的过程，并且可以随时通过它们发送数据。广播链路不可靠，不能保证收到数据。

### 3.5.2 调度和确认方案

第二类涉及链路的调度和确认方案，并且意味着链路支持的流量类型。 这些是同步的，等时的或异步的。 没有定义特定的等时链路，尽管默认ACL链路可以配置为以这种方式运行。

同步链接 同步链路提供了将传输的数据与蓝牙微微网时钟相关联的方法。 这通过在物理信道上保留常规时隙并以这些规则的间隔传输固定大小的分组来实现。 这种链路适用于恒定速率同步数据。

异步链接 异步链接提供了一种传输没有时间特征的数据的方法。 通常预期数据将被重新发送直到成功接收，并且每个数据实体可以在接收之后的任何时间被处理，而不参考在流中接收到任何先前或连续实体的时间（提供数据实体的排序被保留）。

同步链接。 等时链路提供了一种传输具有时基特征的数据的方法。 数据可以重发直到接收或过期。 链路上的数据速率不必是恒定的（这是同步链路的主要区别）。

### 3.5.3 数据类

最后的类别与链接所携带的数据类有关。 这是控制（LMP或PAL）数据或用户数据。 用户数据类别被划分为L2CAP（或成帧）数据和流（或非成帧）数据。

控制链接。 控制链路仅用于在两个链路管理器之间传输LMP消息。 这些链接在基带层之上是不可见的，不能被应用程序直接实例化，配置或发布，而不是通过使用具有这种效果的连接和断开连接服务。 控制链路总是与等效的L2CAP链路复用到ACL或ASB逻辑传输。 根据定义ARQ方案的规则，控制链路流量总是优先于L2CAP链路流量。

L2CAP链接。 L2CAP链路用于传输L2CAP PDU，其可以携带L2CAP信令信道（仅在默认ACL-U逻辑链路上）或提交给用户实例化的L2CAP信道的成帧用户数据。 提交给基带的L2CAP帧可能大于可用的基带分组。 嵌入在LLID字段内的链路控制协议在将帧以多个片段发送到接收机时保留帧起始和帧连续语义。

流链接。 流链接用于传输在传送数据时不应保留的固有框架的用户数据。 丢失的数据可能被接收器的填充替换。

### 3.5.4 逻辑运输

#### 3.5.4.1 BR / EDR异步连接（ACL）

异步面向连接（ACL）逻辑传输用于携带LMP和L2CAP控制信令以及尽力而为的异步用户数据。 ACL逻辑传输使用1位ARQN / SEQN方案来提供简单的信道可靠性。 微微网内的每个活动从属设备都有一个ACL逻辑传输到微微网主机，称为默认ACL。

当设备连接微微网（连接到基本的微微网物理通道）时，默认ACL在主站和从站之间创建。 该默认ACL由微微网主设备分配逻辑传输地址（LT_ADDR）。 此LT_ADDR还用于在需要时识别活动的物理链路（或作为微妙的活动成员标识符，有效地用于相同目的）。

用于默认ACL的LT_ADDR被重用于同一主机和从机之间的同步面向连接的逻辑传输。 （这是为了兼容早期的蓝牙规范）。 因此，LT_ADDR本身不足以识别默认ACL。 但是，ACL上使用的数据包类型与同步面向连接的逻辑传输中使用的数据包类型不同。 因此，ACL逻辑传输可以由分组头中的LT_ADDR字段与分组类型字段组合来标识。

默认ACL可以用于等时数据传输，配置为在数据包过期后自动刷新数据包。 通过将异步数据包标记为不可自动刷新，可以通过为等时流量配置的ACL逻辑传输发送异步流量。 这允许同步和异步业务同时传输到单个设备。

如果默认ACL从活动物理链路中删除，那么主服务器和从服务器之间存在的所有其他逻辑传输也将被删除。 在与微微网物理信道的意外丢失同步的情况下，物理链路和所有逻辑传输和逻辑链路在检测到该同步丢失时停止存在。

#### 3.5.4.2 BR / EDR同步连接（SCO）

同步面向连接（SCO）逻辑传输是主机和特定从机之间的对称的点到点传输。 SCO逻辑传输在物理通道上保留插槽，因此可以被认为是主机和从机之间的电路交换连接。 SCO逻辑传输携带与微微网时钟同步的64kb / s信息。 通常，该信息是编码语音流。 存在三种不同的SCO配置，提供鲁棒性，延迟和带宽消耗之间的平衡。

每个SCO-S逻辑链路由单个SCO逻辑传输支持，该SCO逻辑链路被分配与设备之间的默认ACL逻辑传输相同的LT_ADDR。 因此，LT_ADDR字段不足以识别接收到的数据包的目的地。 因为SCO链路使用保留时隙，所以设备使用LT_ADDR，时隙号（物理信道的属性）和分组类型的组合来识别SCO链路上的传输。

虽然为SCO保留了时隙，但允许使用保留时隙用于具有较高优先级的另一个信道的流量。 作为QoS承诺的结果可能需要，或者当物理信道带宽被SCO完全占用时，在默认ACL上发送LMP信令。由于SCO将不同的数据包类型携带到ACL，因此数据包类型用于标识SCO流量（除了插槽号和LT_ADDR）。

没有由蓝牙核心规范定义的通过SCO链路传输的进一步架构层。 为传输的64kb / s流定义了许多标准格式，或者允许应用程序负责解释流的编码的非格式化流。

#### 3.5.4.3 BR / EDR扩展同步连接（eSCO）

扩展的同步面向连接（eSCO）逻辑传输是主机和特定从机之间的对称或非对称的点对点传输。 eSCO在物理通道上保留插槽，因此可以被认为是主机与从机之间的电路交换连接。 eSCO链路在标准SCO链路上提供了许多扩展，因为它们支持分组类型和数据包中可选数据内容更灵活的组合以及可选的时隙周期，从而支持一系列同步比特率。

eSCO链路还可以提供有限的数据包重传（不同于没有重传的SCO链路）。 如果需要这些重传，则它们发生在保留时隙之后的时隙中，否则这些时隙可用于其他流量。

每个eSCO-S逻辑链路都由一个eSCO逻辑传输提供支持，该逻辑传输由在eSCO期间在微微网内独特的LT_ADDR标识。 eSCO-S链路使用LM信令创建，并遵循类似于SCO-S链路的调度规则。

没有由通过eSCO-S链路传输的蓝牙核心规范定义的其他架构层。 相反，应用程序可以将数据流用于他们所需要的任何目的，因为流的传输特性适合于要传输的数据。

#### 3.5.4.4 BR / EDR主动从站广播（ASB）

主动从广播逻辑传输用于将LMP控制信令和无连接L2CAP用户流量传输到当前连接到ASB使用的物理信道的微微网中的所有设备。 没有确认协议，并且流量从微微网主机到从站是单向的。 ASB信道可用于L2CAP组业务（1.1规范的遗留），并且不会用于L2CAP面向连接的信道或L2CAP控制信令。

由于缺乏确认，ASB逻辑传输本质上是不可靠的。 为了提高可靠性，每个数据包被传送多次。 使用相同的序列号来帮助在从设备处过滤重传。

ASB逻辑传输由保留的LT_ADDR标识。

每当微微网存在时，ASB被隐含地创建，并且总是存在与存在于微微网内的每个活动物理链路（无论是在基本的或适应的微微网物理信道上操作）相关联的一个ASB。 因为基本和适应的微微网物理信道以及适配的微微网物理信道上的不同信道映射大多一致，所以从设备不能区分正在使用哪个ASB信道来传送分组。 这增加了ASB频道的一般不可靠性。 （尽管它可能比一般错过的数据包更不可靠。）

主设备可以决定仅使用其两个可能的ASB中的一个（当它具有基本和适应的微微网物理信道时），或者仅在适配的微微网物理信道上使用的一个信道图（当它具有多于一个映射），因为足够的重传或仔细选择要在其上传输哪些时隙可以解决所有从机。

ASB信道从不用于携带L2CAP控制信号。

#### 3.5.4.5 本节不再使用

#### 3.5.4.6 LE异步连接（LE ACL）

LE异步连接（LE ACL）逻辑传输用于携带LL和L2CAP控制信令以及尽力而为的异步用户数据。 LE ACL逻辑传输使用1位NESN / SN方案来提供简单的信道可靠性。 LE微微网内的每个活动从属设备都有一个LE ACL逻辑传输到微微网主机，称为默认的LE ACL。

当设备连接微微网（连接到LE微微网物理通道）时，主站和从站之间自动创建默认的LE ACL。 此默认LE ACL由微微网主设备分配一个访问地址。

该访问地址还用于在需要时识别活动物理链路和活动微微网物理信道。

如果从LE活动物理链路中删除默认的LE ACL，那么主机和从机之间存在的所有其他LE逻辑传输也将被删除。 在与LE微微网物理信道的意外丢失同步的情况下，LE物理链路和所有LE逻辑传输和LE逻辑链路在检测到该同步丢失时停止存在。

#### 3.5.4.7 LE广告广告（ADVB）

LE广告广播逻辑传输用于将广播控制和用户数据传送到给定区域中的所有扫描设备。 没有确认协议，并且流量主要是从广告设备单向的。 扫描设备可以通过逻辑传输发送请求以获得附加的广播用户数据，或者形成LE ACL逻辑传输连接。 LE广告广播逻辑传输数据仅在LE广告广播链路上传送。

由于缺乏确认，ADVB逻辑传输本质上是不可靠的。 为了提高可靠性，每个分组在LE广播广播链路上传送多次。

每当广告设备开始广告时都会创建一个ADVB。 广告商的蓝牙设备地址和广告集识别ADVB逻辑传输。

#### 3.5.4.8 无连接从播广播（CSB）

CSB逻辑传输用于将配置文件广播数据传输到连接到无连接从广播逻辑传输的所有设备。 没有确认方案，并且流量从主机单向到零个或多个从站。 为了提高可靠性，可以多次发送简档广播数据。

无连接从动广播开始时，CSB逻辑传输是在发射机上创建的。 无连接从播广播接收被配置时，在接收机上创建CSB逻辑传输。 CSB逻辑传输由微网内唯一的LT_ADDR标识，该无线从广播发射机专门为此目的而保留。

#### 3.5.4.9 LE定期广告广播（PADVB）

LE定期广告广播逻辑传输用于将周期性广播控制和用户数据传送到给定区域内的所有扫描设备。 数据可能会持续几个周期，也可能会频繁变化。 没有确认协议，流量是单向的广告设备 LE周期性广播广播逻辑传输数据仅在LE周期物理链路上传送。

由于缺乏确认，PADVB逻辑传输本质上是不可靠的。 为了提高可靠性，传输之间的周期可以比数据变化之间的间隔短，使得每个分组可以在LE周期性物理链路上传输多次。

每当广告设备开始定期广告时，都会创建PADVB。 PADVB逻辑传输由广告商的蓝牙设备地址，时间和广告集确定。

### 3.5.5 逻辑链接

一些逻辑传输能够支持不同的逻辑链路，并发多路复用或选择之一。

#### 3.5.5.1 BR / EDR逻辑链接

在BR / EDR逻辑传输中，逻辑链路由承载数据有效载荷的基带分组的有效负载报头中的逻辑链路标识符（LLID）位来标识。 逻辑链路区分能够在逻辑传输上发送和接收数据的有限的一组核心协议。 并非所有的逻辑传输都能够承载所有的逻辑链路（支持的映射如图3.2所示）。 特别是BR / EDR SCO和eSCO逻辑传输只能承载恒定的数据速率流，而这些数据流由LT_ADDR唯一标识。 这样的逻辑传输仅使用不包含有效负载报头的分组，因为它们的长度被预先知道，并且不需要LLID。

##### 3.5.5.1.1 ACL控制逻辑链路（ACL-C和ASB-C）

ACL控制逻辑链路（ACL-C和ASB-C）用于在微微网中的设备之间携带BR / EDR LMP信令。 ACL-C控制链路只能在默认的ACL逻辑传输中进行，而ASB-C控制链路仅在ASB逻辑传输上承载。 每个控制链路总是优先于相同逻辑传输上承载的相应数据链路。

##### 3.5.5.1.2 用户异步/同步逻辑链路（ACL-U和ASB-U）

用户异步/等时逻辑链路（ACL-U和ASB-U）用于携带所有异步和等时成帧的用户数据。 ACL-U链路仅在默认的ACL逻辑传输上进行，而ASB-U链路只能在ASB逻辑传输上承载。 ACL-U和ASB-U链路上的报文由两个保留的LLID值中的一个标识。 一个值用于指示基带分组是否包含L2CAP帧的开始，另一个指示前一帧的延续。 这样可以确保L2CAP重组器在闪存数据包之后的正确同步。 使用的这种技术消除了对每个基带分组中更复杂的L2CAP报头的需要（报头仅需要在L2CAP启动分组中），但是增加了在传输新的L2CAP帧之前将传输完整的L2CAP帧的要求。 （这个规则的一个例外是冲洗部分传输的L2CAP帧有利于另一个L2CAP帧的能力。）

##### 3.5.5.1.3 用户同步/扩展同步逻辑链路 （SCO-S /的eSCO-S）

同步（SCO-S）和扩展同步（eSCO-S）逻辑链路用于支持在流中传送的同步数据，而不需要帧。 这些链接与单个逻辑传输相关联，其中以恒定速率以恒定大小的单位递送数据。 这些传输中的数据包中没有LLID，因为只能支持单个逻辑链路，并且分组长度和调度周期是预定义的，并且在链路的生存期内保持固定。

可变速率同步数据不能由SCO-S或eSCO-S逻辑链路承载。 在这种情况下，必须在ACL-U或ASB-U逻辑链路上携带数据，这些链路使用带有有效载荷头的数据包。

##### 3.5.5.1.4 配置文件广播数据（PBD）逻辑链路

PBD逻辑链路用于将等时无帧数据广播到多个接收器并驻留在CSB逻辑传输上。

#### 3.5.5.2 LE逻辑链接

在LE逻辑传输中，逻辑链路由承载数据有效载荷的基带分组的有效负载报头中的逻辑链路标识符（LLID）位来标识。 逻辑链路区分能够在逻辑传输上发送和接收数据的有限的一组核心协议。 并非所有的逻辑传输都能够承载所有的逻辑链路（支持的映射如图3.2所示）。

##### 3.5.5.2.1 控制逻辑链路（LE-C）

LE ACL控制逻辑链路（LE-C）用于在微微网中的设备之间传送LE LL信令。 控制链路只能在默认的LE ACL逻辑传输中进行。

##### 3.5.5.2.2 用户异步逻辑链路（LE-U）

用户异步逻辑链路（LE-U）用于携带所有异步和成帧的用户数据。 LE-U链路在LE逻辑传输上进行。 LE-U链路上的数据包由两个保留的LLID值之一标识。 一个值用于指示基带分组是否包含L2CAP帧的开始，另一个指示前一帧的延续或空PDU。 这样可以确保L2CAP重组器的正确同步。 这种技术的使用消除了对每个基带分组中更复杂的L2CAP报头的需要，但是增加了在传输新的L2CAP帧之前将传输完整的L2CAP帧的要求。

##### 3.5.5.2.3 广告广播控制逻辑链路（ADVB-C）

LE广播广播控制逻辑链路（ADVB-C）用于在给定区域内的未连接设备之间携带LE LL信令。 该信令是用于收集附加广播用户数据（扫描请求）或连接请求的控制命令。 控制链路在LE广播广播和LE定期广播广播逻辑传输中进行。

##### 3.5.5.2.4 广告广播用户数据逻辑链路（ADVB-U）

LE广告广播用户数据逻辑链路（ADVB-U）用于携带在设备之间使用的LE广播广播和LE周期性广播广播用户数据，而不需要设备之间的连接或LE-U。 用户数据链路在LE广播广播用户数据的LE广播广播逻辑传输和LE周期性广播广播用户数据的LE周期性广播广播逻辑传输中承载。

#### 3.5.5.3 AMP逻辑链接

##### 3.5.5.3.1 AMP控制逻辑链路（AMP-C）

每个PAL对于控制逻辑链路的功能不同。 当存在这个逻辑链路时，这个逻辑链路被称为AMP-C逻辑链路。

##### 3.5.5.3.2 AMP用户异步/同步逻辑链路（AMP-U）

AMP用户异步/等时逻辑链路（AMP-U）用于在AMP上携带所有异步和等时成帧的用户数据。 与ACL-U逻辑链路不同，AMP-U每个物理链路支持多个逻辑链路句柄，每个逻辑链路句柄可能具有不同的服务质量。 通过PAL描述AMP-U逻辑链路如何映射到底层MAC / PHY的细节。

## 3.6 L2CAP通道

L2CAP提供复用角色，允许许多不同的应用程序共享ACL-U或AMP-U逻辑链路。 应用和服务协议使用面向通道的接口与L2CAP进行接口，以创建与其他设备上的等效实体的连接。

通过信道标识符（CID）将L2CAP信道端点标识给它们的客户机。 这由L2CAP分配，任何设备上的每个L2CAP通道端点具有不同的CID。

L2CAP信道可以被配置为向应用提供适当的服务质量（QoS）。 L2CAP将通道映射到ACL-U逻辑链路LE-U或AMP-U逻辑链路之一。

L2CAP支持面向连接的通道和面向组的其他通道。 面向组的信道可以映射到ASB-U逻辑链路上，或者依次通过ACL-U逻辑链路实现为每个成员的迭代传输。

除了创建，配置和拆除通道外，L2CAP的主要作用是将通道客户端的业务数据单元（SDU）复用到ACL-U，LE-U或AMP-U逻辑链路上，并执行一个简单的调度级别，根据相对优先级选择SDU。

L2CAP可以与对等L2CAP层提供每通道流量控制。 当该通道建立时，该选项由应用程序选择。 L2CAP还可以提供增强的错误检测和重传，以（a）减少未检测到的错误被传递到应用程序的概率;（b）当基带层对ACL-U逻辑进行刷新时，从用户数据的部分丢失中恢复链接。

在存在HCI的情况下，还需要L2CAP将L2CAP SDU分段成适合于基带缓冲器的片段，并且还可以通过HCI操作基于令牌的流控制过程，仅在允许时将片段提交给基带这样做 这可能会影响调度算法。




