# 蓝牙5规范第1卷A部分第7章共存和共位置

标签（空格分隔）： Bluetooth

---

# 7 共存和共位置

蓝牙设备在未经许可的2.4 GHz工业，科学和医疗（ISM）频段中工作。 许多其他技术利用ISM频段，包括无线局域网，无绳电话和微波炉。 ISM频段也足够接近其他频段，蓝牙设备可能是其他技术的干扰源或受害者。

无线电可能并*置* *或非并置* 。 术语“并置”是松散的 - 在核心规范中，假定配置的无线电设备处于同一产品（ *多无线电终端*或*MRT* ）中，并且可能有也可能没有协调其活动以减轻干扰的机制。

确定无线电之间的预期隔离量对于选择适当的共存机制很重要。 通过充分的隔离，频分双工（FDD）技术是最有效的。 在隔离不足或共享天线的情况下，需要使用时分双工（TDD）技术。 在许多情况下，需要FDD和TDD技术的组合才能达到可接受的性能水平。

蓝牙核心规范支持各种功能，有助于减轻对其他设备的干扰，并减少其他设备的干扰。 广义上，解决方案的类型分为以下几类：

| 类型 | 描述 |
|--------|-------|
| 分频 | 同时使用通过过滤器和/或隔离启用的多个无线电|
|时间划分|一个无线电可以通过调度或优先进行一次发送或接收|
|时间对齐|并置无线电的活动在时域上对齐，通过避免冲突的活动来优化性能。 例如，多个无线电的传输可能同时发生，多个接收可能同时发生，但不可能同时发送和接收|
|混合频率和时分|使用分频，时间对准和时分技术，具体取决于无线电，滤波器和隔离器使用的相对频率|

表7.1：干扰减轻类型

## 7.1 核心功能支持共存和集合

蓝牙核心规范中有一些功能，专门用于降低并置或非并置设备的干扰。

| 特征 | 版本介绍 | 描述 |
|-------|--------------|--------|
| 自适应跳频 | 1.2 | 允许设备减少微微网中使用的通道数量，以避免干扰 |
| HCI设置主机频道分类 | 1.2 | 允许主机通知本地蓝牙控制器通过胶卷技术占用的通道 |
| 增强SCO（eSCO）| 1.2 | 为了防止干扰，向SCO增加了重传 |
| MWS共存信令 | CSA3| 提供胶卷收音机之间的标准接口，用于传达必要的信息，以实现一些共存技术 |
| 微微网时钟调整 | 4.1 | 允许蓝牙设备将微微网时钟与外部技术对齐，例如长期演进（LTE） |
| 火车推动 | 4.1 | 提供一种机制来提高页面和查询的成功率，当接收相应的响应的时隙不可用时 |
| 广义隔行扫描 | 4.1 | 提供一种机制，以便在某些时隙不可用于扫描时提高页面扫描和查询扫描的成功率 |
| 插槽可用性面具 | 5 | 为两个蓝牙设备提供一种机制，以指示其时隙的可用性 |

表7.2：干扰减轻功能

## 7.2 自适应频率控制

自适应跳频（AFH）允许蓝牙设备提高其对干扰的抗扰性，并避免对2.4 GHz ISM频段内的其他设备造成干扰。 基本原理是将蓝牙通道分为*使用*和*未使用的*两个类别，其中使用的信道是跳频序列的一部分，未使用的信道在跳频序列中以伪随机方式被所使用的信道替换。 该分类机制允许蓝牙设备使用核心规范v1.1中所需的全部或更少的79个通道。 蓝牙规范允许的最小通道数为20。

核心规范定义了确保互操作性所需的AFH方面，包括跳频内核，基带行为，链路管理器协议（LMP）命令和主机控制器接口（HCI）命令以及更改和配置跳变序列所需的事件。 蓝牙规范还定义了允许从站将信道分类信息报告给主站的机制。

自适应跳频利用了许多来源获得的指标。 分析这些指标，然后由自适应跳频内核使用最终的Channel_Map。 度量值可能来自空中测量，主机提供的数据（通过HCI_set_AFH_Channel_Classification命令），或从站或其他硬件共存接口的报告。

虽然AFH是共存的关键因素，但在某些情况下是不够的。

## 7.3 蓝牙设备和无线LAN设备之间的共同点

蓝牙和无线LAN之间的共存传统上是自适应跳频（AFH）和专有技术的组合，以优先考虑两种协议之间的流量。 蓝牙核心规范没有指定蓝牙控制器和无线局域网设备之间的信令。

## 7.4 移动无线标准（MWS）共同体

可以在蓝牙无线电与在2.4GHz ISM频带附近的频带内工作的配置的MWS无线电台之间存在显着的干扰。 这种干扰可以防止一个无线电接收，而另一个无线电发射。

“与LTE和WiMAX共存的过滤器建议”白皮书1 描述了在某些情况下可以将并置干扰降低到可接受水平的滤波器规格。 蓝牙核心
规格包括传统滤波的补充解决方案，包括蓝牙控制器和主机的功能以及并置的MWS和蓝牙无线电之间的信令和消息传递机制。 图7.1说明了这些机制的一般架构模型。 这种架构假定隔离有限的单独天线。


![图7.1：MWS共存架构](http://upload-images.jianshu.io/upload_images/3764796-94ce0ccb15253744.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

已经考虑了两种类型的解决方案。 在第一个解决方案中，蓝牙传输（TX）和接收（RX）都受到并置的MWS活动的约束。 这种类型的解决方案称为*Pure TDM（时分复用）模式* 。 在第二个解决方案中，只有蓝牙接收受并置的MWS传输的影响，蓝牙传输不会影响并置的MWS的运行。 这种类型的解决方案称为*混合模式* ，例如通过使用蓝牙收发器中的ISM频带的陡峭滚降带宽滤波器（BSF）来实现。 混合模式适用于蓝牙传输对MWS的影响通过蓝牙设备在MWS下行链路时间内可以安全传输的过滤得到充分降低。 这需要蓝牙和MWS操作频率范围之间的频率保护频带以及蓝牙BSF和MWS BSF两者的约束。 对时域解决方案的要求仍然存在，但仅用于保护蓝牙接收。

这些解决方案由MWS共存信令机制（参见[第7部分]部分A ）和多个传输层（参见[Vol 7] B部分和C 部分 ）促成。

MWS技术在许可频段中运行，并使用集中式调度来支持广域网服务。 MWS无线电同步网络基站的时间和频率。 基站确定哪些MWS无线电将发送或接收以及何时。 MWS无线电无法控制何时发送或接收。 当蓝牙传输干扰MRT中的MWS接收时，如果蓝牙无线电自由发射，则MWS无线电可以变得不可用。 图7.2显示了蓝牙活动如何干扰每个MWS接收机会以及MWS传输如何干扰蓝牙接收。 在图7.2所示的示例中，MRT中的蓝牙设备作为微微网的主机运行。 标记有“M”的块是单时隙主站传输，标有“S”的块是单时隙从站传输。 由MWS设备接收的时间可能被蓝牙传输损坏的时间标记为红色。

![图7.2：MWS接收受到不受控制的蓝牙传输的干扰](http://upload-images.jianshu.io/upload_images/3764796-e32ba5cc9d3b7bca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

即使具有最佳的相对定时关系（当蓝牙插槽边界与MWS帧边界对齐时），MRT中的蓝牙无线电由于与并置的MWS无线电的时间复用而遭受降低的发送和接收机会。 蓝牙无线电只能在MWS帧中获得一个发送/接收机会， 如图7.3所示。

![图7.3：蓝牙无线电已经减少了发送/接收的机会](http://upload-images.jianshu.io/upload_images/3764796-8321a02c0585fe01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

因此，MWS活动可以刺穿四分之一（5毫秒MWS帧）或八分之七（10毫秒MWS帧）蓝牙插槽对。 此外，由于蓝牙询问和寻呼一次使用16个信道的序列，当MRT中的蓝牙无线电正在执行查询或寻呼时，信道序列将每5ms重复一次，导致相同的信道被并置的MWS活动重复地穿刺， 见图7.4 。 结果，远程扫描设备在当前超时期间将无法接收页面或查询ID的可能性很大。

当查询或寻呼信道序列被重复穿孔时，可以使用“火车微移”来向时钟比特添加额外的偏移量以便改变信道序列。

![图7.4：蓝牙无线电可能会遇到查询/页面失败](http://upload-images.jianshu.io/upload_images/3764796-bdb27919ddc7fa98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

由于MWS传输干扰了MRT中的蓝牙接收，所以执行扫描的MRT中蓝牙无线电将不会收到来自远程查询/页面设备的多达50％的发送ID， 如图7.5所示。

基于不可用于扫描的插槽的图案，可以使用通用隔行扫描来在背对背扫描期间调整第二次扫描的相位。

![图7.5：蓝牙无线电可能会遇到查询扫描/页面扫描失败](http://upload-images.jianshu.io/upload_images/3764796-6466df2c07912b8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 7.5 与外部时序源同步蓝牙

本节提供了一个例子来说明蓝牙CLK与MWS系统的同步，以便蓝牙插槽与MWS系统的下行链路和上行链路时间相匹配。 该示例中的外部帧是LTE TDD帧配置＃1和特殊子帧配置＃1; 然而，相同的机制可以用于任何外部TDD / TDMA协议。 该示例显示10 ms的时间间隔。

[第7卷]部分A 将MWS帧的定时定义为来自共存信令中的FRAME_SYNC信号的固定偏移。 这在图7.6 中显示 为FS。 FS可以由主机定义为MWS内的任何特定偏移量帧。 对于微微网主机，FS最有用的位置是上行链路和下一个下行链路之间的边界。 这是因为主机需要在上行链路期间在主机时隙中传输，然后在下行链路期间在随后的从时隙中接收。 将FS置于此边界允许主机轻松对齐其蓝牙时钟，将其放在这些插槽之间。 在从机中情况相反：FS在下行链路和下一个上行链路之间的边界上最有用。

HCI命令Set_External_Frame_Configuration（ [Vol 2] E部分，第7.3.81节 ）用于描述MWS帧定时。 这种知识与FS一起允许蓝牙控制器将蓝牙时钟与MWS帧定时对准，以便最小化相互干扰的影响。 如图7.6所示 。 红色椭圆显示插槽对，MWS和蓝牙同时发送和接收，因此不会互相干扰。 MWS帧结构包括下行链路部分（“D”），上行链路部分（“U”）以及包括由保护周期（“GP”）隔开的下行链路和上行链路部分的特殊部分（“S”）。

![图7.6：MWS帧定时和蓝牙时钟的对齐](http://upload-images.jianshu.io/upload_images/3764796-054d27c5737223a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

注意：在LTE中，如果实现不能访问确切的LTE定时，则可以假设下行链路到上行链路边界是特定LTE子帧中的GP的中间。

## 7.6 PICONET CLOCK ADJUSTMENT

如上一节所述，正确对准MWS和蓝牙时钟大大提高了两种技术的吞吐量。 主人有两个机制可以用来减轻失调。

粗调时钟调整可用于使用LMP_clk_adj PDU移动蓝牙CLK。 clk_adj_us参数用于将插槽与由FRAME_SYNC信号指示的MWS对准点对齐。 clk_adj_slots参数可用于在时间上向前移动CLK多个插槽。这可以用于对齐eSCO。 预计粗调时钟调整很少使用，例如在MWS连接或MWS帧定时由于漫游而改变时。 粗调时钟调整只能在微微网中的所有从站支持时使用。

主机的另一个选项是使用时钟拖动。 这是通过进行向后或向后缓慢调整时钟的相位的方法时隙分别更短或更长，直到达到期望的CLK相位为止。 应该注意的是，这是一个非常慢的调整速率，因为它被设计为允许传统设备跟踪变化，因此时钟拖动不能以比设备之间的最大自然漂移更快的速度进行。 因此，如果检测到与MWS系统的不对准，其主要用途是随着时间推移进行小的校正。 如果连接了不支持粗调时钟调整的任何设备，则使用时钟拖动缓慢移动从站是唯一的选项。

建议尽可能让并置设备成为主设备，因为它可以更快地做出反应，以纠正错位。 如果一个从属设备是并置设备，那么做一个角色切换使其成为主控可能值得考虑。 或者，从机可以向主机发送Piconet时钟调整请求LMP分组。 然后，主机可以选择执行粗调时钟调整，时钟拖动或拒绝请求。

## 7.7 SLOT AVAILABILITY MASK (SAM) 

插槽可用性掩码（SAM）允许两个蓝牙设备彼此指示可用于发送和接收的时隙。 SAM插槽图指定蓝牙插槽的可用性或其他方式。 由于外部条件（例如，MWS共存）或内部条件（例如，分布式网络承诺），时隙可能无法使用。 SAM不会为BR / EDR时隙的调度强加新的强制性规则。 相反，它只提供允许控制器改进其蓝牙插槽调度以提高性能的信息。

控制器本身根据其调度要求计算SAM槽位图。 没有专门为SAM定义的HCI命令，只有LMP序列才能使设备交换地图并指示使用中的地图。 HCI命令“Set_External_Frame_Configuration”（参见[Vol 2] E部分，第7.3.81节 ）和“Set_MWS_PATTERN_Configuration”（参见[Vol 2] E部分，7.3.85 ）和实时信号（例如，MWS_PATTERN_Index或FRAME_SYNC）由共存逻辑接口提供（参见[Vol 7] Part A ）包含有关用于MWS共存的适当SAM_Index和SAM锚点的信息; 因此这些可能触发这些LMP序列。

在启动LMP_SAM_switch序列之前，控制器可以选择执行微微网时钟调整，以便增加每MWS帧可用的槽对数。




